<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <link rel="icon" type="image/png" href="/icons/192.png">
  <!-- Barcode Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }


    #main-app-content {
      font-family: 'Inter', sans-serif;
      transition: opacity 1s ease-in;
    }

    #splash-screen {
      font-family: 'Inter', sans-serif;
    }

    #header-greeting {
      white-space: nowrap;
    }

    .header-greeting-wrapper {
      transition: transform 0.2s ease;
    }

    .header-heart-icon {
      flex-shrink: 0;
      transition: transform 0.2s ease, width 0.2s ease, height 0.2s ease;
    }

    @media (max-width: 640px) {
      .header-greeting-wrapper {
        transform: translateX(-10px);
      }

      .header-heart-icon {
        width: 1.25rem;
        height: 1.25rem;
        transform: translateX(-5px);
      }
    }

    @media (min-width: 640px) {
      .header-heart-icon {
        width: 2.5rem;
        height: 2.5rem;
      }
    }

    .filter-btn.active,
    .meal-type-btn.active {
      background-color: #374151;
      color: white;
      border-color: #374151;
    }

    .favourite-star {
      cursor: pointer;
      transition: color 0.2s;
    }

    .favourite-star.favourited {
      color: #facc15;
    }

    .favourite-star:not(.favourited) svg {
      fill: none;
    }

    .favourite-star.favourited svg {
      fill: currentColor;
    }

    @keyframes pop {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.4);
      }

      100% {
        transform: scale(1);
      }
    }

    .star-pop {
      animation: pop 0.3s ease-in-out;
    }

    .favourite-star-container {
      position: relative;
    }

    .favourite-star-container.sparkling::after {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border-radius: 50%;
      border: 2px solid #facc15;
      transform: scale(0);
      opacity: 0;
      animation: sparkle-ring 0.5s ease-out;
    }

    @keyframes sparkle-ring {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }

      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .loader {
      width: 80px;
      aspect-ratio: 1;
      color: #E8204E;
      background:
        radial-gradient(circle at 60% 65%, currentColor 62%, #0000 65%) top left,
        radial-gradient(circle at 40% 65%, currentColor 62%, #0000 65%) top right,
        linear-gradient(to bottom left, currentColor 42%, #0000 43%) bottom left,
        linear-gradient(to bottom right, currentColor 42%, #0000 43%) bottom right;
      background-size: 50% 50%;
      background-repeat: no-repeat;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
    }

    .loader:after {
      content: "";
      position: absolute;
      inset: 0;
      background: inherit;
      opacity: 0.4;
      animation: l3 1.5s infinite;
    }

    @keyframes l3 {
      to {
        transform: scale(1.8);
        opacity: 0
      }
    }

    .ecg-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      overflow: visible;
    }

    .ecg-path {
      stroke: white;
      stroke-dasharray: 190;
      stroke-dashoffset: 190;
      animation: draw-line 1.5s ease-in-out infinite;
    }

    @keyframes draw-line {
      0% {
        stroke-dashoffset: 190;
      }

      50% {
        stroke-dashoffset: 0;
      }

      100% {
        stroke-dashoffset: -190;
      }
    }

    #splash-heart {
      position: absolute;
      width: 80px;
      height: 80px;
      fill: #E8204E;
      opacity: 0;
      z-index: 5;
      animation: heart-beat-behind 1.0s ease-in-out 0.8s forwards;
    }

    #splash-heart-shockwave {
      position: absolute;
      width: 80px;
      height: 80px;
      stroke: #E8204E;
      stroke-width: 0.25px;
      fill: none;
      opacity: 0;
      z-index: 4;
      animation: heart-shockwave 0.6s ease-out 1s forwards;
    }

    #splash-nutri {
      animation: slideInFromLeft 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }

    #splash-quest {
      animation: slideInFromRight 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }

    @keyframes slideInFromLeft {
      0% {
        transform: translateX(-150%);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes slideInFromRight {
      0% {
        transform: translateX(150%);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes heart-beat-behind {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      25% {
        opacity: 0.5;
        transform: scale(1.8);
      }

      35% {
        transform: scale(1.4);
      }

      100% {
        opacity: 0;
        transform: scale(1.4);
      }
    }

    @keyframes heart-shockwave {
      0% {
        opacity: 0.6;
        transform: scale(1.4);
      }

      100% {
        opacity: 0;
        transform: scale(2.8);
      }
    }

    #splash-ecg-line {
      animation: fadeIn 0.1s ease-out 0.8s forwards;
    }

    .splash-ecg-path {
      stroke-dasharray: 450;
      stroke-dashoffset: 450;
      animation: drawSplashLine 0.8s ease-in-out 0.8s forwards;
    }

    @keyframes drawSplashLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    #splash-tagline {
      animation: fadeIn 1s ease-in 0.8s forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .analyse-btn {
      position: relative;
      overflow: hidden;
    }

    .analyse-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(110deg, rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 60%);
      transform: translateX(-100%);
      transition: transform 0.6s ease-in-out;
    }

    .analyse-btn:hover::after {
      transform: translateX(100%);
    }

    .custom-titlebar {
      width: env(titlebar-area-width, 100%);
      left: env(titlebar-area-x, 0px);
      -webkit-app-region: drag;
      app-region: drag;
    }

    .custom-titlebar button,
    .custom-titlebar input {
      -webkit-app-region: no-drag;
      app-region: no-drag;
    }
  </style>
</head>

<body>
  <!-- PWA Install Prompt Button (hidden by default) -->

  <!-- Splash Screen -->
  <div id="splash-screen"
    class="transition-opacity duration-500 ease-out overflow-hidden fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
    <div id="recovery-message" class="hidden text-center p-4">
      <svg class="w-12 h-12 text-blue-500 mx-auto animate-spin mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
      </svg>
      <p class="text-lg text-gray-600"></p>
    </div>
    <div id="splash-title-container" class="relative h-[80px] flex items-center justify-center">
      <h1 id="splash-title" class="flex relative z-10 text-5xl font-bold text-gray-700">
        <span id="splash-nutri">Nutri</span><span id="splash-quest">Quest</span>
      </h1>
      <svg id="splash-heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
      </svg>
      <svg id="splash-heart-shockwave" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
      </svg>
    </div>
    <div class="relative w-96 h-12">
      <svg id="splash-ecg-line" class="absolute inset-0 w-full h-full opacity-0" viewBox="0 0 300 60">
        <path class="splash-ecg-path" d="M0 30 H80 L95 10 L125 50 L145 20 L155 30 H300" stroke-width="3"
          stroke="#E8204E" fill="none"></path>
      </svg>
    </div>
    <p id="splash-tagline" data-lang-key="tagline" class="text-lg text-gray-500 mt-2 opacity-0">Your Journey to a
      Healthier You.</p>
  </div>

  <!-- Main Application Container -->
  <div id="main-app-content" class="opacity-0 bg-gray-100 text-gray-800 hidden min-h-screen flex flex-col">

    <!-- Header - DaisyUI Navbar: NutriQuest App Header -->
    <header class="custom-titlebar navbar bg-base-100 shadow sticky top-0 z-50">
      <!-- Left: Logo and Date -->
      <div class="flex items-center gap-2 sm:gap-3">
        <svg class="w-6 h-6 sm:w-10 sm:h-10 header-heart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <defs>
            <linearGradient id="headerHeartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:rgb(239,68,68)" />
              <stop offset="100%" style="stop-color:rgb(236,72,153)" />
            </linearGradient>
          </defs>
          <path fill="url(#headerHeartGradient)"
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z">
          </path>
        </svg>
        <div class="sm:text-left header-greeting-wrapper">
          <h1 id="header-greeting" class="text-lg sm:text-2xl font-bold text-gray-700"></h1>
          <p id="header-date-subtitle" class="text-gray-500 text-sm"></p>
        </div>
      </div>

      <!-- Right: Language, User, Action Buttons -->
      <div class="flex items-center gap-1 sm:gap-4 ml-auto">

        <!-- Language Switch (daisyUI Button Group) -->
        <div class="join">
          <input type="radio" name="navbar-language" value="en" class="lang-radio join-item btn btn-sm" aria-label="EN"
            checked>
          <input type="radio" name="navbar-language" value="zh" class="lang-radio join-item btn btn-sm" aria-label="中">
        </div>

        <!-- User Menu (relative parent required for dropdown) -->
        <div id="user-header" class="dropdown dropdown-end">
          <div tabindex="0" role="button" id="account-menu-btn"
            class="btn btn-sm btn-ghost btn-circle p-2 hover:bg-gray-200 transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <ul tabindex="0" id="account-dropdown"
            class="menu dropdown-content bg-base-100 rounded-box z-1 w-64 max-w-xs p-2 shadow">
            <li>
              <div id="user-email-dropdown" class="text-sm font-medium text-gray-700 break-words whitespace-normal"></div>
            </li>
            <li>
              <a href="#" id="sign-out-btn-dropdown" data-lang-key="signOutButton">Sign Out</a>
            </li>
          </ul>
        </div>
        <!-- Guest Login Button -->
        <div id="guest-header" class="flex-none hidden">
          <a href="/login/" class="btn btn-primary btn-sm">
            <span data-lang-key="loginButton">Login</span>
          </a>
        </div>
        <!-- Favourites and Settings Buttons -->
        <button id="favourites-btn" class="btn btn-ghost btn-circle text-gray-500 hover:text-yellow-500"
          data-lang-key-title="favouritesTitle" title="Favourites">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button id="settings-btn" class="btn btn-ghost btn-circle text-gray-500 hover:text-blue-500"
          data-lang-key-title="setGoalsTitle" title="Set Your Daily Goals">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </header>

    <div class="p-4 sm:p-8">
      <div class="w-full max-w-6xl mx-auto pt-16 sm:pt-24">

        <img src="/icons/NutriQuest_Logo.png" alt="NutriQuest Logo" class="mx-auto h-16 md:h-20 w-auto">

        <div class="flex items-center justify-center gap-2 mt-2">
          <p data-lang-key="tagline" class="text-gray-500 text-lg">Your Journey to a Healthier You.</p>

          <button class="btn btn-ghost btn-circle text-gray-400 hover:text-blue-500" onclick="openAboutModal()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
        </div>
      </div>

      <div class="search-container max-w-xl mx-auto text-center">
        <div
          class="relative flex items-center bg-white border border-gray-200 rounded-full shadow-md hover:shadow-lg focus-within:shadow-lg over-3d">
          <div class="pl-5"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg></div>
          <input type="text" id="food-input"
            class="w-full bg-transparent p-4 pl-2 text-lg rounded-full focus:outline-none border-none shadow-none"
            data-lang-key-placeholder="foodInputPlaceholder" placeholder="e.g., 1 cup of rice and grilled chicken">
          <button id="voice-input-btn" class="p-3 text-gray-500 hover:text-blue-500"
            data-lang-key-title="voiceInputTitle" title="Voice Input">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
              </path>
            </svg>
          </button>
          <button id="camera-scan-btn" class="p-3 pr-5 text-gray-500 hover:text-blue-500"
            data-lang-key-title="scanWithCameraTitle" title="Scan with Camera">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>

        <!-- Meal Type Selector -->
        <div id="meal-type-selector" class="flex flex-wrap justify-center gap-2 mt-4">
          <button data-type="Breakfast"
            class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
            data-lang-key="breakfast">Breakfast</button>
          <button data-type="Lunch"
            class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
            data-lang-key="lunch">Lunch</button>
          <button data-type="Dinner"
            class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
            data-lang-key="dinner">Dinner</button>
          <button data-type="Snack"
            class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
            data-lang-key="snack">Snack</button>
        </div>

        <div class="mt-6">
          <button id="analyse-btn"
            class="over-3d analyse-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold py-3 px-8 text-lg rounded-2xl shadow-md hover:shadow-lg transform hover:-translate-y-px transition-all">
            <span class="relative z-10 " data-lang-key="analyseMealButton">Analyse Meal</span>
          </button>
        </div>

        <!-- Quick Access Section -->
        <div id="quick-access" class="mt-8 text-center">
          <h3 class="text-lg font-semibold text-gray-600 mb-3" data-lang-key="quickAccess">Quick
            Access</h3>
          <div class="flex flex-wrap justify-center gap-2">
            <button
              class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
              data-lang-key="hainaneseChickenRice">Hainanese Chicken Rice</button>
            <button
              class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
              data-lang-key="laksa">Laksa</button>
            <button
              class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
              data-lang-key="kayaToast">Kaya Toast</button>
            <button
              class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
              data-lang-key="bakKutTeh">Bak Kut Teh</button>
          </div>
        </div>
      </div>

      <div class="mt-8 text-center">
        <a class="text-lg link link-hover link-primary font-bold" id="toggle-dashboard-btn">
          <span data-lang-key="viewDashboard">View Dashboard</span>
        </a>
      </div>

      <div id="dashboard" class="mt-10 w-full max-w-6xl mx-auto hidden">
        <div class="flex justify-center space-x-2 mb-6">
          <button data-period="day"
            class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
            data-lang-key="day">Day</button>
          <button data-period="week"
            class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
            data-lang-key="week">Week</button>
          <button data-period="month"
            class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
            data-lang-key="month">Month</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div id="period-totals-card" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm">
              <div class="flex justify-between items-center mb-4">
                <button id="prev-period-btn"
                  class="p-2 rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Previous Period">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                    </path>
                  </svg>
                </button>
                <div id="period-title-container"
                  class="flex items-center justify-center cursor-pointer hover:text-blue-600 transition-colors group">
                  <h2 id="period-title"
                    class="text-xl sm:text-2xl font-bold text-gray-800 text-center px-2 group-hover:text-blue-600 transition-colors">
                  </h2>
                  <svg class="w-5 h-5 ml-1 text-gray-500 group-hover:text-blue-600 transition-colors" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                    </path>
                  </svg>

                  <input type="date" id="calendar-date-input" value="2025-11-11" class="opacity-0 w-0 h-0 absolute" />
                  <input type="week" id="calendar-week-input" value="2025-W47" class="opacity-0 w-0 h-0 absolute" />
                  <input type="month" id="calendar-month-input" value="2025-11" class="opacity-0 w-0 h-0 absolute" />

                </div>
                <button id="next-period-btn"
                  class="p-2 rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Next Period">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
              <div id="period-totals" class="grid grid-cols-2 gap-4 text-center">
                <div>
                  <p class="text-sm text-gray-600" data-lang-key="calories">Calories</p>
                  <p id="total-calories" class="text-2xl font-semibold text-blue-600">0
                  </p>
                </div>
                <div>
                  <p class="text-sm text-gray-600" data-lang-key="protein">Protein</p>
                  <p id="total-protein" class="text-2xl font-semibold text-green-600">0 g
                  </p>
                </div>
                <div>
                  <p class="text-sm text-gray-600" data-lang-key="fat">Fat</p>
                  <p id="total-fat" class="text-2xl font-semibold text-orange-500">0 g</p>
                </div>
                <div>
                  <p class="text-sm text-gray-600" data-lang-key="carbs">Carbs</p>
                  <p id="total-carbs" class="text-2xl font-semibold text-red-500">0 g</p>
                </div>
              </div>
              <div class="text-center mt-6">
                <button id="toggle-details-btn" class="text-blue-500 hover:underline" data-lang-key="showDetails">Show
                  Details</button>
              </div>
            </div>
            <!-- Detailed Dashboard View (Initially Hidden) -->
            <div id="detailed-dashboard-view" class="hidden space-y-6">
              <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm">
                <div id="charts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div id="main-chart-wrapper">
                    <h3 id="dynamic-chart-title" class="text-lg font-bold text-center text-gray-800 mb-2"></h3>
                    <p id="period-goal-text" class="text-center text-gray-500 text-sm mb-1 hidden"></p>
                    <p id="period-actual-text" class="text-center font-semibold text-sm mb-2 hidden"></p>
                    <canvas id="calorie-gauge-chart"></canvas>
                    <div id="bar-chart-container" class="relative h-80 hidden">
                      <canvas id="period-bar-chart"></canvas>
                    </div>
                  </div>
                  <div id="nutrition-balance-wrapper">
                    <h3 class="text-lg font-bold text-center text-gray-800 mb-2" data-lang-key="nutritionBalance">
                      Nutrition Balance</h3>
                    <canvas id="nutrition-chart"></canvas>
                    <div id="nutrition-balance-text" class="hidden text-left"></div>
                  </div>
                </div>
                <div id="small-gauges-container" class="grid grid-cols-3 gap-4 mt-6">
                  <div>
                    <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="protein">Protein
                    </h3>
                    <canvas id="protein-gauge-chart"></canvas>
                  </div>
                  <div>
                    <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="fat">Fat</h3>
                    <canvas id="fat-gauge-chart"></canvas>
                  </div>
                  <div>
                    <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="carbs">Carbs</h3>
                    <canvas id="carbs-gauge-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- Nutrition Advice Card -->
            <div id="advice-card" class="card over-3d shadow-sm hidden">
              <h2 class="card-title mb-2" data-lang-key="nutritionAdvice">Nutrition Advice
              </h2>
              <div id="advice-content" class="flex items-start space-x-4">
                <span id="advice-icon" class="text-3xl"></span>
                <div>
                  <p id="advice-text" class="text-gray-700"></p>
                  <p id="advice-food" class="text-gray-600 text-sm mt-2 hidden"></p>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-3">
            <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm min-h-full flex flex-col">
              <h2 class="text-2xl font-bold text-gray-800 mb-4" data-lang-key="mealList">Meal
                List</h2>
              <div id="meal-list" class="flex-grow space-y-4 max-h-[600px] overflow-y-auto pr-2">
                <p id="no-meals-message" class="text-gray-500" data-lang-key="noMeals">No
                  meals recorded for this period.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-8 text-center">
          <button id="reset-all-btn" class="btn btn-warning" data-lang-key="deleteTodayData">
            Delete Today's Data
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- PWA Install Modal -->
  <dialog id="pwa-install-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <div class="flex flex-col justify-center">
        <p>Install NutriQuest on your device for best experience!</p>
        <button id="install-btn" class="btn btn-primary mt-4">Install </button>
      </div>

    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Camera Choice Modal -->
  <dialog id="camera-choice-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h2 class="text-2xl font-bold mb-6" data-lang-key="scanWithCameraTitle">Scan with Camera Options</h2>
      <div class="space-y-4">
        <button id="scan-meal-btn" class="w-full btn btn-primary" data-lang-key="scanMealButton">
          Scan Meal with Camera (mobile)
        </button>
        <button id="scan-barcode-btn" class="w-full btn btn-accent" data-lang-key="scanBarcodeButton">
          Scan Barcode
        </button>
        <button id="upload-image-btn" class="w-full btn btn-secondary" data-lang-key="uploadFromLibrary">
          Upload from Library
        </button>
        <form method="dialog">
          <button class="w-full btn btn-ghost" data-lang-key="closeButton">Close</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Barcode Scanner Modal (DaisyUI) -->
  <dialog id="barcode-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-md">
      <form method="dialog">
        <button
          class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-gray-700 hover:bg-gray-200">✕</button>
      </form>
      <h3 class="text-2xl font-bold mb-4 text-center" data-lang-key="scanBarcodeTitle">Scan a Barcode</h3>
      <div id="html5-qrcode-barcode" class="w-full rounded-lg"></div>
      <p id="barcode-result" class="mt-2 text-gray-600 text-center"></p>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost" data-lang-key="closeButton">Close</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Serving Size - DaisyUI v5 Dialog Modal -->
  <dialog id="serving-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h2 class="text-2xl font-bold mb-2 text-center" data-lang-key="servingSizeTitle">Enter Serving Size</h2>
      <p id="serving-product-name" class="text-center text-gray-600 mb-4"></p>
      <form id="serving-form">
        <label for="serving-size" class="block text-sm font-medium text-gray-800 mb-2"
          data-lang-key="servingSizeLabel">Serving Size (grams)</label>
        <input type="number" id="serving-size" value="100" class="input input-bordered w-full">
        <div class="modal-action">
          <form method="dialog">
            <button type="button" class="btn btn-ghost" data-lang-key="cancelButton">Cancel</button>
          </form>
          <button type="submit" form="serving-form" class="btn btn-primary" data-lang-key="addMealButton">Add
            Meal</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>


  <!-- Favourites Modal (DaisyUI v5 Dialog) -->
  <dialog id="favourites-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-lg w-full">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="favouritesTitle">Your Favourite Meals</h2>
      <div id="favourites-list" class="space-y-2 max-h-96 overflow-y-auto">
        <!-- Favourites will be rendered here -->
      </div>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost" data-lang-key="closeButton">Close</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Custom Alert/Confirm Modal (DaisyUI v5 Dialog) -->
  <dialog id="alert-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <p id="alert-message" class="text-lg mb-6 text-center"></p>
      <div id="alert-buttons" class="modal-action justify-center">
        <button id="alert-ok-btn" class="btn btn-primary px-8" data-lang-key="okButton">OK</button>
        <button id="alert-confirm-btn" class="btn btn-primary px-8" data-lang-key="confirmButton">Confirm</button>
        <button id="alert-cancel-btn" class="btn btn-ghost px-8" data-lang-key="cancelButton">Cancel</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>


  <!-- Settings Modal (DaisyUI) -->
  <dialog id="settings-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box flex flex-col">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <div class="p-4 border-b border-gray-200">
        <h2 class="text-2xl font-bold text-center" data-lang-key="setGoalsTitle">Set Your Daily
          Goals
        </h2>
      </div>

      <div class="overflow-x-hidden overflow-y-auto p-4">
        <p data-lang-key="settingsDescription">
          Let us calculate your needs, or set your own manual goal.
        </p>
        <form id="diagnosis-form" class="mt-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <fieldset class="fieldset">
              <legend class="fieldset-legend" data-lang-key="gender">Gender</legend>
              <select id="gender" class="select">
                <option value="male" data-lang-key="male">Male</option>
                <option value="female" data-lang-key="female">Female</option>
              </select>
            </fieldset>

            <fieldset class="fieldset">
              <legend class="fieldset-legend" data-lang-key="age">Age</legend>
              <input type="number" id="age" value="30" class="input" />
            </fieldset>

            <fieldset class="fieldset">
              <legend class="fieldset-legend" data-lang-key="height">Height (cm)</legend>
              <input type="number" id="height" value="170" class="input" />
            </fieldset>

            <fieldset class="fieldset">
              <legend class="fieldset-legend" data-lang-key="weight">Weight (kg)</legend>
              <input type="number" id="weight" value="70" class="input" />
            </fieldset>
          </div>

          <fieldset class="fieldset">
            <legend class="fieldset-legend" data-lang-key="activityLevel">Activity Level</legend>
            <select id="activity-level" class="select">
              <option value="1.2" data-lang-key="activityLevel1">
                Sedentary (mostly sitting, little to no exercise)
              </option>
              <option value="1.375" data-lang-key="activityLevel2" selected>
                Lightly Active (light exercise/walks 1-2 times a week)
              </option>
              <option value="1.55" data-lang-key="activityLevel3">
                Moderately Active (regular exercise 3-5 times a week)
              </option>
              <option value="1.725" data-lang-key="activityLevel4">
                Very Active (vigorous exercise 6-7 times a week)
              </option>
              <option value="1.9" data-lang-key="activityLevel5">
                Extremely Active (strenuous exercise daily or physical job)
              </option>
            </select>
          </fieldset>

          <button type="submit" class="btn btn-primary w-full mt-6" data-lang-key="calculateAndSave">
            Calculate &amp; Save
          </button>
        </form>

        <div class="divider" data-lang-key="or">OR</div>
        <form id="manual-goal-form">
          <fieldset class="fieldset">
            <legend class="fieldset-legend" data-lang-key="setManualGoal">Set Manual Calorie Goal</legend>
            <input type="number" id="manual-calories" value="2000" class="input">
            <button type="submit" class="btn btn-soft btn-neutral w-full mt-4" data-lang-key="saveManualGoal">
              Save Manual Goal
            </button>
          </fieldset>
        </form>

        <div class="divider"></div>

        <div>
          <h3 class="text-lg font-semibold text-error" data-lang-key="dangerZone">Danger Zone</h3>
          <p class="text-sm mt-1" data-lang-key="dangerZoneDesc">
            This action cannot be undone. Please be certain.
          </p>
          <button id="delete-all-data-btn" class="btn btn-error w-full mt-4" data-lang-key="deleteAllData">
            Delete All Data
          </button>
        </div>
        <div class="divider"></div>
        <div class="text-center">
          <form method="dialog">
            <button class="btn w-full btn-ghost" data-lang-key="closeButton">Close</button>
          </form>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Quantity Confirmation Modal (DaisyUI v5 Dialog) -->
  <dialog id="quantity-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="confirmFoodTitle">Confirm Food & Quantity</h2>
      <p class="text-center mb-4">We identified this as: <strong id="identified-food-name" class="capitalize"></strong>.
        Is this correct?</p>
      <form id="quantity-form">
        <label for="quantity-input" class="block text-sm font-medium text-gray-800 mb-2"
          data-lang-key="quantityLabel">Enter
          quantity (e.g., 1 piece, 100g)</label>
        <input type="text" id="quantity-input" class="input input-bordered w-full">
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost" data-lang-key="cancelButton">Cancel</button>
        </form>
        <button type="submit" form="quantity-form" class="btn btn-primary"
          data-lang-key="confirmButton">Confirm</button>
      </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Loading Overlay -->
  <div id="loading-overlay" hidden
    class="fixed inset-0 bg-black/40 backdrop-blur flex items-center justify-center z-[1000]">
    <div class="flex flex-col items-center justify-center text-white">
      <div class="relative w-24 h-24 flex items-center justify-center">
        <div class="loader"></div>
        <svg class="ecg-line" width="120" height="80" viewBox="0 0 120 80">
          <path class="ecg-path" d="M0 40 H30 L35 20 L45 60 L50 35 L55 40 H120" stroke-width="3" fill="none">
          </path>
        </svg>
      </div>
      <p id="loading-text" class="mt-8 text-lg font-semibold" data-lang-key="analyzing">Analyzing...</p>
    </div>
  </div>

  <!-- Voice Listening Modal (DaisyUI v5 Dialog) -->
  <dialog id="listening-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>

      <div class="text-center">
        <svg class="w-16 h-16 text-blue-500 mx-auto animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
          </path>
        </svg>
        <p id="listening-text-status" class="text-lg mt-4" data-lang-key="listeningStatus">Listening...</p>
      </div>

      <div class="modal-action justify-center">
        <form method="dialog">
          <button class="btn btn-ghost">
            <span data-lang-key="cancelButton">Cancel</span>
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!--quantity spec modal-->
  <!-- Replace the old div#quantity-spec-modal with the following -->
  <dialog id="quantity-spec-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box flex flex-col items-center justify-center">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h2 class="text-2xl font-bold mb-2 text-center" data-lang-key="specifyQuantityTitle">
        Specify Quantity
      </h2>
      <p class="text-center text-gray-600 mb-6">
        For: <strong id="quantity-spec-food-name"></strong>
      </p>

      <fieldset class="fieldset w-full max-w-xs">
        <legend class="fieldset-legend" data-lang-key="intuitiveQuantity">Intuitive Quantity</legend>
        <input type="range" class="range range-primary w-full" id="quantity-slider" min="0" max="4" value="2"
          step="1" />
        <div class="flex justify-between px-2.5 mt-2 text-xs w-full">
          <span>|</span>
          <span>|</span>
          <span>|</span>
          <span>|</span>
          <span>|</span>
        </div>
        <div id="slider-label" class="text-center font-semibold text-blue-600 mt-2">
          Regular Portion
        </div>
      </fieldset>

      <div class="divider" data-lang-key="or">OR</div>

      <fieldset class="fieldset w-full">
        <legend class="fieldset-legend" data-lang-key="specificQuantity">Specific Quantity</legend>
        <input type="text" id="quantity-spec-text" class="input" data-lang-key-placeholder="quantityPlaceholder"
          placeholder="e.g., 1 bowl, 200g, half" />
      </fieldset>

      <div class="flex items-center justify-between mt-6 w-full">
        <button type="button" id="unsure-quantity-spec-btn" class="btn btn-secondary" data-lang-key="imNotSure">
          I'm not sure
        </button>
        <div class="flex gap-2">
          <form method="dialog">
            <button class="btn btn-ghost" data-lang-key="cancelButton">Cancel</button>
          </form>
          <button type="button" id="confirm-quantity-spec-btn" class="btn btn-primary" data-lang-key="confirmButton">
            Confirm
          </button>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- about modal-->
  <dialog id="about-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>

      <h1 class="text-3xl font-bold text-center">Nutriquest</h1>
      <p class="text-center">Version 1.0 Beta, 11 Nov 2025 Build</p>
      <div class="divider">COPYRIGHT INFO</div>
      <p>Copyright (c) 2025 Shun1115sei</p>
      <p>This project is licensed under the MIT license, and the source code is freely accessible at the following link.
      </p>
      <a class="link link-primary"
        href="https://github.com/Shun1115sei/NutriQuest">https://github.com/Shun1115sei/NutriQuest</a>
      <div class="divider">ABOUT</div>
      <p>Just take a photo of your meal, talk about it, or type it in. NutriQuest is a new type of nutrition management
        tool that uses the cutting edge technologies to automatically analyse and record your meals. It eliminates the
        hassle of manual input, making it easy for anyone to start managing their health.</p>

      <div class="modal-action justify-center">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSea7FPGg8jfparcjMRra1KjXl_op3Qj-nJlGTlV94EV3xGyug/viewform"
          class="btn btn-primary">
          <span>Send feedback</span>
        </a>
        <form method="dialog">
          <button class="btn btn-ghost">
            <span>Done</span>
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- feedback modal-->
  <dialog id="feedback-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>

      <h1 class="text-3xl font-bold text-center">Hi there!</h1>
      <div class="divider"></div>
      <p>Would you want to submit a feedback to this app? This will mean a lot in the development of this application!
        Thanks! With love, from the NutriQuest developers.</p>
      <label class="label mt-4">
        <input type="checkbox" id="feedbackModalBlock" class="checkbox" />
        Don't show this again
      </label>
      <div class="modal-action justify-center">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSea7FPGg8jfparcjMRra1KjXl_op3Qj-nJlGTlV94EV3xGyug/viewform"
          class="btn btn-primary">
          <span>Send feedback</span>
        </a>
        <form method="dialog">
          <button class="btn btn-ghost">
            <span>Dismiss</span>
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!--hidden file input for food image upload-->
  <input type="file" id="image-upload-input" accept="image/*" class="hidden" />

  <!--hidden file input for food image upload-->
  <input type="file" id="new-cam-module" accept="image/*" capture="environment" class="hidden" />

  <!--application logic-->
  <script>
    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
    document.documentElement.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);
    const firebaseConfig = {
      apiKey: "AIzaSyB2uJs32bmnoOgHcB6GTZuu0eBanfZWLWE",
      authDomain: "nutriquest-6c40d.firebaseapp.com",
      projectId: "nutriquest-6c40d",
      storageBucket: "nutriquest-6c40d.firebasestorage.app",
      messagingSenderId: "893360379713",
      appId: "1:893360379713:web:4f7952bf9094caf139b3c0",
      measurementId: "G-C9V61B19G7"
    };
    let firebaseReady = !!firebaseConfig;
    let auth;
    let db;

    if (firebaseReady) {
      try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
      } catch (error) {
        console.error('Failed to initialise Firebase. Falling back to guest-only mode.', error);
        firebaseReady = false;
      }
    }

    if (!firebaseReady) {
      console.warn('Firebase configuration is unavailable. Authentication features will be disabled.');
      const unavailableErrorMessage = 'Authentication is unavailable. Please try again later or continue as a guest.';
      auth = {
        currentUser: null,
        onAuthStateChanged(callback) {
          const timer = setTimeout(() => callback(null), 0);
          return () => clearTimeout(timer);
        },
        async signInWithEmailAndPassword() { throw new Error(unavailableErrorMessage); },
        async createUserWithEmailAndPassword() { throw new Error(unavailableErrorMessage); },
        async sendPasswordResetEmail() { throw new Error(unavailableErrorMessage); },
        async signInWithPopup() { throw new Error(unavailableErrorMessage); },
        async signOut() { return Promise.resolve(); }
      };
      db = null;
    }

    // --- Language Translation Data ---
    const translations = {
      en: {
        loginTitle: "Login",
        emailLabel: "Email",
        passwordLabel: "Password",
        loginButton: "Login",
        authUnavailable: "Authentication is currently unavailable. Please continue as a guest or try again later.",
        authToggleAction: "Sign Up",
        signUpTitle: "Sign Up",
        guestButton: "Continue as Guest",
        forgotPassword: "Forgot Password?",
        enterEmailForReset: "Please enter your email address in the email field to reset your password.",
        passwordResetSent: "A password reset link has been sent to your email address. Please check your inbox.",
        healthTrackerTitle: "Health Tracker",
        tagline: "Your journey to a healthier you.",
        signOutButton: "Sign Out",
        todaysRecord: "Today's Record",
        tooltipInfo: "Simply snap a photo of your meal, describe it with your voice, or type it in. NutriQuest is a new kind of nutrition companion that uses powerful AI (gemini-2.0-flash) to analyse and log your meals automatically, so anyone can start managing their health with ease.",
        loginToSyncButton: "Login to Sync Data",
        favouritesTitle: "Favourites",
        setGoalsTitle: "Set Your Daily Goals",
        googleSignIn: "Sign in with Google",
        foodInputPlaceholder: "e.g., 1 bowl of rice and grilled chicken",
        voiceInputTitle: "Voice Input",
        scanWithCameraTitle: "Scan with Camera",
        breakfast: "Breakfast",
        lunch: "Lunch",
        dinner: "Dinner",
        snack: "Snack",
        analyseMealButton: "Analyse Meal",
        quickAccess: "Quick Access",
        hainaneseChickenRice: "Hainanese Chicken Rice",
        laksa: "Laksa",
        kayaToast: "Kaya Toast",
        bakKutTeh: "Bak Kut Teh",
        today: "Today",
        thisWeek: "This Week",
        thisMonth: "This Month",
        day: "Day",
        week: "Week",
        month: "Month",
        todaysTotals: "Today's Totals",
        thisWeeksTotals: "This Week's Total Calories",
        thisMonthsTotals: "This Month's Total Calories",
        calories: "Calories",
        protein: "Protein",
        fat: "Fat",
        carbs: "Carbs",
        showDetails: "Show Details",
        closeDetails: "Close",
        nutritionAdvice: "Nutrition Advice",
        todaysCalories: "Today's Calories",
        nutritionBalance: "Nutrition Balance",
        mealList: "Meal List",
        noMeals: "No meals recorded for this period.",
        deleteAllData: "Delete All Data",
        scanMealButton: "Scan Meal with Camera",
        scanBarcodeButton: "Scan Barcode",
        closeButton: "Close",
        positionMeal: "Position your meal in the camera",
        captureButton: "Capture",
        scanBarcodeTitle: "Scan a Barcode",
        zoom: "Zoom",
        servingSizeTitle: "Enter Serving Size",
        servingSizeLabel: "Serving Size (grams)",
        cancelButton: "Cancel",
        addMealButton: "Add Meal",
        okButton: "OK",
        confirmButton: "Confirm",
        settingsDescription: "Let us calculate your needs, or set your own manual goal.",
        gender: "Gender",
        male: "Male",
        female: "Female",
        age: "Age",
        height: "Height (cm)",
        weight: "Weight (kg)",
        activityLevel: "Activity Level",
        activityLevel1: "Sedentary (mostly sitting, little to no exercise)",
        activityLevel2: "Lightly Active (light exercise/walks 1-2 times a week)",
        activityLevel3: "Moderately Active (regular exercise 3-5 times a week)",
        activityLevel4: "Very Active (vigorous exercise 6-7 times a week)",
        activityLevel5: "Extremely Active (strenuous exercise daily or physical job)",
        calculateAndSave: "Calculate & Save", or: "OR", setManualGoal: "Set Manual Calorie Goal", saveManualGoal: "Save Manual Goal",
        analysing: "Analysing...", noFavourites: "No favourite meals yet. Click the star on a meal to add it.",
        didYouMean: 'Did you mean "{foodName}"?', listening: 'Listening...', checkingSpeech: 'Checking your speech...', speechError: 'Could not recognize speech: {error}',
        speechUnsupported: 'Speech recognition is not supported in this browser. Please use the latest Chrome, Edge, or Safari.',
        deletingData: 'Deleting data...', signingIn: 'Signing in...', signingOut: 'Signing out...', loadingData: 'Loading your data...', barcodeLookup: 'Found barcode: {barcode}. Looking up...',
        signOutError: 'Failed to sign out. Please try again.',
        offlineTitle: "You're Offline", offlineMessage: "Please check your internet connection and try again.",
        specifyQuantityTitle: "Specify Quantity",
        intuitiveQuantity: "Intuitive Quantity",
        specificQuantity: "Specific Quantity",
        quantityPlaceholder: "e.g., 1 bowl, 200g, half",
        sliderLabels: ["Very Small (0.5x)", "A Little Less (0.8x)", "Regular Portion (1x)", "A Little More (1.2x)", "Very Large (1.5x)"],
        sliderPrefixes: ["Very small portion of", "A little less than a regular portion of", "", "A little more than a regular portion of", "Very large portion of"],
        imNotSure: "I'm not sure",
        nextMeal: "your next meal",
        goalSetMessage: "Your daily goal has been set to {calories} kcal.",
        adviceLowProtein: "For {nextMeal}, focus on a protein-rich food like grilled chicken, fish, or tofu to improve your balance.",
        adviceHighFat: "For {nextMeal}, try a lower-fat option. Steamed vegetables and a lean protein source would be a great choice.",
        adviceBalanced: "You're doing great! For {nextMeal}, a balanced meal with whole grains, lean protein, and colourful vegetables would be perfect to continue your streak.",
        adviceStart: "Let's get started! For your next meal, try to include a mix of protein, healthy fats, and complex carbs.",
        adviceLowProteinFood: "Suggested food for {nextMeal}: grilled chicken breast with quinoa and steamed vegetables.",
        adviceHighFatFood: "Suggested food for {nextMeal}: a big mixed salad with chickpeas, citrus dressing, and a lean protein like turkey breast.",
        adviceBalancedFood: "Suggested food for {nextMeal}: baked salmon with brown rice and roasted vegetables.",
        adviceStartFood: "Suggested food for {nextMeal}: a bowl of oatmeal topped with berries, yogurt, and almonds.",
        rateLimitError: "Requests are currently busy. Please wait a moment and try again.",
        removeFavouriteConfirm: "Are you sure you want to remove this favourite?",
        removeMealConfirm: "Are you sure you want to delete this meal record?",
        viewDashboard: "View Dashboard",
        hideDashboard: "Hide Dashboard",
        confirmFoodTitle: "Confirm Food & Quantity",
        quantityLabel: "Enter quantity (e.g., 1 piece, 100g)",
        deleteTodayData: "Delete Today's Data",
        deleteTodayConfirm: "Are you sure you want to delete all meals recorded today?",
        dangerZone: "Danger Zone",
        dangerZoneDesc: "This action cannot be undone. Please be certain.",
        deleteAllDataConfirm: "Are you sure you want to delete all your data? This action cannot be undone.",
        uploadFromLibrary: "Upload from Library",
        sun: "S", mon: "M", tue: "T", wed: "W", thu: "T", fri: "F", sat: "S",
        week: "Week", periodGoal: "Period Goal", actualIntake: "Actual Intake",
        recoveringAnalysis: "Recovering interrupted photo analysis...",
      },
      zh: {
        loginTitle: "登录",
        emailLabel: "电子邮件",
        passwordLabel: "密码",
        loginButton: "登录",
        authToggleAction: "注册",
        signUpTitle: "注册",
        guestButton: "以访客身份继续",
        forgotPassword: "忘记密码？",
        enterEmailForReset: "请在电子邮件字段中输入您的电子邮件地址以重置密码。",
        passwordResetSent: "密码重置链接已发送到您的电子邮件地址。请检查您的收件箱。",
        healthTrackerTitle: "健康追踪器",
        tagline: "开启您的健康之旅。",
        signOutButton: "登出",
        todaysRecord: "今日记录",
        tooltipInfo: "只需拍下您的餐点、语音描述或打字输入。NutriQuest是一款新型营养管理工具，它使用强大的人工智能（gemini-2.0-flash）来自动分析和记录您的膳食。这免去了手动输入的麻烦，让任何人都能轻松开始健康管理。",
        loginToSyncButton: "登录以同步数据",
        favouritesTitle: "收藏",
        setGoalsTitle: "设定每日目标",
        oogleSignIn: "使用谷歌登录",
        foodInputPlaceholder: "例如：一碗米饭和烤鸡",
        voiceInputTitle: "语音输入",
        scanWithCameraTitle: "用相机扫描",
        breakfast: "早餐",
        lunch: "午餐",
        dinner: "晚餐",
        snack: "点心",
        analyseMealButton: "分析膳食",
        quickAccess: "快速访问",
        hainaneseChickenRice: "海南鸡饭",
        laksa: "叻沙",
        kayaToast: "咖椰吐司",
        bakKutTeh: "肉骨茶",
        today: "今天",
        thisWeek: "本星期",
        thisMonth: "这个月",
        todaysTotals: "今日总计",
        thisWeeksTotals: "本周总热量",
        thisMonthsTotals: "本月总热量",
        calories: "卡路里",
        protein: "蛋白质",
        fat: "脂肪",
        carbs: "碳水化合物",
        showDetails: "显示详细信息",
        closeDetails: "关闭",
        nutritionAdvice: "营养建议",
        todaysCalories: "今日卡路里",
        nutritionBalance: "营养均衡",
        mealList: "膳食清单",
        noMeals: "此期间没有记录膳食。",
        deleteAllData: "删除所有数据",
        scanMealButton: "用相机扫描膳食",
        scanBarcodeButton: "扫描条形码",
        closeButton: "关闭",
        positionMeal: "将您的餐点放在相机中",
        captureButton: "捕获",
        scanBarcodeTitle: "扫描条形码",
        zoom: "变焦",
        servingSizeTitle: "输入份量",
        servingSizeLabel: "份量（克）",
        cancelButton: "取消",
        addMealButton: "添加膳食",
        okButton: "好",
        confirmButton: "确认",
        settingsDescription: "让我们计算您的需求，或设置您自己的手动目标。",
        gender: "性别",
        male: "男性",
        female: "女性",
        age: "年龄",
        height: "身高（厘米）",
        weight: "体重（公斤）",
        activityLevel: "活动水平",
        activityLevel1: "久坐 (主要坐着，很少或没有运动)",
        activityLevel2: "轻度活跃 (每周进行1-2次散步等轻度运动)",
        activityLevel3: "中度活跃 (每周进行3-5次定期运动)",
        activityLevel4: "非常活跃 (每周进行6-7次剧烈运动)",
        activityLevel5: "极度活跃 (每天进行剧烈运动或从事体力劳动)",
        calculateAndSave: "计算并保存", or: "要么", setManualGoal: "设置手动卡路里目标", saveManualGoal: "保存手动目标",
        analysing: "分析中...", noFavourites: "还没有喜欢的食物。点击星星添加。",
        didYouMean: '您是指“{foodName}”吗？', listening: '正在听...', checkingSpeech: '正在检查您的语音...', speechError: '无法识别语音: {error}',
        speechUnsupported: '此浏览器不支持语音识别。请使用最新版的 Chrome、Edge 或 Safari。',
        deletingData: '正在删除数据...', signingIn: '登录中...', signingOut: '登出中...', loadingData: '正在加载您的数据...', barcodeLookup: '找到条形码: {barcode}。查询中...',
        signOutError: '登出失败。请再试一次。',
        offlineTitle: "您已离线", offlineMessage: "请检查您的网络连接并重试。",
        specifyQuantityTitle: "指定份量",
        intuitiveQuantity: "直观份量",
        specificQuantity: "具体份量",
        quantityPlaceholder: "例如：1碗，200克，一半",
        sliderLabels: ["非常小 (0.5倍)", "偏少 (0.8倍)", "标准份量 (1倍)", "偏多 (1.2倍)", "非常大 (1.5倍)"],
        sliderPrefixes: ["非常小份的", "偏少份的", "", "偏多份的", "非常大份的"],
        imNotSure: "不确定",
        nextMeal: "下一餐",
        goalSetMessage: "您的每日目标已设定为 {calories} 大卡。",
        adviceLowProtein: "对于{nextMeal}，多吃一些富含蛋白质的食物，如烤鸡、鱼或豆腐，以改善您的平衡。",
        adviceHighFat: "对于{nextMeal}，尝试低脂的选择。蒸蔬菜和瘦肉蛋白是一个很好的选择。",
        adviceBalanced: "你做得很好！对于{nextMeal}，一顿均衡的膳食，包括全谷物、瘦肉蛋白和五颜六色的蔬菜，将是保持健康的完美选择。",
        adviceStart: "让我们开始吧！下一餐，试着摄入蛋白质、健康脂肪和复合碳水化合物的混合物。",
        adviceLowProteinFood: "适合{nextMeal}的推荐食物：烤鸡胸搭配藜麦和蒸蔬菜。",
        adviceHighFatFood: "适合{nextMeal}的推荐食物：鹰嘴豆混合沙拉，配上柑橘酱汁和瘦火鸡肉。",
        adviceBalancedFood: "适合{nextMeal}的推荐食物：烤三文鱼配糙米和烤时蔬。",
        adviceStartFood: "适合{nextMeal}的推荐食物：一碗加入浆果、酸奶和杏仁的燕麦粥。",
        rateLimitError: "请求繁忙。请稍后再试。",
        removeFavouriteConfirm: "您确定要删除这个收藏吗？",
        removeMealConfirm: "您确定要删除这条膳食记录吗？",
        viewDashboard: "查看仪表板",
        hideDashboard: "隐藏仪表板",
        confirmFoodTitle: "确认食物和数量",
        quantityLabel: "输入数量（例如：1个，100克）",
        deleteTodayData: "删除今日数据",
        deleteTodayConfirm: "您确定要删除今天记录的所有膳食吗？",
        dangerZone: "危险区域",
        dangerZoneDesc: "此操作无法撤销，请谨慎操作。",
        deleteAllDataConfirm: "您确定要删除所有数据吗？此操作无法撤销。",
        uploadFromLibrary: "从相册上传",
        sun: "日", mon: "一", tue: "二", wed: "三", thu: "四", fri: "五", sat: "六",
        week: "周", periodGoal: "期间目标", actualIntake: "实际摄入",
        recoveringAnalysis: "正在恢复中断的照片分析...",
      }
    };

    // --- DOM Elements ---
    const foodInput = document.getElementById('food-input');
    const accountMenuBtn = document.getElementById('account-menu-btn');
    const accountDropdown = document.getElementById('account-dropdown');
    const userEmailDropdown = document.getElementById('user-email-dropdown');
    const signOutBtnDropdown = document.getElementById('sign-out-btn-dropdown');
    const analyseBtn = document.getElementById('analyse-btn');
    const dashboard = document.getElementById('dashboard');
    const mealList = document.getElementById('meal-list');
    const resetAllBtn = document.getElementById('reset-all-btn');
    const resetTodayBtn = document.getElementById('reset-today-btn');
    const guestModeBtn = document.getElementById('guest-mode-btn');
    const userHeader = document.getElementById('user-header');
    const guestHeader = document.getElementById('guest-header');
    const goToLoginBtn = document.getElementById('go-to-login-btn');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const toggleDashboardBtn = document.getElementById('toggle-dashboard-btn');
    const voiceInputBtn = document.getElementById('voice-input-btn');
    const cameraScanBtn = document.getElementById('camera-scan-btn');
    const cameraChoiceModal = document.getElementById('camera-choice-modal');
    const scanMealBtn = document.getElementById('scan-meal-btn');
    const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
    const toggleDetailsBtn = document.getElementById('toggle-details-btn');
    const detailedDashboardView = document.getElementById('detailed-dashboard-view');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const diagnosisForm = document.getElementById('diagnosis-form');
    const manualGoalForm = document.getElementById('manual-goal-form');
    const deleteAllDataBtn = document.getElementById('delete-all-data-btn');
    const imageUploadInput = document.getElementById('image-upload-input');
    const uploadImageBtn = document.getElementById('upload-image-btn');
    const barcodeModal = document.getElementById('barcode-modal');
    const servingModal = document.getElementById('serving-modal');
    const servingForm = document.getElementById('serving-form');
    const servingProductName = document.getElementById('serving-product-name');
    const favouritesBtn = document.getElementById('favourites-btn');
    const favouritesModal = document.getElementById('favourites-modal');
    const favouritesList = document.getElementById('favourites-list');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const mainAppContent = document.getElementById('main-app-content');
    const splashScreen = document.getElementById('splash-screen');
    let splashHideTimer = null;
    let splashDismissed = false;

    function hideSplash({ delay = 0 } = {}) {
      if (!splashScreen) return;

      const runHide = () => {
        if (!splashScreen || splashDismissed) return;
        splashDismissed = true;
        splashScreen.style.opacity = '0';
        setTimeout(() => {
          splashScreen.classList.add('hidden');
          if (mainAppContent) {
            mainAppContent.style.opacity = '1';
          }
        }, 500);
      };

      if (delay > 0) {
        if (splashHideTimer) clearTimeout(splashHideTimer);
        splashHideTimer = setTimeout(runHide, delay);
      } else {
        if (splashHideTimer) {
          clearTimeout(splashHideTimer);
          splashHideTimer = null;
        }
        runHide();
      }
    }

    function hideSplash({ delay = 0 } = {}) {
      if (!splashScreen) return;

      const runHide = () => {
        if (!splashScreen || splashDismissed) return;
        splashDismissed = true;
        splashScreen.style.opacity = '0';
        setTimeout(() => {
          splashScreen.classList.add('hidden');
          if (mainAppContent) {
            mainAppContent.style.opacity = '1';
          }
        }, 500);
      };

      if (delay > 0) {
        if (splashHideTimer) clearTimeout(splashHideTimer);
        splashHideTimer = setTimeout(runHide, delay);
      } else {
        if (splashHideTimer) {
          clearTimeout(splashHideTimer);
          splashHideTimer = null;
        }
        runHide();
      }
    }
    const listeningModal = document.getElementById('listening-modal');
    const listeningTextStatus = document.getElementById('listening-text-status');
    const periodTitle = document.getElementById('period-title');
    const dynamicChartTitle = document.getElementById('dynamic-chart-title');
    const calorieGaugeChartEl = document.getElementById('calorie-gauge-chart');
    const periodBarChartEl = document.getElementById('period-bar-chart');
    const smallGaugesContainer = document.getElementById('small-gauges-container');
    const chartsGrid = document.getElementById('charts-grid');
    const mainChartWrapper = document.getElementById('main-chart-wrapper');
    const nutritionBalanceWrapper = document.getElementById('nutrition-balance-wrapper');
    const nutritionChartEl = document.getElementById('nutrition-chart');
    const nutritionBalanceTextEl = document.getElementById('nutrition-balance-text');
    const barChartContainer = document.getElementById('bar-chart-container');
    const periodGoalText = document.getElementById('period-goal-text');
    const periodActualText = document.getElementById('period-actual-text');
    const quantityModal = document.getElementById('quantity-modal');
    const quantityForm = document.getElementById('quantity-form');
    const identifiedFoodNameEl = document.getElementById('identified-food-name');
    const quantityInput = document.getElementById('quantity-input');
    const offlineModal = document.getElementById('offline-modal');
    const offlineCloseBtn = document.getElementById('offline-close-btn');
    const quantitySpecModal = document.getElementById('quantity-spec-modal');
    const quantitySpecFoodName = document.getElementById('quantity-spec-food-name');
    const quantitySlider = document.getElementById('quantity-slider');
    const sliderLabel = document.getElementById('slider-label');
    const quantitySpecText = document.getElementById('quantity-spec-text');
    const confirmQuantitySpecBtn = document.getElementById('confirm-quantity-spec-btn');
    const unsureQuantitySpecBtn = document.getElementById('unsure-quantity-spec-btn');
    const newCamModule = document.getElementById('new-cam-module');

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    let isGuest = getCookie("userMode") === "guest"

    let allMeals = [];
    let favouriteMeals = []
    let userGoals = { calories: 2000, protein: 100, fat: 67, carbs: 250 }
    let nutritionChart = null
    let calorieGaugeChart = null
    let proteinGaugeChart = null
    let fatGaugeChart = null
    let carbsGaugeChart = null
    let periodChart = null
    let activePeriod = 'day'
    let currentDate = new Date()
    let isLoginMode = true
    let html5QrCodeInstance = null
    let currentScannedProduct = null
    let isDetailedView = false
    let identifiedFoodName = '';
    let foodNameForQuantitySpec = '';
    let speechRecognitionInstance = null;
    let listeningModalCloseHandler = null;
    let finalTranscript = '';

    /**
     * Opens the quantity specification modal for a given food item
     *
     * @param {any} foodName - The foodname parameter
     */

    function openQuantitySpecModal(foodName) {
      foodNameForQuantitySpec = foodName;
      quantitySpecFoodName.textContent = foodName;

      const currentLang = localStorage.getItem('language') || 'en';
      const labels = translations[currentLang].sliderLabels;

      quantitySlider.value = 2;
      sliderLabel.textContent = labels[2];
      quantitySpecText.value = "";
      quantitySpecModal.showModal();
    }

    /**
     * Sets up increment/decrement stepper buttons for numeric input fields
     *
     * @param {string} inputId - The inputid parameter
     */

    let foodKeyReverseMap = {};

    /**
     * Builds a reverse mapping from English food names to translation keys for multilingual support
     *
     */

    function buildFoodKeyReverseMap() {
      foodKeyReverseMap = Object.entries(translations.en).reduce((acc, [key, value]) => {
        // valueが文字列の場合のみ、処理を実行するように修正
        if (typeof value === 'string') {
          acc[value.toLowerCase()] = key;
        }
        return acc;
      }, {});
    }

    /**
     * Gets the translated name of a food item based on the current application language
     *
     * @param {any} originalFoodName - The originalfoodname parameter
     * @returns {any} The calculated or retrieved value
     */

    function getTranslatedFoodName(originalFoodName) {
      const currentLang = localStorage.getItem('language') || 'en';
      if (currentLang === 'en') {
        return originalFoodName;
      }

      const foodKey = foodKeyReverseMap[originalFoodName.toLowerCase()];

      if (foodKey && translations[currentLang][foodKey]) {
        return translations[currentLang][foodKey];
      }

      return originalFoodName;
    }

    /**
     * Returns a contextual greeting based on the current hour and language
     *
     * @param {string} lang - The lang parameter
     * @param {number} hour - The hour of day from 0 - 23
     * @returns {string} Localized greeting text
     */

    function getHeaderGreeting(lang, hour) {
      const greetings = {
        en: {
          morning: 'Good morning',
          afternoon: 'Good afternoon',
          evening: 'Good evening',
        },
        zh: {
          morning: '早上好',
          afternoon: '下午好',
          evening: '晚上好',
        },
      };
      const normalizedLang = greetings[lang] ? lang : 'en';
      let period = 'evening';
      if (hour >= 5 && hour < 12) {
        period = 'morning';
      } else if (hour >= 12 && hour < 18) {
        period = 'afternoon';
      }
      return greetings[normalizedLang][period];
    }

    /**
     * Generates a short date string (e.g. "19 Nov, Wed") for the header subtitle
     *
     * @param {Date} date - The date to format
     * @param {string} lang - The active language
     * @returns {string} The formatted subtitle text
     */

    function formatHeaderSubtitle(date, lang) {
      const locale = lang === 'zh' ? 'zh-CN' : 'en-SG';

      if (lang === 'zh') {
        const month = new Intl.DateTimeFormat(locale, { month: 'numeric' }).format(date);
        const day = new Intl.DateTimeFormat(locale, { day: 'numeric' }).format(date);
        const weekday = new Intl.DateTimeFormat(locale, { weekday: 'short' }).format(date);
        return `${month}月${day}日 ${weekday}`;
      }

      const day = new Intl.DateTimeFormat(locale, { day: 'numeric' }).format(date);
      const month = new Intl.DateTimeFormat(locale, { month: 'short' }).format(date);
      const weekday = new Intl.DateTimeFormat(locale, { weekday: 'short' }).format(date);
      return `${day} ${month}, ${weekday}`;
    }

    /**
     * Updates the header with a contextual greeting and short date subtitle
     *
     */

    function updateHeaderDate() {
      const greetingEl = document.getElementById('header-greeting');
      const subtitleEl = document.getElementById('header-date-subtitle');
      if (!greetingEl && !subtitleEl) return;

      const today = new Date();
      const lang = localStorage.getItem('language') || 'en';

      if (greetingEl) {
        greetingEl.textContent = getHeaderGreeting(lang, today.getHours());
      }

      if (subtitleEl) {
        subtitleEl.textContent = formatHeaderSubtitle(today, lang);
      }
    }
    /**
     * Sets the application language and updates all UI text elements accordingly
     *
     * @param {string} lang - The lang parameter
     */

    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      document.documentElement.lang = lang;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        const isActive = btn.dataset.lang === lang;
        btn.classList.toggle('bg-blue-600', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('text-gray-500', !isActive);
        btn.classList.toggle('hover:bg-gray-100', !isActive);
      });

      // For dashboard radio buttons
      document.querySelectorAll(`.lang-radio[value="${lang}"]`).forEach(radio => {
        radio.checked = true;
      });

      const translation = translations[lang];
      document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (key === 'authToggle') {
        } else if (translation[key]) {
          element.textContent = translation[key];
        }
      });


      document.querySelectorAll('[data-lang-key-placeholder]').forEach(element => {
        const key = element.getAttribute('data-lang-key-placeholder');
        if (translation[key]) element.placeholder = translation[key];
      });
      document.querySelectorAll('[data-lang-key-title]').forEach(element => {
        const key = element.getAttribute('data-lang-key-title');
        if (translation[key]) element.title = translation[key];
      });
      if (!mainAppContent.classList.contains('hidden')) updateDashboard(activePeriod);
      syncToggleDashboardButton();
      updateHeaderDate();

      if (!firebaseReady && authError) {
        authError.textContent = translation.authUnavailable || '';
      }
    }

    /**
     * Sets the default meal type (Breakfast/Lunch/Dinner/Snack) based on current time of day
     *
     */
    function setDefaultMealType() {
      const hour = new Date().getHours();
      let defaultMealType = (hour >= 5 && hour < 11) ? 'Breakfast' : (hour >= 11 && hour < 17) ? 'Lunch' : 'Dinner';
      if (hour < 5 || hour >= 21) defaultMealType = 'Snack';
      document.querySelectorAll('.meal-type-btn').forEach(btn => btn.classList.remove('active'));
      const activeButton = document.querySelector(`.meal-type-btn[data-type="${defaultMealType}"]`);
      if (activeButton) activeButton.classList.add('active');
    }

    /**
     * Displays the loading overlay with a specified message key for internationalization
     *
     * @param {string} messageKey - The messagekey parameter
     */

    function showLoader(messageKey) {
      const currentLang = localStorage.getItem('language') || 'en';
      loadingText.textContent = translations[currentLang][messageKey] || translations[currentLang].analysing;
      loadingOverlay.removeAttribute('hidden');
    }

    /**
     * Hides the loading overlay from the user interface
     *
     */

    function hideLoader() { loadingOverlay.setAttribute('hidden', ''); }

    /**
     * Displays an alert modal with a message and returns a promise when dismissed
     *
     * @param {string} message - The message parameter
     */
    function showAlert(message) {
      return new Promise(resolve => {
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const okBtn = document.getElementById('alert-ok-btn');
        const confirmBtn = document.getElementById('alert-confirm-btn');
        const cancelBtn = document.getElementById('alert-cancel-btn');

        // Set the message
        alertMessage.textContent = message;

        // Show only OK button for alerts
        okBtn.style.display = 'inline-flex';
        confirmBtn.style.display = 'none';
        cancelBtn.style.display = 'none';

        // Clean up any existing event listeners
        const newOkBtn = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Add event listener for OK button
        newOkBtn.addEventListener('click', () => {
          alertModal.close();
          resolve(true);
        });

        // Handle modal close events (ESC key, backdrop click)
        const handleClose = () => {
          alertModal.removeEventListener('close', handleClose);
          resolve(true);
        };
        alertModal.addEventListener('close', handleClose);

        // Show the modal
        alertModal.showModal();
      });
    }

    /**
     * Displays a confirmation modal with confirm/cancel buttons and returns user choice
     *
     * @param {string} message - The message to display
     * @returns {Promise<boolean>} Promise that resolves to true if confirmed, false if cancelled
     */
    function showConfirm(message) {
      return new Promise(resolve => {
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const okBtn = document.getElementById('alert-ok-btn');
        const confirmBtn = document.getElementById('alert-confirm-btn');
        const cancelBtn = document.getElementById('alert-cancel-btn');

        // Set the message
        alertMessage.textContent = message;

        // Show confirm and cancel buttons, hide OK button
        okBtn.style.display = 'none';
        confirmBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';

        // Clean up any existing event listeners by cloning nodes
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Add event listeners
        newConfirmBtn.addEventListener('click', () => {
          alertModal.close();
          resolve(true);
        });

        newCancelBtn.addEventListener('click', () => {
          alertModal.close();
          resolve(false);
        });

        // Handle modal close events (ESC key, backdrop click) - default to false
        const handleClose = () => {
          alertModal.removeEventListener('close', handleClose);
          resolve(false);
        };
        alertModal.addEventListener('close', handleClose);

        // Show the modal
        alertModal.showModal();
      });
    }

    /**
     * Shows the main application container and updates header based on authentication status
     *
     * @param {any} isLoggedIn - The isloggedin parameter
     */
    function showAppContainer(isLoggedIn) {
      mainAppContent.classList.remove('hidden');
      userHeader.style.display = isLoggedIn ? 'flex' : 'none';
      guestHeader.style.display = isLoggedIn ? 'none' : 'flex';
    }

    function openAccountDropdown() {
      if (userHeader) {
        userHeader.classList.add('dropdown-open');
      }
      if (accountMenuBtn) {
        accountMenuBtn.setAttribute('aria-expanded', 'true');
      }
      if (accountDropdown) {
        accountDropdown.setAttribute('aria-hidden', 'false');
      }
    }

    function closeAccountDropdown() {
      if (userHeader) {
        userHeader.classList.remove('dropdown-open');
      }
      if (accountMenuBtn) {
        accountMenuBtn.setAttribute('aria-expanded', 'false');
      }
      if (accountDropdown) {
        accountDropdown.setAttribute('aria-hidden', 'true');
      }
    }

    function toggleAccountDropdown() {
      if (!userHeader) return;
      if (userHeader.classList.contains('dropdown-open')) {
        closeAccountDropdown();
      } else {
        openAccountDropdown();
      }
    }

    closeAccountDropdown();

    async function handleSignOut(event) {
      event.preventDefault();
      if (!auth) return;

      closeAccountDropdown();

      const currentLang = localStorage.getItem('language') || 'en';

      try {
        showLoader('signingOut');
        await auth.signOut();
        hideLoader();
        userEmailDropdown.textContent = '';
        allMeals = [];
        favouriteMeals = [];
        dashboard.classList.add('hidden');
        updateDashboard(activePeriod);
        localStorage.removeItem('guestMeals');
        localStorage.removeItem('guestFavourites');
        localStorage.removeItem('guestGoals');
        showAppContainer(false);
      } catch (error) {
        hideLoader();
        console.error('Failed to sign out:', error);
        const errorMessage = translations[currentLang]?.signOutError || 'Failed to sign out. Please try again.';
        showAlert(errorMessage);
      }
    }

    /**
     * Sets user daily nutrition goals and saves them to storage
     *
     * @param {any} calorieGoal - The caloriegoal parameter
     */
    function setAndSaveGoals(calorieGoal) {
      userGoals = {
        calories: calorieGoal,
        protein: Math.round((calorieGoal * 0.20) / 4),
        fat: Math.round((calorieGoal * 0.30) / 9),
        carbs: Math.round((calorieGoal * 0.50) / 4)
      };
      saveUserGoals();
      updateDashboard(activePeriod);
    }

    /**
     * Saves user nutrition goals to Firebase (authenticated users) or localStorage (guests)
     * Handles both authenticated (Firebase) and guest (localStorage) users
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function saveUserGoals() {
      if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).set({ goals: userGoals }, { merge: true });
      else localStorage.setItem('guestGoals', JSON.stringify(userGoals));
    }

    /**
     * Loads user nutrition goals from Firebase or localStorage, shows settings modal if none exist
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function loadUserGoals() {
      let loadedGoals = null;
      if (auth.currentUser) {
        const doc = await db.collection('users').doc(auth.currentUser.uid).get();
        if (doc.exists && doc.data().goals) loadedGoals = doc.data().goals;
      } else {
        const storedGoals = localStorage.getItem('guestGoals');
        if (storedGoals) loadedGoals = JSON.parse(storedGoals);
      }
      if (loadedGoals) userGoals = loadedGoals;
      else settingsModal.showModal();
    }

    /**
     * Saves a new meal entry to Firebase (authenticated users) or localStorage (guests)
     * Handles both authenticated (Firebase) and guest (localStorage) users
     *
     * @param {any} newMeal - The newmeal parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function saveMeal(newMeal) {
      if (auth.currentUser) {
        const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('meals').add(newMeal);
        allMeals.push({ id: docRef.id, ...newMeal });
      } else {
        const mealWithId = { ...newMeal, id: Date.now().toString() };
        allMeals.push(mealWithId);
        saveMealsToStorage();
      }
    }

    /**
     * Deletes a meal entry by ID from Firebase or localStorage
     *
     * @param {string} mealId - The mealid parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function deleteMeal(mealId) {
      if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('meals').doc(mealId).delete();
      allMeals = allMeals.filter(m => m.id.toString() !== mealId.toString());
      if (!auth.currentUser) saveMealsToStorage();
      updateDashboard(activePeriod);
    }

    /**
     * Handles image file upload, processes it for food identification using AI vision.
     * This version is optimized for mobile devices and includes the logic to handle the new "unknown" response.
     *
     * @param {Event} event - The file input change event.
     * @returns {Promise} A promise that resolves when the operation completes.
     * @async
     */
    async function handleImageUpload(eventOrFile) {
      const file = eventOrFile.target ? eventOrFile.target.files[0] : eventOrFile;
      if (!file) return;

      try {
        if (eventOrFile.target) {
          await saveImage(file);
          // ▼▼▼ sessionStorageからlocalStorageに変更 ▼▼▼
          localStorage.setItem('photo_pending', 'true');
        }

        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 800;
        const imageBitmap = await createImageBitmap(file);

        let width = imageBitmap.width;
        let height = imageBitmap.height;
        if (width > height) {
          if (width > MAX_WIDTH) {
            height = Math.round(height * (MAX_WIDTH / width));
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width = Math.round(width * (MAX_HEIGHT / height));
            height = MAX_HEIGHT;
          }
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imageBitmap, 0, 0, width, height);
        imageBitmap.close();

        canvas.toBlob(async (blob) => {
          const reader = new FileReader();
          reader.onloadend = async () => {
            const resizedImageDataUrl = reader.result;
            showLoader('analysing');
            try {
              const base64String = resizedImageDataUrl.split(',')[1];
              identifiedFoodName = await identifyFoodFromImage(base64String);
              hideLoader();
              if (identifiedFoodName) {
                identifiedFoodNameEl.textContent = identifiedFoodName;
                quantityInput.value = '';
                quantityModal.showModal();
                quantityInput.focus();
                await clearImage();
                // ▼▼▼ sessionStorageからlocalStorageに変更 ▼▼▼
                localStorage.removeItem('photo_pending');
              } else {
                throw new Error("Could not identify the food from the uploaded image.");
              }
            } catch (error) {
              hideLoader();
              console.error("Image upload identification error:", error);
              showAlert("Sorry, we couldn't identify the food in the image.");
              await clearImage();
              // ▼▼▼ sessionStorageからlocalStorageに変更 ▼▼▼
              localStorage.removeItem('photo_pending');
            }
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.8);

      } catch (error) {
        console.error("Error in handleImageUpload:", error);
        showAlert("An error occurred while processing the image. Please try again.");
        await clearImage();
        // ▼▼▼ sessionStorageからlocalStorageに変更 ▼▼▼
        localStorage.removeItem('photo_pending');
      }
    }


    // --- IndexedDB Helper Functions ---
    function openDb() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('NutriQuestDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('temp_images')) {
            db.createObjectStore('temp_images', { keyPath: 'id' });
          }
        };
        request.onsuccess = (event) => {
          resolve(event.target.result);
        };
        request.onerror = (event) => {
          reject('IndexedDB error: ' + event.target.errorCode);
        };
      });
    }

    async function saveImage(imageBlob) {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['temp_images'], 'readwrite');
        const store = transaction.objectStore('temp_images');
        const request = store.put({ id: 'last_photo', blob: imageBlob });
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject('Failed to save image: ' + event.target.error);
      });
    }

    async function readImage() {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['temp_images'], 'readonly');
        const store = transaction.objectStore('temp_images');
        const request = store.get('last_photo');
        request.onsuccess = (event) => {
          resolve(event.target.result ? event.target.result.blob : null);
        };
        request.onerror = (event) => reject('Failed to read image: ' + event.target.error);
      });
    }

    async function clearImage() {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['temp_images'], 'readwrite');
        const store = transaction.objectStore('temp_images');
        const request = store.delete('last_photo');
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject('Failed to clear image: ' + event.target.error);
      });
    }

    /**
     * Loads all meal data from Firebase Firestore for authenticated users
     * Handles both authenticated (Firebase) and guest (localStorage) users
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function loadMealsFromFirestore() {
      if (!auth.currentUser) return;
      const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('meals').orderBy("timestamp", "desc").get();
      allMeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (allMeals.length > 0) dashboard.classList.remove('hidden');
      syncToggleDashboardButton();
      updateDashboard(activePeriod);
    }

    /**
     * Loads meal data from localStorage for guest users
     *
     */
    function loadMealsFromStorage() {
      const storedMeals = localStorage.getItem('guestMeals');
      allMeals = storedMeals ? JSON.parse(storedMeals) : [];
      if (allMeals.length > 0) dashboard.classList.remove('hidden');
      syncToggleDashboardButton();
      updateDashboard(activePeriod);
    }

    /**
     * Saves meal data to localStorage for guest users
     *
     */
    function saveMealsToStorage() {
      localStorage.setItem('guestMeals', JSON.stringify(allMeals));
    }

    /**
     * Updates the dashboard toggle button text based on dashboard visibility state
     *
     */
    function syncToggleDashboardButton() {
      const isHidden = dashboard.classList.contains('hidden');
      const currentLang = localStorage.getItem('language') || 'en';
      const buttonTextSpan = toggleDashboardBtn.querySelector('span');
      buttonTextSpan.textContent = isHidden ? translations[currentLang].viewDashboard : translations[currentLang].hideDashboard;
      buttonTextSpan.setAttribute('data-lang-key', isHidden ? 'viewDashboard' : 'hideDashboard');
    }

    //feedback nudge

    let feedbackBlock = false
    const feedbackModalBlock = document.getElementById('feedbackModalBlock');
    feedbackModalBlock.addEventListener('change', () => {
      if (feedbackModalBlock.checked) {
        feedbackBlock = true
      } else {
        feedbackBlock = false
      }
    });

    /**
     * Main function to process and analyze a new meal entry with AI nutrition analysis
     * Uses Google Gemini AI for food recognition and nutrition analysis
     *
     * @param {Object} mealData [Optional] - The mealdata parameter
     * @param {any} bypassQuantityCheck [Optional] - The bypassquantitycheck parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function processNewMeal(mealData = null, bypassQuantityCheck = false) {
      console.log("Analyse Meal process started. Bypass check:", bypassQuantityCheck);

      if (!navigator.onLine) {
        showOfflineModal();
        return;
      }

      let query = foodInput.value.trim();

      if (mealData) {
        query = getTranslatedFoodName(mealData.food);
      }

      if (!query) {
        await showAlert("Please enter a meal to analyse.");
        return;
      }

      const hasNumber = /\d/.test(query);
      const isKnownFood = foodKeyReverseMap[query.toLowerCase()] !== undefined;

      if (!bypassQuantityCheck && !mealData && !hasNumber && !isKnownFood) {
        openQuantitySpecModal(query);
        return;
      }

      showLoader('analysing');
      try {
        const nutritionData = mealData ? mealData : await getNutritionalInfo(query);
        if (!nutritionData) throw new Error("Could not retrieve nutritional data.");

        const mealType = document.querySelector('.meal-type-btn.active')?.dataset.type || 'Snack';
        const newMeal = {
          ...nutritionData,
          mealType,
          timestamp: new Date().toISOString()
        };
        await saveMeal(newMeal);
        foodInput.value = '';
        currentDate = new Date();
        activePeriod = 'day';

        if (dashboard.classList.contains('hidden')) {
          dashboard.classList.remove('hidden');
          syncToggleDashboardButton();
        }
      } catch (error) {
        if (error.message === "RATE_LIMIT_EXCEEDED") {
          showAlert(translations[localStorage.getItem('language') || 'en'].rateLimitError);
        } else {
          console.error('Error processing new meal:', error);
          await showAlert('Could not analyse meal. Please try again.');
        }
      } finally {
        updateDashboard(activePeriod);
        hideLoader();
        if (!dashboard.classList.contains('hidden')) {
          setTimeout(() => dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
        }

        setTimeout(() => {
          if (!feedbackBlock) {
            openFeedbackModal();
          }
        }, 5000);
      }
    }

    /**
     * Uses Google Gemini Vision API to identify food items from uploaded images
     * Uses Google Gemini AI for food recognition and nutrition analysis
     *
     * @param {Object} base64ImageData - The base64imagedata parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @throws {Error} When API request fails or rate limit is exceeded
     * @async
     */
    async function identifyFoodFromImage(imageData) {
      let base64ImageData;
      if (imageData instanceof Blob) {
        base64ImageData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(imageData);
        });
      } else {
        base64ImageData = imageData;
      }

      try {
        const response = await fetch('/api/gemini/identifyfood/v1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageData: base64ImageData })
        });
        const result = await response.json().catch(() => ({}));
        if (response.status === 429) throw new Error("RATE_LIMIT_EXCEEDED");
        if (!response.ok) throw new Error(result.error || `API request failed with status ${response.status}`);
        const foodName = result.foodName;
        if (!foodName) return null;
        return foodName.toLowerCase().includes('not food') ? null : foodName;
      } catch (error) {
        console.error("Error fetching from Gemini Vision API:", error);
        if (error.message === "RATE_LIMIT_EXCEEDED") throw error;
        return null;
      } finally {
        if (imageData instanceof Blob) imageData = null;
      }
    }

    /**
     * Gets nutritional information for food items using Google Gemini API
     * Uses Google Gemini AI for food recognition and nutrition analysis
     *
     * @param {any} prompt - The prompt parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @throws {Error} When API request fails or rate limit is exceeded
     * @async
     */
    // Example function for sending a prompt to the nutrition analysis API route
    async function getNutritionalInfo(prompt) {
      try {
        const response = await fetch('/api/gemini/getnutriinfo/v1', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ "prompt": prompt })
        });

        // Handle HTTP errors
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Request failed');
        }

        // Parse successful result
        const result = await response.json();
        console.log(result); // will contain { food, calories, protein, fat, carbs }
        return result;
      } catch (error) {
        console.error(error.message);
      }
    }

    /**
     * Updates the entire dashboard with filtered meal data and nutritional summaries
     *
     * @param {string} period - The period parameter
     */
    function updateDashboard(period) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
      updatePeriodTitleAndNav();
      const periodMeals = filterMealsByPeriod(period);
      const totals = calculateTotals(periodMeals);
      updateTotalsCard(totals);
      renderMealList(periodMeals);
      provideNutritionalAdvice(periodMeals);
      const currentLang = localStorage.getItem('language') || 'en';
      if (isDetailedView) {
        detailedDashboardView.classList.remove('hidden');
        toggleDetailsBtn.textContent = translations[currentLang].closeDetails;
        toggleDetailsBtn.setAttribute('data-lang-key', 'closeDetails');
        renderCharts(periodMeals, period, totals);
      } else {
        detailedDashboardView.classList.add('hidden');
        toggleDetailsBtn.textContent = translations[currentLang].showDetails;
        toggleDetailsBtn.setAttribute('data-lang-key', 'showDetails');
      }
    }

    /**
     * Renders the list of meals with delete and favorite functionality
     *
     * @param {any} meals - The meals parameter
     */
    function renderMealList(meals) {
      // Empty the list first.
      mealList.innerHTML = '';
      const currentLang = localStorage.getItem('language') || 'en';

      if (meals.length === 0) {
        // ▼▼▼ Processing when the list is empty. ▼▼▼
        // Add classes for centring and remove classes for stacking
        mealList.classList.add('flex', 'justify-center', 'items-center');
        mealList.classList.remove('space-y-4');

        // Display messages in a centred container.
        mealList.innerHTML = `<p id="no-meals-message" class="text-gray-500 text-center" data-lang-key="noMeals">${translations[currentLang].noMeals}</p>`;

      } else {
        // ▼▼▼ Processing when the list has contents. ▼▼▼
        // Remove classes for centring and restore classes for stacking
        mealList.classList.remove('flex', 'justify-center', 'items-center');
        mealList.classList.add('space-y-4');

        meals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        meals.forEach(data => {
          const mealElement = document.createElement('div');
          const mealTypeColor = { Breakfast: 'bg-blue-100 text-blue-800', Lunch: 'bg-green-100 text-green-800', Dinner: 'bg-purple-100 text-purple-800', Snack: 'bg-yellow-100 text-yellow-800' };
          const isFavourited = favouriteMeals.some(fav => fav.food.toLowerCase() === data.food.toLowerCase());
          mealElement.className = 'bg-white p-4 border border-gray-200 rounded-lg';
          mealElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800 capitalize">${getTranslatedFoodName(data.food)}</h3>
                    <div class="flex items-center gap-2">
                        <div class="favourite-star-container">
                            <span class="favourite-star ${isFavourited ? 'favourited' : 'text-gray-400 hover:text-yellow-400'}" title="Add to favourites">
                                <svg class="w-6 h-6 sm:w-5 sm:h-5" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                            </span>
                        </div>
                        <button data-id="${data.id}" class="delete-meal-btn text-xl sm:text-lg font-bold text-red-500 hover:text-red-700 w-8 h-8 sm:w-6 sm:h-6 flex items-center justify-center rounded-full hover:bg-red-100" title="Delete">&times;</button>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-1">
                    <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleString('en-US')}</p>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap ${mealTypeColor[data.mealType] || mealTypeColor.Snack}">${translations[currentLang][data.mealType.toLowerCase()] || data.mealType}</span>
                </div>
                <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                    <div><strong data-lang-key="calories">${translations[currentLang].calories}:</strong> ${Math.round(data.calories)}</div>
                    <div><strong data-lang-key="protein">${translations[currentLang].protein}:</strong> ${data.protein.toFixed(1)}g</div>
                    <div><strong data-lang-key="fat">${translations[currentLang].fat}:</strong> ${data.fat.toFixed(1)}g</div>
                    <div><strong data-lang-key="carbs">${translations[currentLang].carbs}:</strong> ${data.carbs.toFixed(1)}g</div>
                </div>
            `;

          mealElement.querySelector('.favourite-star').addEventListener('click', (e) => toggleFavourite(data, e.currentTarget));

          mealElement.querySelector('.delete-meal-btn').addEventListener('click', async () => {
            const currentLang = localStorage.getItem('language') || 'en';
            if (await showConfirm(translations[currentLang].removeMealConfirm)) {
              await deleteMeal(data.id);
            }
          });

          mealList.appendChild(mealElement);
        });
      }
    }

    /**
     * Resets all user data including meals and favorites with confirmation
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function resetAllData() {
      settingsModal.close();

      const currentLang = localStorage.getItem('language') || 'en';
      if (!await showConfirm(translations[currentLang].deleteAllDataConfirm)) return;

      showLoader('deletingData');
      if (auth.currentUser) {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('meals').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      } else localStorage.removeItem('guestMeals');
      allMeals = [];
      dashboard.classList.add('hidden');
      updateDashboard(activePeriod);
      hideLoader();
    }

    /**
     * Resets only today's meal data with confirmation
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function resetTodayData() {
      const currentLang = localStorage.getItem('language') || 'en';
      if (!await showConfirm(translations[currentLang].deleteTodayConfirm)) return;

      showLoader('deletingData');

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const endOfToday = new Date();
      endOfToday.setHours(23, 59, 59, 999);

      // Separate meals to be deleted from those to be retained.
      const mealsToDelete = allMeals.filter(meal => {
        const mealDate = new Date(meal.timestamp);
        return mealDate >= today && mealDate <= endOfToday;
      });
      const mealsToKeep = allMeals.filter(meal => {
        const mealDate = new Date(meal.timestamp);
        return mealDate < today || mealDate > endOfToday;
      });

      if (mealsToDelete.length === 0) {
        hideLoader();
        return; // No data to delete.
      }

      if (auth.currentUser) {
        const batch = db.batch();
        mealsToDelete.forEach(meal => {
          const mealRef = db.collection('users').doc(auth.currentUser.uid).collection('meals').doc(meal.id);
          batch.delete(mealRef);
        });
        await batch.commit();
      }

      // Update the local array and save it for guests
      allMeals = mealsToKeep;
      if (!auth.currentUser) {
        saveMealsToStorage();
      }

      // Updated UI.
      updateDashboard(activePeriod);
      hideLoader();
    }

    /**
     * Analyzes meal data and provides personalized nutrition advice
     *
     * @param {any} periodMeals - The periodmeals parameter
     */
    async function provideNutritionalAdvice(periodMeals) {
      const adviceCard = document.getElementById('advice-card'), adviceIcon = document.getElementById('advice-icon'), adviceText = document.getElementById('advice-text'), adviceFood = document.getElementById('advice-food'), currentLang = localStorage.getItem('language') || 'en';
      if (periodMeals.length === 0) { adviceCard.classList.add('hidden'); return; }
      
      const showAdvice = (message, isBalanced, foodSuggestion) => {
        adviceText.textContent = message;
        if (foodSuggestion) {
          adviceFood.textContent = foodSuggestion;
          adviceFood.classList.remove('hidden');
        } else {
          adviceFood.textContent = '';
          adviceFood.classList.add('hidden');
        }
        adviceCard.classList.remove('hidden');
        if (isBalanced) {
          adviceCard.className = 'p-6 rounded-xl shadow-sm bg-green-50 border-l-4 border-green-400';
          adviceIcon.textContent = '✅';
        } else {
          adviceCard.className = 'p-6 rounded-xl shadow-sm bg-yellow-50 border-l-4 border-yellow-400';
          adviceIcon.textContent = '💡';
        }
      };

      const sortedMeals = [...periodMeals].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const lastMeal = sortedMeals[0];
      const totals = calculateTotals(periodMeals);
      const mealOrder = ['Breakfast', 'Lunch', 'Dinner'];
      const lastMealIndex = mealOrder.indexOf(lastMeal?.mealType);
      const nextMealTypeKey = lastMealIndex !== -1 && lastMealIndex < 2 ? mealOrder[lastMealIndex + 1].toLowerCase() : 'nextMeal';
      const nextMealTranslated = translations[currentLang][nextMealTypeKey] || translations[currentLang].nextMeal;

      try {
        const response = await fetch('/api/gemini/nutritionadvice/v1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            totals,
            meals: periodMeals.slice(-5).map(({ mealType, calories, protein, fat, carbs, timestamp }) => ({
              mealType,
              calories,
              protein,
              fat,
              carbs,
              timestamp
            })),
            nextMealType: nextMealTypeKey,
            nextMealLabel: nextMealTranslated,
            language: currentLang
          })
        });

        if (response.status === 429) throw new Error('RATE_LIMIT_EXCEEDED');
        if (!response.ok) throw new Error('FAILED');

        const adviceResult = await response.json();
        if (adviceResult?.advice) {
          showAdvice(adviceResult.advice, adviceResult.status === 'balanced', adviceResult.foodSuggestion);
          return;
        }
      } catch (error) {
        console.error('Gemini nutrition advice failed, falling back to local copy:', error);
      }

      const proteinCalories = totals.protein * 4, fatCalories = totals.fat * 9, totalCalories = proteinCalories + fatCalories + (totals.carbs * 4);
      let suggestionKey = '', isBalanced = true;
      if (totalCalories > 0) {
        const proteinPercentage = (proteinCalories / totalCalories) * 100, fatPercentage = (fatCalories / totalCalories) * 100;
        if (proteinPercentage < 15) { suggestionKey = 'adviceLowProtein'; isBalanced = false; }
        else if (fatPercentage > 35) { suggestionKey = 'adviceHighFat'; isBalanced = false; }
        else suggestionKey = 'adviceBalanced';
      } else suggestionKey = 'adviceStart';
      
      const messageTemplate = translations[currentLang][suggestionKey] || '';
      const fallbackFoodTemplate = translations[currentLang][`${suggestionKey}Food`] || '';
      const message = messageTemplate.replace('{nextMeal}', nextMealTranslated);
      const fallbackFood = fallbackFoodTemplate ? fallbackFoodTemplate.replace('{nextMeal}', nextMealTranslated) : '';
      showAdvice(message, isBalanced, fallbackFood);
    }

    /**
     * Updates the nutrition totals display card with calculated values
     *
     * @param {any} totals - The totals parameter
     */
    function updateTotalsCard(totals) {
      document.getElementById('total-calories').textContent = Math.round(totals.calories);
      document.getElementById('total-protein').textContent = `${totals.protein.toFixed(1)} g`;
      document.getElementById('total-fat').textContent = `${totals.fat.toFixed(1)} g`;
      document.getElementById('total-carbs').textContent = `${totals.carbs.toFixed(1)} g`;
    }

    /**
     * Updates period title and navigation button states
     *
     */
    function updatePeriodTitleAndNav() {
      const lang = localStorage.getItem('language') || 'en', today = new Date();
      today.setHours(0, 0, 0, 0);
      let title = '', isFuture = false;
      if (activePeriod === 'day') {
        title = (currentDate.toDateString() === today.toDateString()) ? translations[lang].today : currentDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        isFuture = currentDate > today;
      } else if (activePeriod === 'week') {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - startOfWeek.getDay());
        startOfWeek.setHours(0, 0, 0, 0);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);
        const options = { month: 'short', day: 'numeric' };
        const startStr = startOfWeek.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { ...options, year: (startOfWeek.getFullYear() !== endOfWeek.getFullYear() ? 'numeric' : undefined) });
        const endStr = endOfWeek.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { ...options, year: 'numeric' });
        title = `${startStr} - ${endStr}`;
        isFuture = startOfWeek > today;
      } else if (activePeriod === 'month') {
        title = currentDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'long' });
        const firstDayOfNextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        isFuture = firstDayOfNextMonth > today;
      }
      periodTitle.textContent = title;
      nextPeriodBtn.disabled = isFuture;
    }

    /**
     * Renders appropriate charts (gauges/bar charts) based on selected time period
     * Uses Chart.js library for data visualization
     *
     * @param {any} periodMeals - The periodmeals parameter
     * @param {string} period - The period parameter
     * @param {any} totals - The totals parameter
     */
    function renderCharts(periodMeals, period, totals) {
      if (periodChart) periodChart.destroy();
      if (calorieGaugeChart) calorieGaugeChart.destroy();
      if (nutritionChart) nutritionChart.destroy();
      const currentLang = localStorage.getItem('language') || 'en';
      if (period === 'day') {
        chartsGrid.classList.remove('grid-cols-1');
        chartsGrid.classList.add('md:grid-cols-2');
        mainChartWrapper.classList.remove('md:col-span-2');
        nutritionBalanceWrapper.classList.remove('hidden');
        calorieGaugeChartEl.classList.remove('hidden');
        barChartContainer.classList.add('hidden');
        nutritionChartEl.classList.remove('hidden');
        nutritionBalanceTextEl.classList.add('hidden');
        smallGaugesContainer.classList.remove('hidden');
        periodGoalText.classList.add('hidden');
        periodActualText.classList.add('hidden');
        dynamicChartTitle.textContent = translations[currentLang].todaysCalories;
        renderAllGauges(totals, period);
        renderNutritionChart(totals);
      } else {
        chartsGrid.classList.add('grid-cols-1');
        chartsGrid.classList.remove('md:grid-cols-2');
        mainChartWrapper.classList.add('md:col-span-2');
        calorieGaugeChartEl.classList.add('hidden');
        barChartContainer.classList.remove('hidden');
        nutritionChartEl.classList.add('hidden');
        nutritionBalanceTextEl.classList.remove('hidden');
        smallGaugesContainer.classList.add('hidden');
        nutritionBalanceWrapper.classList.remove('hidden');
        periodGoalText.classList.remove('hidden');
        periodActualText.classList.remove('hidden');
        renderBarChart(period, periodMeals);
        renderNutritionBalanceText(totals, period);
      }
    }

    /**
     * Renders bar chart for weekly/monthly calorie intake visualization
     * Uses Chart.js library for data visualization
     *
     * @param {string} period - The period parameter
     * @param {any} periodMeals - The periodmeals parameter
     */
    function renderBarChart(period, periodMeals) {
      if (periodChart) periodChart.destroy();
      const currentLang = localStorage.getItem('language') || 'en';
      let chartData, chartLabels, periodMultiplier, goalPerUnit;
      if (period === 'week') {
        dynamicChartTitle.textContent = translations[currentLang].thisWeeksTotals;
        chartLabels = [translations[currentLang].sun, translations[currentLang].mon, translations[currentLang].tue, translations[currentLang].wed, translations[currentLang].thu, translations[currentLang].fri, translations[currentLang].sat];
        const dailyTotals = Array(7).fill(0);
        periodMeals.forEach(meal => { dailyTotals[new Date(meal.timestamp).getDay()] += meal.calories; });
        chartData = dailyTotals;
        periodMultiplier = 7;
        goalPerUnit = userGoals.calories;
      } else {
        dynamicChartTitle.textContent = translations[currentLang].thisMonthsTotals;
        const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const numWeeks = Math.ceil((startOfMonth.getDay() + endOfMonth.getDate()) / 7);
        chartLabels = Array.from({ length: numWeeks }, (_, i) => `${translations[currentLang].week} ${i + 1}`);
        const weeklyTotals = Array(numWeeks).fill(0);
        periodMeals.forEach(meal => { const weekIndex = Math.floor((startOfMonth.getDay() + new Date(meal.timestamp).getDate() - 1) / 7); weeklyTotals[weekIndex] += meal.calories; });
        chartData = weeklyTotals;
        periodMultiplier = endOfMonth.getDate();
        goalPerUnit = userGoals.calories * 7;
      }
      const periodGoal = userGoals.calories * periodMultiplier, totalPeriodCalories = periodMeals.reduce((sum, meal) => sum + meal.calories, 0);
      periodGoalText.textContent = `${translations[currentLang].periodGoal}: ${Math.round(periodGoal)} kcal`;
      periodActualText.textContent = `${translations[currentLang].actualIntake}: ${Math.round(totalPeriodCalories)} kcal`;
      periodActualText.classList.remove('text-green-600', 'text-red-600');
      periodActualText.classList.add(totalPeriodCalories <= periodGoal ? 'text-green-600' : 'text-red-600');
      const withinGoalData = chartData.map(total => Math.min(total, goalPerUnit));
      const overGoalData = chartData.map(total => Math.max(0, total - goalPerUnit));
      periodChart = new Chart(periodBarChartEl.getContext('2d'), {
        type: 'bar',
        data: { labels: chartLabels, datasets: [{ label: 'Within Goal', data: withinGoalData, backgroundColor: '#3b82f6', borderRadius: 2 }, { label: 'Over Goal', data: overGoalData, backgroundColor: '#ef4444', borderRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
      });
    }

    /**
     * Renders text-based nutrition balance information for longer periods
     *
     * @param {any} totals - The totals parameter
     * @param {string} period - The period parameter
     */
    function renderNutritionBalanceText(totals, period) {
      const lang = localStorage.getItem('language') || 'en';
      let periodMultiplier = (period === 'week') ? 7 : (period === 'month') ? new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() : 1;
      const proteinGoal = Math.round(userGoals.protein * periodMultiplier), fatGoal = Math.round(userGoals.fat * periodMultiplier), carbsGoal = Math.round(userGoals.carbs * periodMultiplier);
      nutritionBalanceTextEl.innerHTML = `<div class="mt-4 space-y-3 text-gray-700 text-base"><div class="flex justify-between items-center bg-green-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="protein">${translations[lang].protein}</span><span class="font-mono">${totals.protein.toFixed(0)}g / ${proteinGoal}g</span></div><div class="flex justify-between items-center bg-orange-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="fat">${translations[lang].fat}</span><span class="font-mono">${totals.fat.toFixed(0)}g / ${fatGoal}g</span></div><div class="flex justify-between items-center bg-red-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="carbs">${translations[lang].carbs}</span><span class="font-mono">${totals.carbs.toFixed(0)}g / ${carbsGoal}g</span></div></div>`;
    }

    /**
     * Renders doughnut chart showing protein/fat/carbs distribution
     *
     * @param {any} totals - The totals parameter
     */
    function renderNutritionChart(totals) {
      const ctx = document.getElementById('nutrition-chart').getContext('2d'), { protein, fat, carbs } = totals, totalPFC = protein + fat + carbs, currentLang = localStorage.getItem('language') || 'en';
      if (nutritionChart) nutritionChart.destroy();
      if (totalPFC === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
      nutritionChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [`${translations[currentLang].protein} (${((protein / totalPFC) * 100 || 0).toFixed(0)}%)`, `${translations[currentLang].fat} (${((fat / totalPFC) * 100 || 0).toFixed(0)}%)`, `${translations[currentLang].carbs} (${((carbs / totalPFC) * 100 || 0).toFixed(0)}%)`], datasets: [{ data: [protein, fat, carbs], backgroundColor: ['#22c55e', '#f97316', '#ef4444'], borderColor: '#fff' }] },
        options: {
          responsive: true, plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12 } }, tooltip: {
              callbacks: { /**
  * Handles label functionality
  *
  * @param {any} c - The c parameter
  */
                label: (c) => `${c.label.split('(')[0].trim()}: ${c.parsed.toFixed(1)}g`
              }
            }
          }
        }
      });
    }

    /**
     * Renders all nutrition gauge charts for daily view
     *
     * @param {any} totals - The totals parameter
     * @param {string} period - The period parameter
     */
    function renderAllGauges(totals, period) {
      if (period !== 'day') return;
      renderGaugeChart('calorie-gauge-chart', calorieGaugeChart, totals.calories, userGoals.calories, 'kcal', (chartInstance) => { calorieGaugeChart = chartInstance; });
      renderGaugeChart('protein-gauge-chart', proteinGaugeChart, totals.protein, userGoals.protein, 'g', (chartInstance) => { proteinGaugeChart = chartInstance; }, '#22c55e');
      renderGaugeChart('fat-gauge-chart', fatGaugeChart, totals.fat, userGoals.fat, 'g', (chartInstance) => { fatGaugeChart = chartInstance; }, '#f97316');
      renderGaugeChart('carbs-gauge-chart', carbsGaugeChart, totals.carbs, userGoals.carbs, 'g', (chartInstance) => { carbsGaugeChart = chartInstance; }, '#ef4444');
    }

    /**
     * Renders individual gauge chart for specific nutrition metric
     * Uses Chart.js library for data visualization
     *
     * @param {string} canvasId - The canvasid parameter
     * @param {any} chartInstance - The chartinstance parameter
     * @param {any} currentValue - The currentvalue parameter
     * @param {any} goalValue - The goalvalue parameter
     * @param {any} unit - The unit parameter
     * @param {any} setChartInstance - The setchartinstance parameter
     * @param {any} color [Optional] - The color parameter
     */
    function renderGaugeChart(canvasId, chartInstance, currentValue, goalValue, unit, setChartInstance, color = '#8b5cf6') {
      const canvasEl = document.getElementById(canvasId);
      if (!canvasEl) return;
      const ctx = canvasEl.getContext('2d'), current = Math.round(currentValue), goal = Math.round(goalValue), remaining = Math.max(0, goal - current), percentage = Math.round((current / goal) * 100 || 0);
      if (chartInstance) chartInstance.destroy();
      const newChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { datasets: [{ data: [current, remaining], backgroundColor: [current > goal ? '#dc2626' : color, '#e2e8f0'], borderColor: '#fff', borderWidth: 2, circumference: 180, rotation: 270, }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }, tooltip: { enabled: false } }, cutout: '70%', },
        plugins: [{
          id: 'gaugeText',
          /**
           * Handles afterdraw functionality
           *
           * @param {any} chart - The chart parameter
           */
          afterDraw: (chart) => {
            const { ctx, chartArea: { top, width, height } } = chart;
            ctx.save();
            const x = width / 2, y = top + (height / 1.2), isMobile = window.innerWidth < 640, isCalorieGauge = canvasId === 'calorie-gauge-chart';
            let percentageFontSize = isCalorieGauge ? (isMobile ? (percentage >= 100 ? '1.5rem' : '1.75rem') : (percentage >= 100 ? '2.25rem' : '3rem')) : (percentage >= 100 ? '1.25rem' : '1.5rem');
            const detailsFontSize = isCalorieGauge ? (isMobile ? '0.875rem' : '1rem') : '0.75rem', ySpacing = isCalorieGauge ? (isMobile ? 3 : 5) : 2;
            ctx.font = `bold ${percentageFontSize} Inter`;
            ctx.fillStyle = current > goal ? '#dc2626' : '#1e293b';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(`${percentage}%`, x, y - ySpacing);
            ctx.font = `${detailsFontSize} Inter`;
            ctx.fillStyle = '#64748b';
            ctx.textBaseline = 'top';
            ctx.fillText(`${current} / ${goal} ${unit}`, x, y + ySpacing);
            ctx.restore();
          }
        }]
      });
      setChartInstance(newChartInstance);
    }

    /**
     * Calculates total nutrition values from an array of meals
     *
     * @param {any} meals - The meals parameter
     */
    function calculateTotals(meals) {
      return meals.reduce((acc, meal) => ({
        calories: acc.calories + (meal.calories || 0), protein: acc.protein + (meal.protein || 0),
        fat: acc.fat + (meal.fat || 0), carbs: acc.carbs + (meal.carbs || 0)
      }), { calories: 0, protein: 0, fat: 0, carbs: 0 });
    }

    /**
     * Filters meals array by specified time period (day/week/month)
     *
     * @param {string} period - The period parameter
     * @returns {any} The function return value
     */
    function filterMealsByPeriod(period) {
      const start = new Date(currentDate), end = new Date(currentDate);
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      if (period === 'week') {
        const dayOfWeek = start.getDay();
        start.setDate(start.getDate() - dayOfWeek);
        end.setDate(start.getDate() + 6);
      } else if (period === 'month') {
        start.setDate(1);
        end.setMonth(end.getMonth() + 1);
        end.setDate(0);
      }
      return allMeals.filter(meal => { const mealDate = new Date(meal.timestamp); return mealDate >= start && mealDate <= end; });
    }

    //calendar related code

    /**
     * Navigates between different time periods (day/week/month) in the dashboard
     *
     * @param {any} direction - The direction parameter
     */
    function navigatePeriod(direction) {
      const newDate = new Date(currentDate);
      if (activePeriod === 'day') {
        newDate.setDate(newDate.getDate() + direction);
      }
      else if (activePeriod === 'week') {
        newDate.setDate(newDate.getDate() + (7 * direction));
      }
      else if (activePeriod === 'month') {
        newDate.setMonth(newDate.getMonth() + direction);
      }
      currentDate = newDate;
      updateDashboard(activePeriod);
    }

    const prevPeriodBtn = document.getElementById('prev-period-btn');
    const nextPeriodBtn = document.getElementById('next-period-btn');
    prevPeriodBtn.addEventListener('click', () => navigatePeriod(-1));
    nextPeriodBtn.addEventListener('click', () => navigatePeriod(1));

    const periodTitleContainer = document.getElementById('period-title-container');
    periodTitleContainer.addEventListener('click', () => {
      chooseFromNativeCalendar(new Date(currentDate));
    });

    /**
     * Renders calendar widget for date/period selection
     *
     * @param {any} date - The date parameter
     * @returns {any} The rendered or created element/data
     */
    function chooseFromNativeCalendar(date) {
      const year = date.getFullYear();
      const humanMonth = date.getMonth() + 1;
      const week = date.getWeek();
      if (activePeriod === 'month') {
        const calendarMonthInput = document.getElementById("calendar-month-input");
        calendarMonthInput.value = `${year}-${humanMonth}`;
        if (typeof calendarMonthInput.showPicker === "function") {
          calendarMonthInput.showPicker();
        } else {
          calendarMonthInput.click();
        }
        calendarMonthInput.addEventListener('input', function (event) {
          currentDate = new Date(event.target.value + "-01");
          updateDashboard('month');
        });

      }
      else if (activePeriod === "week") {
        const calendarWeekInput = document.getElementById("calendar-week-input");
        calendarWeekInput.value = `${year}-W${week}`;
        if (typeof calendarWeekInput.showPicker === "function") {
          calendarWeekInput.showPicker();
        } else {
          calendarWeekInput.click();
        }
        calendarWeekInput.addEventListener('input', function (event) {
          currentDate = getStartDateOfISOWeek(event.target.value);
          const startOfWeek = new Date(currentDate);
          startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
          startOfWeek.setHours(0, 0, 0, 0);
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(endOfWeek.getDate() + 6);
          updateDashboard('week');
        })
      } else {
        const calendarDateInput = document.getElementById("calendar-date-input");
        calendarDateInput.value = date;
        if (typeof calendarDateInput.showPicker === "function") {
          calendarDateInput.showPicker();
        } else {
          calendarDateInput.click();
        }
        calendarDateInput.addEventListener('input', function (event) {
          currentDate = new Date(event.target.value);
          updateDashboard('date');
        })
      }
    }

    Date.prototype.getWeek = function () {
      var date = new Date(this.getTime());
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + 4 - (date.getDay() || 7));
      var yearStart = new Date(date.getFullYear(), 0, 1);
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    };

    function getStartDateOfISOWeek(isoWeekStr) {
      const [yearStr, weekStr] = isoWeekStr.split('-W');
      const year = parseInt(yearStr, 10);
      const week = parseInt(weekStr, 10);

      // January 4th is always in week 1 under ISO 8601
      const simple = new Date(year, 0, 4);
      // Get the Monday of week 1
      const dayOfWeek = simple.getDay() || 7; // 1 (Mon) - 7 (Sun)
      const mondayOfWeek1 = new Date(simple);
      mondayOfWeek1.setDate(simple.getDate() - dayOfWeek + 1);
      // Compute offset for desired week
      const mondayOfTargetWeek = new Date(mondayOfWeek1);
      mondayOfTargetWeek.setDate(mondayOfWeek1.getDate() + (week - 1) * 7);
      return mondayOfTargetWeek;
    }

    /**

     * Initializes and starts barcode scanner using device camera

     *

     */

    function startBarcodeScanner() {
      const barcodeModal = document.getElementById('barcode-modal');
      barcodeModal.showModal();

      const qrRegionId = "html5-qrcode-barcode";

      if (html5QrCodeInstance) {
        html5QrCodeInstance.stop().then(() => {
          html5QrCodeInstance.clear();
          html5QrCodeInstance = null;
          startBarcodeScanner();
        });
        return;
      }

      html5QrCodeInstance = new Html5Qrcode(qrRegionId);
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          html5QrCodeInstance.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 300, height: 150 },
              aspectRatio: 1.0
            },
            (decodedText, decodedResult) => {
              // Barcode scanned successfully
              html5QrCodeInstance.stop().then(() => {
                barcodeModal.close();
                html5QrCodeInstance.clear();
                html5QrCodeInstance = null;
                processBarcode(decodedText);
              });
            },
            (errorMessage) => {
              // Ignore scan errors (typical with QR/barcode libs)
            }
          ).catch(err => {
            showAlert('Could not start camera: ' + err);
            barcodeModal.close();
          });
        } else {
          showAlert('No camera found.');
          barcodeModal.close();
        }
      }).catch(err => {
        showAlert('Camera initialization error: ' + err);
        barcodeModal.close();
      });
    }

    /**
     * Processes scanned barcode and fetches product information
     *
     * @param {any} barcode - The barcode parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function processBarcode(barcode) {
      const currentLang = localStorage.getItem('language') || 'en';
      showLoader(translations[currentLang].barcodeLookup.replace('{barcode}', barcode));
      const productData = await fetchProductFromAPI(barcode);
      hideLoader();
      if (productData) {
        currentScannedProduct = productData;
        servingProductName.textContent = productData.food;
        servingModal.showModal();
      } else showAlert(`Product with barcode ${barcode} not found in the database.`);
    }

    /**
     * Fetches product nutrition data from OpenFoodFacts API using barcode
     *
     * @param {any} barcode - The barcode parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @throws {Error} When API request fails or rate limit is exceeded
     * @async
     */
    async function fetchProductFromAPI(barcode) {
      try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
        const data = await response.json();
        if (data.status === 1 && data.product) {
          const p = data.product, nutriments = p.nutriments;
          return { food: p.product_name || 'Unknown Product', calories_100g: nutriments['energy-kcal_100g'] || 0, protein_100g: nutriments.proteins_100g || 0, fat_100g: nutriments.fat_100g || 0, carbs_100g: nutriments.carbohydrates_100g || 0, };
        }
        return null;
      } catch (error) { console.error("Error fetching product data:", error); return null; }
    }

    /**
     * Toggles the favourite status of a meal with visual feedback animation
     *
     * @param {Object} mealData - The mealdata parameter
     * @param {HTMLElement} starElement - The starElement parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function toggleFavourite(mealData, starElement) {
      if (starElement) {
        starElement.classList.add('star-pop');
        const container = starElement.parentElement;
        if (container) {
          container.classList.add('sparkling');
          container.addEventListener('animationend', () => container.classList.remove('sparkling'), { once: true });
        }
        starElement.addEventListener('animationend', () => starElement.classList.remove('star-pop'), { once: true });
      }
      const favIndex = favouriteMeals.findIndex(fav => fav.food.toLowerCase() === mealData.food.toLowerCase());
      if (favIndex > -1) {
        const favId = favouriteMeals[favIndex].id;
        favouriteMeals.splice(favIndex, 1);
        if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('favourites').doc(favId).delete();
      } else {
        const { food, calories, protein, fat, carbs } = mealData;
        const newFav = { food, calories, protein, fat, carbs };
        if (auth.currentUser) {
          const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('favourites').add(newFav);
          newFav.id = docRef.id;
        } else newFav.id = Date.now();
        favouriteMeals.push(newFav);
      }
      saveFavouritesToStorage();
      renderMealList(filterMealsByPeriod(activePeriod));
    }

    /**
     * Removes a meal from favorites list with confirmation
     * @param {string} favId - The favid parameter
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function removeFavourite(favId) {
      const favIndex = favouriteMeals.findIndex(fav => fav.id.toString() === favId.toString());
      if (favIndex > -1) {
        favouriteMeals.splice(favIndex, 1);
        if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('favourites').doc(favId).delete();
        saveFavouritesToStorage();
        renderFavouritesList();
        renderMealList(filterMealsByPeriod(activePeriod));
      }
    }

    /**
     * Renders the list of favorite meals in the favorites modal
     *
     */
    function renderFavouritesList() {
      favouritesList.innerHTML = '';
      const currentLang = localStorage.getItem('language') || 'en';
      if (favouriteMeals.length === 0) { favouritesList.innerHTML = `<p class="text-gray-500 text-center" data-lang-key="noFavourites">${translations[currentLang].noFavourites}</p>`; return; }
      favouriteMeals.forEach(fav => {
        const favEl = document.createElement('div');
        favEl.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md';
        favEl.innerHTML = `<span class="capitalize cursor-pointer hover:text-blue-600 flex-grow text-left">${fav.food}</span><div class="flex items-center"><span class="text-xs text-gray-500 mr-4">${Math.round(fav.calories)} kcal</span><button data-id="${fav.id}" class="delete-favourite-btn text-xl font-bold text-red-400 hover:text-red-600 leading-none p-1">&times;</button></div>`;
        favEl.querySelector('span.capitalize').addEventListener('click', () => {
          processNewMeal(fav);
          favouritesModal.close();
        });
        favEl.querySelector('.delete-favourite-btn').addEventListener('click', async (e) => {
          const favId = e.currentTarget.dataset.id;
          if (await showConfirm(translations[localStorage.getItem('language') || 'en'].removeFavouriteConfirm))
            await removeFavourite(favId);
        });
        favouritesList.appendChild(favEl);
      });
    }

    /**
     * Loads favorite meals from Firebase or localStorage
     *
     * @returns {Promise} Promise that resolves when the operation completes
     * @async
     */
    async function loadFavourites() {
      if (auth.currentUser) {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('favourites').get();
        favouriteMeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } else {
        const stored = localStorage.getItem('guestFavourites');
        favouriteMeals = stored ? JSON.parse(stored) : [];
      }
    }

    /**
     * Saves favorites list to localStorage for guest users
     *
     */
    function saveFavouritesToStorage() {
      if (!auth.currentUser) localStorage.setItem('guestFavourites', JSON.stringify(favouriteMeals));
    }
    // 离线检测功能
    let isOnline = navigator.onLine;

    /**
     * Monitors online/offline status and shows appropriate UI feedback
     *
     */
    function checkOnlineStatus() {
      const wasOnline = isOnline;
      isOnline = navigator.onLine;

      if (wasOnline && !isOnline) {
        // 从在线变为离线
        showOfflineModal();
      }
    }

    /**
     * Shows offline notification modal when internet connection is lost
     *
     */
    function showOfflineModal() {
      const currentLang = localStorage.getItem('language') || 'en';
      const offlineModal = document.getElementById('offline-modal');
      const offlineTitle = offlineModal.querySelector('[data-lang-key="offlineTitle"]');
      const offlineMessage = offlineModal.querySelector('[data-lang-key="offlineMessage"]');

      offlineTitle.textContent = translations[currentLang].offlineTitle;
      offlineMessage.textContent = translations[currentLang].offlineMessage;
      offlineModal.classList.remove('hidden');
    }

    /**
     * Starts voice recognition for meal input using Web Speech API
     *
     */
    async function startVoiceRecognition() {
      const currentLang = localStorage.getItem('language') || 'en';
      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!Recognition) {
        const unsupportedMessage = translations[currentLang]?.speechUnsupported ||
          'Speech recognition is not supported in this browser. Please try using the latest Chrome, Edge, or Safari.';
        await showAlert(unsupportedMessage);
        return;
      }

      // Reset any existing recognition session
      stopVoiceRecognition();

      finalTranscript = '';
      listeningTextStatus.textContent = translations[currentLang].listening;
      listeningModal.showModal();

      if (listeningModalCloseHandler) {
        listeningModal.removeEventListener('close', listeningModalCloseHandler);
        listeningModalCloseHandler = null;
      }

      listeningModalCloseHandler = () => {
        stopVoiceRecognition();
        listeningModal.removeEventListener('close', listeningModalCloseHandler);
        listeningModalCloseHandler = null;
      };
      listeningModal.addEventListener('close', listeningModalCloseHandler);

      try {
        speechRecognitionInstance = new Recognition();
        speechRecognitionInstance.lang = currentLang === 'zh' ? 'zh-CN' : 'en-US';
        speechRecognitionInstance.continuous = true;
        speechRecognitionInstance.interimResults = true;
        speechRecognitionInstance.maxAlternatives = 1;

        speechRecognitionInstance.onresult = (event) => {
          let interimTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            const transcript = result[0]?.transcript || '';
            if (result.isFinal) {
              finalTranscript += `${transcript.trim()} `;
            } else {
              interimTranscript += transcript;
            }
          }
          const combinedTranscript = `${finalTranscript}${interimTranscript}`.trim();
          if (combinedTranscript) {
            foodInput.value = combinedTranscript;
          }
        };

        speechRecognitionInstance.onerror = async (event) => {
          if (event?.error === 'aborted') {
            return;
          }
          console.error('Speech recognition error:', event);
          const errorText = event?.error || 'unknown error';
          const messageTemplate = translations[currentLang]?.speechError || 'Could not recognize speech: {error}';
          stopVoiceRecognition();
          await showAlert(messageTemplate.replace('{error}', errorText));
        };

        speechRecognitionInstance.onend = () => {
          if (finalTranscript.trim()) {
            foodInput.value = finalTranscript.trim();
          }
          if (listeningModal.open) {
            listeningModal.close();
          }
          if (listeningModalCloseHandler) {
            listeningModal.removeEventListener('close', listeningModalCloseHandler);
            listeningModalCloseHandler = null;
          }
          speechRecognitionInstance = null;
          finalTranscript = '';
        };

        speechRecognitionInstance.start();
      } catch (error) {
        console.error('Error starting voice recognition:', error);
        let alertMessage = 'Could not start voice recognition.';
        if (error && typeof error === 'object') {
          const { name, message } = error;
          if (name === 'NotAllowedError' || name === 'SecurityError') {
            alertMessage = 'Microphone access was denied. Please allow microphone access in your browser settings.';
          } else if (name === 'NotFoundError' || name === 'OverconstrainedError') {
            alertMessage = 'No suitable microphone was found. Please check your audio input device.';
          } else if (typeof message === 'string' && message.trim().length > 0) {
            alertMessage = `Could not start voice recognition: ${message}`;
          }
        }
        await showAlert(alertMessage);
      }
    }
    function stopVoiceRecognition() {
      if (speechRecognitionInstance) {
        try {
          speechRecognitionInstance.stop();
        } catch (error) {
          console.error('Error stopping speech recognition:', error);
        }
      }

      if (listeningModalCloseHandler) {
        listeningModal.removeEventListener('close', listeningModalCloseHandler);
        listeningModalCloseHandler = null;
      }

      if (listeningModal.open) {
        listeningModal.close();
      }

      if (finalTranscript.trim()) {
        foodInput.value = finalTranscript.trim();
      }

      finalTranscript = '';
      speechRecognitionInstance = null;
    }

    // --- APPLICATION INITIALIZATION ---
    /**
     * Initializes all event listeners for the application UI components
     *
     * @returns {any} The function return value
     */
    function initializeAppEventListeners() {
      // --- General Listeners ---
      document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => setLanguage(btn.dataset.lang)));

      // For dashboard radio buttons
      document.querySelectorAll('.lang-radio').forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.checked) setLanguage(e.target.value);
        });
      });

      const infoIcon = document.getElementById('info-tooltip-icon');
      if (infoIcon) {
        infoIcon.addEventListener('click', () => {
          const currentLang = localStorage.getItem('language') || 'en';
          const infoText = translations[currentLang]?.tooltipInfo || '';
          if (infoText) {
            alert(infoText);
          }
        });
      }

      // --- Header Buttons ---
      if (signOutBtnDropdown) signOutBtnDropdown.addEventListener('click', handleSignOut);
      if (accountMenuBtn) {
        accountMenuBtn.setAttribute('aria-expanded', 'false');
        accountMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleAccountDropdown();
        });
      }
      window.addEventListener('click', (e) => {
        if (userHeader && !userHeader.contains(e.target)) {
          closeAccountDropdown();
        }
      });
      if (settingsBtn) settingsBtn.addEventListener('click', () => settingsModal.showModal());
      if (favouritesBtn) favouritesBtn.addEventListener('click', () => { renderFavouritesList(); favouritesModal.showModal(); });

      // --- Main App Listeners ---
      if (analyseBtn) analyseBtn.addEventListener('click', () => processNewMeal());
      if (foodInput) foodInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') processNewMeal(); });
      if (toggleDashboardBtn) {
        toggleDashboardBtn.addEventListener('click', () => {
          const dashboardEl = document.getElementById('dashboard');
          if (dashboardEl) {
            dashboardEl.classList.toggle('hidden');
            syncToggleDashboardButton();
            if (!dashboardEl.classList.contains('hidden')) {
              setTimeout(() => dashboardEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
          } else {
            console.error("Dashboard element with id 'dashboard' not found!");
          }
        });
      }
      document.querySelectorAll('.quick-food-btn').forEach(btn => btn.addEventListener('click', () => { foodInput.value = btn.textContent; processNewMeal(); }));
      document.querySelectorAll('.meal-type-btn').forEach(btn => btn.addEventListener('click', () => { document.querySelector('.meal-type-btn.active')?.classList.remove('active'); btn.classList.add('active'); }));
      if (cameraScanBtn) cameraScanBtn.addEventListener('click', () => cameraChoiceModal.showModal());
      if (voiceInputBtn) voiceInputBtn.addEventListener('click', startVoiceRecognition);

      // --- Modals & Other Listeners ---
      if (scanMealBtn) scanMealBtn.addEventListener('click', () => {
        cameraChoiceModal.close();
        if (newCamModule) newCamModule.click();
      });

      if (scanBarcodeBtn) scanBarcodeBtn.addEventListener('click', () => {
        cameraChoiceModal.close();
        startBarcodeScanner();
      });

      if (uploadImageBtn) {
        uploadImageBtn.addEventListener('click', () => {
          cameraChoiceModal.close();
          if (imageUploadInput) imageUploadInput.click();
        });
      }

      if (imageUploadInput) imageUploadInput.addEventListener('change', handleImageUpload);
      if (newCamModule) newCamModule.addEventListener('change', handleImageUpload);

      if (servingForm) {
        servingForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const servingSize = parseFloat(document.getElementById('serving-size').value);
          if (servingSize > 0 && currentScannedProduct) {
            const multiplier = servingSize / 100;
            processNewMeal({
              food: currentScannedProduct.food,
              calories: currentScannedProduct.calories_100g * multiplier,
              protein: currentScannedProduct.protein_100g * multiplier,
              fat: currentScannedProduct.fat_100g * multiplier,
              carbs: currentScannedProduct.carbs_100g * multiplier
            });
            servingModal.close(); // CHANGED: Use close() instead of classList.add('hidden')
            currentScannedProduct = null;
          }
        });
      }
      if (quantityForm) {
        quantityForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const quantity = quantityInput.value.trim();
          if (quantity && identifiedFoodName) {
            foodInput.value = `${quantity} ${identifiedFoodName}`;
            quantityModal.close();
            processNewMeal();
          }
        });
      }

      // ★★★★★ ここが修正された重要な箇所です ★★★★★

      if (deleteAllDataBtn) deleteAllDataBtn.addEventListener('click', resetAllData);

      if (quantitySpecModal) {
        quantitySlider.addEventListener('input', () => {
          const currentLang = localStorage.getItem('language') || 'en';
          const labels = translations[currentLang].sliderLabels;
          sliderLabel.textContent = labels[quantitySlider.value];
          quantitySpecText.value = "";
        });
        quantitySpecText.addEventListener('input', () => {
          const currentLang = localStorage.getItem('language') || 'en';
          const labels = translations[currentLang].sliderLabels;
          quantitySlider.value = 2;
          sliderLabel.textContent = labels[2];
        });
        if (unsureQuantitySpecBtn) {
          unsureQuantitySpecBtn.addEventListener('click', () => {
            foodInput.value = foodNameForQuantitySpec;
            quantitySpecModal.close();
            processNewMeal(null, true);
          });
        }
        confirmQuantitySpecBtn.addEventListener('click', () => {
          let finalQuery = '';
          const specifiedText = quantitySpecText.value.trim();
          const currentLang = localStorage.getItem('language') || 'en';
          const prefixes = translations[currentLang].sliderPrefixes;
          if (specifiedText) finalQuery = `${specifiedText} ${foodNameForQuantitySpec}`;
          else {
            const prefix = prefixes[quantitySlider.value];
            finalQuery = `${prefix} ${foodNameForQuantitySpec}`.trim();
          }
          foodInput.value = finalQuery;
          quantitySpecModal.close();
          processNewMeal(null, true);
        });
      }
      if (diagnosisForm) {
        diagnosisForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const gender = document.getElementById('gender').value, age = parseInt(document.getElementById('age').value), height = parseInt(document.getElementById('height').value), weight = parseInt(document.getElementById('weight').value), activityLevel = parseFloat(document.getElementById('activity-level').value);
          const bmr = (gender === 'male') ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
          const tdee = Math.round(bmr * activityLevel);
          setAndSaveGoals(tdee);
          settingsModal.close();
          showAlert(translations[localStorage.getItem('language') || 'en'].goalSetMessage.replace('{calories}', tdee));
        });
      }
      if (manualGoalForm) {
        manualGoalForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const manualCalories = parseInt(document.getElementById('manual-calories').value);
          if (manualCalories > 0) {
            setAndSaveGoals(manualCalories);
            settingsModal.close();
            showAlert(translations[localStorage.getItem('language') || 'en'].goalSetMessage.replace('{calories}', manualCalories));
          }
        });
      }
      if (offlineCloseBtn) offlineCloseBtn.addEventListener('click', () => offlineModal.classList.add('hidden'));

      document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => { activePeriod = btn.dataset.period; currentDate = new Date(); updateDashboard(activePeriod); }));
      resetAllBtn.addEventListener('click', resetAllData);
      if (resetTodayBtn) resetTodayBtn.addEventListener('click', resetTodayData);
      toggleDetailsBtn.addEventListener('click', () => { isDetailedView = !isDetailedView; updateDashboard(activePeriod); });
    }


    const splashScreenFinished = new Promise(resolve => {
      window.addEventListener('load', () => {
      });
    });

    auth.onAuthStateChanged(async user => {
      const isRecovering = localStorage.getItem('photo_pending') === 'true';

      if (isRecovering) {
        // In recovery mode, animations are terminated immediately.
        console.log('Recovery mode detected, skipping splash animation.');
        hideSplash();

      } else {
        // In the case of normal startup, execute normal animation.
        console.log('Normal startup, running splash animation.');
        hideSplash({ delay: 2200 });
      }

      // Display screen according to login status
      if (user) {
        await loadUserGoals();
        await loadFavourites();
        showAppContainer(true);
        userEmailDropdown.textContent = user.email;
        showLoader('loadingData');
        await loadMealsFromFirestore();
        hideLoader();
      } else {
        if (!isGuest) {
          window.location.href = "/login/";
          return;
        }
        showAppContainer(false);
        if (!firebaseReady) {
          const currentLang = localStorage.getItem('language') || 'en';
          authError.textContent = translations[currentLang]?.authUnavailable || 'Authentication is currently unavailable.';
        }
      }
    });

    window.addEventListener('load', () => {
      const currentLang = localStorage.getItem('language') || 'en';

      setTimeout(() => {
        if (!splashDismissed) {
          console.warn('Splash screen timeout reached. Forcing hide.');
          hideSplash();
        }
      }, 4000);

      if (localStorage.getItem('photo_pending') === 'true') {
        console.log('Reload detected. Switching to recovery splash screen...');

        document.getElementById('splash-title-container').classList.add('hidden');
        document.getElementById('splash-ecg-line').classList.add('hidden');
        document.getElementById('splash-tagline').classList.add('hidden');

        const recoveryContainer = document.getElementById('recovery-message');
        const recoveryText = recoveryContainer.querySelector('p');
        recoveryText.textContent = translations[currentLang]?.recoveringAnalysis || "Recovering interrupted photo analysis...";
        recoveryContainer.classList.remove('hidden');

        readImage().then(savedImage => {
          if (savedImage) {
            console.log('Photo recovered from IndexedDB. Restarting analysis.');
            handleImageUpload(savedImage);
          } else {
            localStorage.removeItem('photo_pending');
          }
        }).catch(err => {
          console.error('Failed to recover photo:', err);
          localStorage.removeItem('photo_pending');
        });

      }

      // Create a translation table
      buildFoodKeyReverseMap();

      // Set the default meal type according to the current time.
      setDefaultMealType();

      // Apply saved language settings
      setLanguage(currentLang);

      // Set functions for all buttons and forms
      initializeAppEventListeners();

      // Update the date in the header
      updateHeaderDate();
    });

    // barcode modal x button permission freeup fix
    barcodeModal.addEventListener('close', () => {
      // Same cleanup as in your close-barcode-btn
      if (html5QrCodeInstance && html5QrCodeInstance.isScanning) {
        html5QrCodeInstance.stop().then(() => {
          if (html5QrCodeInstance) html5QrCodeInstance.clear();
          html5QrCodeInstance = null;
        });
      }
    });

    // Add close event listener for quantity modal
    quantityModal.addEventListener('close', () => {
      // Clear the input when modal is closed
      if (quantityInput) {
        quantityInput.value = '';
      }
    });

    function openAboutModal() {
      document.getElementById("about-modal").showModal();
    }

    function openFeedbackModal() {
      document.getElementById("feedback-modal").showModal();
    }

    // Function to open the modal
    function openQuantitySpecModal(foodName) {
      foodNameForQuantitySpec = foodName;
      document.getElementById('quantity-spec-food-name').textContent = foodName;
      const currentLang = localStorage.getItem('language') || 'en';
      const labels = translations[currentLang].sliderLabels;
      quantitySlider.value = 2;
      sliderLabel.textContent = labels[2];
      quantitySpecText.value = '';
      quantitySpecModal.showModal();
    }

    // Slider input updates label
    quantitySlider.addEventListener('input', () => {
      const currentLang = localStorage.getItem('language') || 'en';
      const labels = translations[currentLang].sliderLabels;
      sliderLabel.textContent = labels[quantitySlider.value];
      quantitySpecText.value = '';
    });

    // Text input resets slider
    quantitySpecText.addEventListener('input', () => {
      const currentLang = localStorage.getItem('language') || 'en';
      const labels = translations[currentLang].sliderLabels;
      quantitySlider.value = 2;
      sliderLabel.textContent = labels[2];
    });
  </script>

  <!--service worker registration-->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, (err) => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>

  <!--pwa installation logic-->
  <script>
    // --- PWA INSTALL LOGIC ---
    let deferredPrompt = null;
    const installBtn = document.getElementById('install-btn');
    const pwaInstallModal = document.getElementById("pwa-install-modal")

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      deferredPrompt = e;
      // Update the UI to show the install button.
      // Only show the banner if it's not already installed.
      if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
        pwaInstallModal.showModal();
      }
    });

    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        // Show the install prompt.
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt.
        await deferredPrompt.userChoice;
        // We've used the prompt, and can't use it again, so hide the install UI.
        pwaInstallModal.close();
        // Clear the deferred prompt variable, since it can only be used once.
        deferredPrompt = null;
      });
    }

    window.addEventListener('appinstalled', () => {
      // Hide the install UI when the app is installed.
      pwaInstallModal.close();
      // Clear the deferredPrompt so it can be garbage collected
      deferredPrompt = null;
    });

  </script>

  <!--language logic-->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      updateHeaderDate();
      const handleGreetingResize = debounce(adjustHeaderGreetingSize, 150);
      window.addEventListener('resize', handleGreetingResize);
      window.addEventListener('orientationchange', handleGreetingResize);
    });
  </script>

</body>

</html>
