<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Tracker</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <link rel="icon" type="image/png" href="../icons/192.png">
  <!-- Barcode Scanner Library -->
  <script src="https://unpkg.com/@zxing/library@0.21.0/umd/index.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .main-container {
      padding: 1rem;
      transition: filter 0.3s;
    }

    @media (min-width: 640px) {
      .main-container {
        padding: 2rem;
      }
    }

    #auth-container,
    #app-container {
      transition: opacity 0.5s, visibility 0.5s;
    }

    .hidden {
      display: none;
    }

    .filter-btn.active,
    .meal-type-btn.active {
      background-color: #374151;
      color: white;
      border-color: #374151;
    }

    .camera-modal-content video {
      width: 100%;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    @media (min-width: 640px) {
      .modal-content {
        padding: 2rem;
      }
    }

    .favourite-star {
      cursor: pointer;
      transition: color 0.2s;
    }

    .favourite-star.favourited {
      color: #facc15;
    }

    .favourite-star:not(.favourited) svg {
      fill: none;
    }

    .favourite-star.favourited svg {
      fill: currentColor;
    }

    @keyframes pop {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.4);
      }

      100% {
        transform: scale(1);
      }
    }

    .star-pop {
      animation: pop 0.3s ease-in-out;
    }

    .favourite-star-container {
      position: relative;
    }

    .favourite-star-container.sparkling::after {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border-radius: 50%;
      border: 2px solid #facc15;
      transform: scale(0);
      opacity: 0;
      animation: sparkle-ring 0.5s ease-out;
    }

    @keyframes sparkle-ring {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }

      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    /* --- Loading Animation Styles --- */
    .loader {
      width: 80px;
      aspect-ratio: 1;
      color: #E8204E;
      background:
        radial-gradient(circle at 60% 65%, currentColor 62%, #0000 65%) top left,
        radial-gradient(circle at 40% 65%, currentColor 62%, #0000 65%) top right,
        linear-gradient(to bottom left, currentColor 42%, #0000 43%) bottom left,
        linear-gradient(to bottom right, currentColor 42%, #0000 43%) bottom right;
      background-size: 50% 50%;
      background-repeat: no-repeat;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      /* Behind the line */
    }

    .loader:after {
      content: "";
      position: absolute;
      inset: 0;
      background: inherit;
      opacity: 0.4;
      animation: l3 1.5s infinite;
    }

    @keyframes l3 {
      to {
        transform: scale(1.8);
        opacity: 0
      }
    }

    .ecg-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      /* In front of the heart */
      overflow: visible;
    }

    .ecg-path {
      stroke: white;
      /* White color */
      stroke-dasharray: 190;
      stroke-dashoffset: 190;
      animation: draw-line 1.5s ease-in-out infinite;
    }

    @keyframes draw-line {
      0% {
        stroke-dashoffset: 190;
      }

      50% {
        stroke-dashoffset: 0;
      }

      100% {
        stroke-dashoffset: -190;
      }
    }

    /* --- Barcode Scanner Overlay --- */
    .scanner-container {
      position: relative;
      width: 100%;
      background: black;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .focus-box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80%;
      height: 40%;
      border: 2px solid white;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
      transform: translate(-50%, -50%);
      border-radius: 0.5rem;
    }

    /* --- Splash Screen Styles --- */
    #splash-screen {
      transition: opacity 0.5s ease-out;
      /* Start fading out after 2.2s */
      overflow: hidden;
    }

    #splash-title-container {
      position: relative;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #splash-title {
      display: flex;
      position: relative;
      z-index: 10;
    }

    #splash-heart {
      position: absolute;
      width: 80px;
      height: 80px;
      fill: #E8204E;
      opacity: 0;
      z-index: 5;
      animation: heart-beat-behind 1.0s ease-in-out 0.8s forwards;
    }

    #splash-heart-shockwave {
      position: absolute;
      width: 80px;
      height: 80px;
      stroke: #E8204E;
      stroke-width: 0.25px;
      /* MODIFIED: Thinner line */
      fill: none;
      opacity: 0;
      z-index: 4;
      animation: heart-shockwave 0.6s ease-out 1s forwards;
    }

    #splash-nutri {
      animation: slideInFromLeft 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }

    #splash-quest {
      animation: slideInFromRight 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }

    @keyframes slideInFromLeft {
      0% {
        transform: translateX(-150%);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes slideInFromRight {
      0% {
        transform: translateX(150%);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes heart-beat-behind {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      25% {
        opacity: 0.5;
        transform: scale(1.8);
      }

      /* Bigger, faster beat */
      35% {
        transform: scale(1.4);
      }

      /* Settle faster */
      100% {
        opacity: 0;
        transform: scale(1.4);
      }

      /* Fade out while large */
    }

    @keyframes heart-shockwave {
      0% {
        opacity: 0.6;
        transform: scale(1.4);
      }

      100% {
        opacity: 0;
        transform: scale(2.8);
      }
    }

    #splash-ecg-line {
      animation: fadeIn 0.1s ease-out 0.8s forwards;
    }

    .splash-ecg-path {
      stroke-dasharray: 450;
      stroke-dashoffset: 450;
      animation: drawSplashLine 0.8s ease-in-out 0.8s forwards;
    }

    @keyframes drawSplashLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    #splash-tagline {
      animation: fadeIn 1s ease-in 0.8s forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    #main-app-content {
      transition: opacity 1s ease-in;
    }

    /* --- Analyse Meal Button Highlight --- */
    .analyse-btn {
      position: relative;
      overflow: hidden;
      /* Important to contain the pseudo-element */
    }

    .analyse-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(110deg, rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 60%);
      transform: translateX(-100%);
      transition: transform 0.6s ease-in-out;
    }

    .analyse-btn:hover::after {
      transform: translateX(100%);
    }

    .lang-btn:not(.active):hover {
      background-color: #d1d5db;
    }

    .lang-btn.active {
      background-color: #4f46e5;
      color: white;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- Splash Screen -->
  <div id="splash-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
    <div id="splash-title-container">
      <h1 id="splash-title" class="text-5xl font-bold text-gray-700">
        <span id="splash-nutri">Nutri</span><span id="splash-quest">Quest</span>
      </h1>
      <svg id="splash-heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
      </svg>
      <svg id="splash-heart-shockwave" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
      </svg>
    </div>
    <div class="relative w-96 h-12">
      <svg id="splash-ecg-line" class="absolute inset-0 w-full h-full opacity-0" viewBox="0 0 300 60">
        <path class="splash-ecg-path" d="M0 30 H80 L95 10 L125 50 L145 20 L155 30 H300" stroke-width="3"
          stroke="#E8204E" fill="none"></path>
      </svg>
    </div>
    <p id="splash-tagline" data-lang-key="tagline" class="text-lg text-gray-500 mt-2 opacity-0">Your Journey to a
      Healthier You.</p>
  </div>

  <!-- Main Application and Auth Containers -->
  <div id="main-app-content" class="opacity-0">
    <div id="main-content">
      <!-- Authentication Container -->
      <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="relative max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
          <div class="absolute top-4 right-4">
            <div class="flex items-center gap-1 bg-gray-200 rounded-full p-1">
              <button data-lang="en"
                class="lang-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors">EN</button>
              <button data-lang="zh"
                class="lang-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors"><span
                  class="hidden sm:inline">中文</span><span class="inline sm:hidden">中</span></button>
            </div>
          </div>
          <h2 id="auth-title" data-lang-key="loginTitle" class="text-3xl font-bold text-center text-gray-800 mb-6 pt-8">
            Login</h2>
          <p id="auth-error" class="text-red-500 text-center mb-4"></p>
          <form id="auth-form">
            <div class="mb-4">
              <label for="email" data-lang-key="emailLabel" class="block text-gray-700 font-semibold mb-2">Email</label>
              <input type="email" id="email"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                required>
            </div>
            <div class="mb-6">
              <label for="password" data-lang-key="passwordLabel"
                class="block text-gray-700 font-semibold mb-2">Password</label>
              <input type="password" id="password"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                required>
            </div>

            <!-- Link to reset password -->
            <p class="text-right mb-4"><a href="#" id="forgot-password-link"
                class="text-sm text-blue-500 hover:underline" data-lang-key="forgotPassword">Forgot
                Password?</a></p>

            <button type="submit" id="auth-submit-btn" data-lang-key="loginButton"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Login</button>
          </form>
          <p class="text-center mt-6">
            <a href="#" id="auth-toggle-link" data-lang-key="authToggle" class="text-blue-500 hover:underline">Need an
              account? Sign Up</a>
          </p>
          <div class="my-4 flex items-center">
            <div class="flex-grow border-t border-gray-300"></div>
            <span class="flex-shrink mx-4 text-gray-400" data-lang-key="or">OR</span>
            <div class="flex-grow border-t border-gray-300"></div>
          </div>

          <button id="google-signin-btn"
            class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-200 transition-all">
            <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                fill="#4285F4" />
              <path
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                fill="#34A853" />
              <path
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"
                fill="#FBBC05" />
              <path
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                fill="#EA4335" />
              <path d="M1 1h22v22H1z" fill="none" />
            </svg>
            <span data-lang-key="googleSignIn">Sign in with Google</span>
          </button>

          <div class="mt-6 border-t pt-6 text-center">
            <button id="guest-mode-btn" data-lang-key="guestButton"
              class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition-all">Continue
              as Guest</button>
          </div>
        </div>
      </div>

      <!-- Main Application Container -->
      <div id="app-container" class="hidden">
        <!-- Header -->
        <header id="app-header" class="w-full sticky top-0 z-50 bg-white transition-shadow duration-300 ease-in-out">
          <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center p-4 gap-4">
            <!-- Logo and Title Block -->
            <div class="flex items-center gap-3">
              <svg class="w-10 h-10 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <defs>
                  <linearGradient id="headerHeartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:rgb(239, 68, 68)"></stop>
                    <stop offset="100%" style="stop-color:rgb(236, 72, 153)"></stop>
                  </linearGradient>
                </defs>
                <path fill="url(#headerHeartGradient)"
                  d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z">
                </path>
              </svg>
              <div class="text-center sm:text-left">
                <h1 data-lang-key="healthTrackerTitle" class="text-xl sm:text-3xl font-bold text-gray-700">Health
                  Tracker</h1>
                <p data-lang-key="tagline" class="text-gray-500 text-sm">Your Journey to a Healthier
                  You.</p>
              </div>
            </div>

            <!-- Controls Block -->
            <div class="flex items-center gap-2 sm:gap-4">
              <!-- Language Selector -->
              <div id="language-selector" class="flex items-center gap-1 bg-gray-200 rounded-full p-1">
                <button data-lang="en"
                  class="lang-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors">EN</button>
                <button data-lang="zh"
                  class="lang-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors"><span
                    class="hidden sm:inline">中文</span><span class="inline sm:hidden">中</span></button>
              </div>
              <!-- Logged In Header -->
              <div id="user-header" class="relative">
                <button id="account-menu-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                  <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                    </path>
                  </svg>
                </button>
                <div id="account-dropdown"
                  class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                  <div class="px-4 py-2 text-sm text-gray-700 border-b truncate" id="user-email-dropdown"></div>
                  <a href="#" id="sign-out-btn-dropdown" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    data-lang-key="signOutButton">Sign Out</a>
                </div>
              </div>
              <!-- Guest Header -->
              <div id="guest-header">
                <button id="go-to-login-btn"
                  class="bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-3 sm:px-4 rounded-lg transition-all text-sm">
                  <span class="sm:hidden" data-lang-key="loginButton">Login</span>
                  <span class="hidden sm:inline" data-lang-key="loginToSyncButton">Login to Sync
                    Data</span>
                </button>
              </div>
              <button id="favourites-btn" class="text-gray-500 hover:text-yellow-500"
                data-lang-key-title="favouritesTitle" title="Favourites">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z">
                  </path>
                </svg>
              </button>
              <button id="settings-btn" class="text-gray-500 hover:text-blue-500" data-lang-key-title="setGoalsTitle"
                title="Set Your Daily Goals">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                  </path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        </header>

        <div class="main-container">
          <div class="w-full max-w-6xl mx-auto pt-8 sm:pt-16">
            <!-- Logo Placeholder -->
            <div class="text-center mb-4 sm:mb-8">
              <!-- ▼▼▼ Original logo image ▼▼▼ -->
              <img src="../icons/NutriQuest_Logo.png" alt="NutriQuest Logo" class="mx-auto h-16 md:h-20 w-auto">
              <!-- ▲▲▲ Original logo image ▲▲▲ -->
            </div>

            <div class="search-container max-w-xl mx-auto text-center">
              <div
                class="relative flex items-center bg-white border border-gray-200 rounded-full shadow-md hover:shadow-lg focus-within:shadow-lg">
                <div class="pl-5"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg></div>
                <input type="text" id="food-input"
                  class="w-full bg-transparent p-4 pl-2 text-lg rounded-full focus:outline-none"
                  data-lang-key-placeholder="foodInputPlaceholder"
                  placeholder="e.g., 1 cup of rice and grilled chicken">
                <button id="voice-input-btn" class="p-3 text-gray-500 hover:text-blue-500"
                  data-lang-key-title="voiceInputTitle" title="Voice Input">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                    </path>
                  </svg>
                </button>
                <button id="camera-scan-btn" class="p-3 pr-5 text-gray-500 hover:text-blue-500"
                  data-lang-key-title="scanWithCameraTitle" title="Scan with Camera">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </button>
              </div>

              <!-- Meal Type Selector -->
              <div id="meal-type-selector" class="flex flex-wrap justify-center gap-2 mt-4">
                <button data-type="Breakfast"
                  class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
                  data-lang-key="breakfast">Breakfast</button>
                <button data-type="Lunch"
                  class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
                  data-lang-key="lunch">Lunch</button>
                <button data-type="Dinner"
                  class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
                  data-lang-key="dinner">Dinner</button>
                <button data-type="Snack"
                  class="meal-type-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-2 text-sm sm:py-3 sm:px-6 sm:text-base rounded-full border border-gray-300 transition-all"
                  data-lang-key="snack">Snack</button>
              </div>

              <div class="mt-6">
                <button id="analyse-btn"
                  class="analyse-btn bg-gradient-to-r from-[#c7ff41] to-[#5A8F41] text-white font-semibold py-3 px-8 text-lg rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-px transition-all">
                  <span class="relative z-10" data-lang-key="analyseMealButton">Analyse Meal</span>
                </button>
              </div>

              <!-- Quick Access Section -->
              <div id="quick-access" class="mt-8 text-center">
                <h3 class="text-lg font-semibold text-gray-600 mb-3" data-lang-key="quickAccess">Quick
                  Access</h3>
                <div class="flex flex-wrap justify-center gap-2">
                  <button
                    class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
                    data-lang-key="hainaneseChickenRice">Hainanese Chicken Rice</button>
                  <button
                    class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
                    data-lang-key="laksa">Laksa</button>
                  <button
                    class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
                    data-lang-key="kayaToast">Kaya Toast</button>
                  <button
                    class="quick-food-btn bg-gray-200 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-full text-sm transition-all"
                    data-lang-key="bakKutTeh">Bak Kut Teh</button>
                </div>
              </div>
            </div>

            <div class="mt-8 text-center">
              <button id="toggle-dashboard-btn"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-8 text-lg rounded-lg shadow-md transition-all w-full sm:w-auto">
                <span data-lang-key="viewDashboard">View Dashboard</span>
              </button>
            </div>

            <div id="dashboard" class="mt-10 w-full max-w-6xl mx-auto hidden">
              <div class="flex justify-center space-x-2 mb-6">
                <button data-period="day"
                  class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
                  data-lang-key="today">Today</button>
                <button data-period="week"
                  class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
                  data-lang-key="thisWeek">This Week</button>
                <button data-period="month"
                  class="filter-btn bg-white hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg border border-gray-300 transition-all"
                  data-lang-key="thisMonth">This Month</button>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-2 space-y-6">
                  <div id="period-totals-card" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                      <button id="prev-period-btn"
                        class="p-2 rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Previous Period">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                          </path>
                        </svg>
                      </button>
                      <div id="period-title-container"
                        class="flex items-center justify-center cursor-pointer hover:text-blue-600 transition-colors group">
                        <h2 id="period-title"
                          class="text-xl sm:text-2xl font-bold text-gray-800 text-center px-2 group-hover:text-blue-600 transition-colors">
                        </h2>
                        <svg class="w-5 h-5 ml-1 text-gray-500 group-hover:text-blue-600 transition-colors" fill="none"
                          stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                          </path>
                        </svg>
                      </div>
                      <button id="next-period-btn"
                        class="p-2 rounded-full hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Next Period">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </button>
                    </div>
                    <div id="period-totals" class="grid grid-cols-2 gap-4 text-center">
                      <div>
                        <p class="text-sm text-gray-600" data-lang-key="calories">Calories</p>
                        <p id="total-calories" class="text-2xl font-semibold text-blue-600">0
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600" data-lang-key="protein">Protein</p>
                        <p id="total-protein" class="text-2xl font-semibold text-green-600">0 g
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600" data-lang-key="fat">Fat</p>
                        <p id="total-fat" class="text-2xl font-semibold text-orange-500">0 g</p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600" data-lang-key="carbs">Carbs</p>
                        <p id="total-carbs" class="text-2xl font-semibold text-red-500">0 g</p>
                      </div>
                    </div>
                    <div class="text-center mt-6">
                      <button id="toggle-details-btn" class="text-blue-500 hover:underline"
                        data-lang-key="showDetails">Show Details</button>
                    </div>
                  </div>
                  <!-- Detailed Dashboard View (Initially Hidden) -->
                  <div id="detailed-dashboard-view" class="hidden space-y-6">
                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm">
                      <div id="charts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="main-chart-wrapper">
                          <h3 id="dynamic-chart-title" class="text-lg font-bold text-center text-gray-800 mb-2"></h3>
                          <p id="period-goal-text" class="text-center text-gray-500 text-sm mb-1 hidden"></p>
                          <p id="period-actual-text" class="text-center font-semibold text-sm mb-2 hidden"></p>
                          <canvas id="calorie-gauge-chart"></canvas>
                          <div id="bar-chart-container" class="relative h-80 hidden">
                            <canvas id="period-bar-chart"></canvas>
                          </div>
                        </div>
                        <div id="nutrition-balance-wrapper">
                          <h3 class="text-lg font-bold text-center text-gray-800 mb-2" data-lang-key="nutritionBalance">
                            Nutrition Balance</h3>
                          <canvas id="nutrition-chart"></canvas>
                          <div id="nutrition-balance-text" class="hidden text-left"></div>
                        </div>
                      </div>
                      <div id="small-gauges-container" class="grid grid-cols-3 gap-4 mt-6">
                        <div>
                          <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="protein">Protein
                          </h3>
                          <canvas id="protein-gauge-chart"></canvas>
                        </div>
                        <div>
                          <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="fat">Fat</h3>
                          <canvas id="fat-gauge-chart"></canvas>
                        </div>
                        <div>
                          <h3 class="text-md font-bold text-center text-gray-800 mb-1" data-lang-key="carbs">Carbs</h3>
                          <canvas id="carbs-gauge-chart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Nutrition Advice Card -->
                  <div id="advice-card" class="p-6 rounded-xl shadow-sm hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4" data-lang-key="nutritionAdvice">Nutrition Advice
                    </h2>
                    <div id="advice-content" class="flex items-start space-x-4">
                      <span id="advice-icon" class="text-3xl"></span>
                      <p id="advice-text" class="text-gray-700"></p>
                    </div>
                  </div>
                </div>

                <div class="lg:col-span-3">
                  <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm min-h-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4" data-lang-key="mealList">Meal
                      List</h2>
                    <div id="meal-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                      <p id="no-meals-message" class="text-gray-500" data-lang-key="noMeals">No
                        meals recorded for this period.</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-8 text-center">
                <button id="reset-all-btn"
                  class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-lg transition-all"
                  data-lang-key="deleteAllData">Delete All Data</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Camera Choice Modal -->
  <div id="camera-choice-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-6" data-lang-key="scanWithCameraTitle">Scan with Camera</h2>
      <div class="space-y-4">
        <button id="scan-meal-btn"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg"
          data-lang-key="scanMealButton">Scan Meal with Camera</button>
        <button id="scan-barcode-btn"
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg"
          data-lang-key="scanBarcodeButton">Scan Barcode</button>
        <button id="close-choice-btn" class="mt-4 w-full text-center text-gray-500 hover:underline"
          data-lang-key="closeButton">Close</button>
      </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="modal-overlay hidden">
    <div class="modal-content camera-modal-content">
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="positionMeal">Position your meal in the
        camera</h2>
      <video id="camera-view" autoplay playsinline></video>
      <canvas id="camera-canvas" class="hidden"></canvas>
      <div class="flex justify-center space-x-4 mt-4">
        <button id="capture-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full"
          data-lang-key="captureButton">Capture</button>
        <button id="close-camera-btn"
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full"
          data-lang-key="closeButton">Close</button>
      </div>
    </div>
  </div>

  <!-- Barcode Scanner Modal -->
  <div id="barcode-modal" class="modal-overlay hidden">
    <div class="modal-content camera-modal-content">
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="scanBarcodeTitle">Scan a Barcode</h2>
      <div class="scanner-container">
        <video id="barcode-video" class="w-full"></video>
        <div class="focus-box"></div>
      </div>
      <div id="zoom-controls" class="mt-4 hidden">
        <label for="zoom-slider" class="block text-sm font-medium text-gray-700" data-lang-key="zoom">Zoom</label>
        <input type="range" id="zoom-slider" class="w-full">
      </div>
      <p id="barcode-result" class="mt-2 text-gray-600"></p>
      <div class="flex justify-center space-x-4 mt-4">
        <button id="close-barcode-btn"
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full"
          data-lang-key="closeButton">Close</button>
      </div>
    </div>
  </div>

  <!-- Serving Size Modal -->
  <div id="serving-modal" class="modal-overlay hidden">
    <div class="modal-content text-left">
      <h2 class="text-2xl font-bold mb-2 text-center" data-lang-key="servingSizeTitle">Enter Serving Size</h2>
      <p id="serving-product-name" class="text-center text-gray-600 mb-4"></p>
      <form id="serving-form">
        <label for="serving-size" class="block text-sm font-medium text-gray-700"
          data-lang-key="servingSizeLabel">Serving Size (grams)</label>
        <input type="number" id="serving-size" value="100"
          class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancel-serving-btn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"
            data-lang-key="cancelButton">Cancel</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
            data-lang-key="addMealButton">Add Meal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Favourites Modal -->
  <div id="favourites-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-lg w-full text-left">
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="favouritesTitle">Your Favourite Meals</h2>
      <div id="favourites-list" class="space-y-2 max-h-96 overflow-y-auto">
        <!-- Favourites will be rendered here -->
      </div>
      <button id="close-favourites-btn" class="mt-4 w-full text-center text-gray-500 hover:underline"
        data-lang-key="closeButton">Close</button>
    </div>
  </div>

  <!-- Custom Alert/Confirm Modal -->
  <div id="alert-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="alert-message" class="text-lg mb-6"></p>
      <div id="alert-buttons" class="flex justify-center space-x-4">
        <button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg"
          data-lang-key="okButton">OK</button>
        <button id="alert-confirm-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg"
          data-lang-key="confirmButton">Confirm</button>
        <button id="alert-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-8 rounded-lg"
          data-lang-key="cancelButton">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-lg w-full text-left max-h-[80vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="setGoalsTitle">Set Your Daily Goals</h2>
      <p class="text-center text-gray-600 mb-6" data-lang-key="settingsDescription">Let us calculate your needs,
        or set your own manual goal.</p>

      <!-- Diagnosis Form -->
      <form id="diagnosis-form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" data-lang-key="gender">Gender</label>
            <select id="gender"
              class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="male" data-lang-key="male">Male</option>
              <option value="female" data-lang-key="female">Female</option>
            </select>
          </div>
          <div>
            <label for="age" class="block text-sm font-medium text-gray-700" data-lang-key="age">Age</label>
            <input type="number" id="age" value="30"
              class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label for="height" class="block text-sm font-medium text-gray-700" data-lang-key="height">Height
              (cm)</label>
            <input type="number" id="height" value="170"
              class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label for="weight" class="block text-sm font-medium text-gray-700" data-lang-key="weight">Weight
              (kg)</label>
            <input type="number" id="weight" value="70"
              class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
          </div>
        </div>
        <div class="mt-4">
          <label for="activity-level" class="block text-sm font-medium text-gray-700"
            data-lang-key="activityLevel">Activity Level</label>
          <select id="activity-level"
            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm">
            <option value="1.2" data-lang-key="activityLevel1">Sedentary (mostly sitting, little to no
              exercise)</option>
            <option value="1.375" data-lang-key="activityLevel2" selected>Lightly Active (light
              exercise/walks 1-2 times a week)</option>
            <option value="1.55" data-lang-key="activityLevel3">Moderately Active (regular exercise 3-5
              times a week)</option>
            <option value="1.725" data-lang-key="activityLevel4">Very Active (vigorous exercise 6-7 times a
              week)</option>
            <option value="1.9" data-lang-key="activityLevel5">Extremely Active (strenuous exercise daily or
              physical job)</option>
          </select>
        </div>
        <button type="submit"
          class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
          data-lang-key="calculateAndSave">Calculate & Save</button>
      </form>

      <div class="my-4 text-center text-gray-500" data-lang-key="or">OR</div>

      <!-- Manual Form -->
      <form id="manual-goal-form">
        <label for="manual-calories" class="block text-sm font-medium text-gray-700" data-lang-key="setManualGoal">Set
          Manual Calorie Goal</label>
        <input type="number" id="manual-calories" value="2000"
          class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
        <button type="submit"
          class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"
          data-lang-key="saveManualGoal">Save Manual Goal</button>
      </form>
      <button id="close-settings-btn" class="mt-4 w-full text-center text-gray-500 hover:underline"
        data-lang-key="closeButton">Close</button>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div id="calendar-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-xs w-full bg-white p-4 rounded-lg shadow-lg">
      <div id="calendar-header" class="flex justify-between items-center mb-4">
        <button id="calendar-prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
            </path>
          </svg>
        </button>
        <h3 id="calendar-month-year" class="font-bold text-lg"></h3>
        <button id="calendar-next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
      <div id="calendar-weekdays" class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-semibold mb-2">
        <!-- Day names (S, M, T, etc.) will be generated here -->
      </div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
        <!-- Dates will be generated here -->
      </div>
      <div id="calendar-month-grid" class="hidden grid grid-cols-3 gap-2 text-center mt-4">
        <!-- Months will be generated here -->
      </div>
      <button id="close-calendar-btn" class="mt-4 w-full text-center text-gray-500 hover:underline"
        data-lang-key="closeButton">Close</button>
    </div>
  </div>

  <!-- Quantity Confirmation Modal -->
  <div id="quantity-modal" class="modal-overlay hidden">
    <div class="modal-content text-left">
      <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="confirmFoodTitle">Confirm Food & Quantity
      </h2>
      <p class="text-center mb-4">We identified this as: <strong id="identified-food-name" class="capitalize"></strong>.
        Is this correct?</p>
      <form id="quantity-form">
        <label for="quantity-input" class="block text-sm font-medium text-gray-700" data-lang-key="quantityLabel">Enter
          quantity (e.g., 1 piece, 100g)</label>
        <input type="text" id="quantity-input"
          class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancel-quantity-btn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"
            data-lang-key="cancelButton">Cancel</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
            data-lang-key="confirmButton">Confirm</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="modal-overlay hidden">
    <div class="flex flex-col items-center justify-center text-white">
      <div class="relative w-24 h-24 flex items-center justify-center">
        <div class="loader"></div>
        <svg class="ecg-line" width="120" height="80" viewBox="0 0 120 80">
          <path class="ecg-path" d="M0 40 H30 L35 20 L45 60 L50 35 L55 40 H120" stroke-width="3" fill="none">
          </path>
        </svg>
      </div>
      <p id="loading-text" class="mt-8 text-lg font-semibold" data-lang-key="analyzing">Analyzing...</p>
    </div>
  </div>

  <!-- Voice Listening Modal -->
  <div id="listening-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <svg class="w-16 h-16 text-blue-500 mx-auto animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
        </path>
      </svg>
      <p id="listening-text-status" class="text-lg mt-4" data-lang-key="listeningStatus">Listening...</p>
    </div>
  </div>


  <script>
    // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
    const GEMINI_API_KEY = "AIzaSyCldW53rqjHejtKvuGyxyQM8R9kuEtgZN0";

    const firebaseConfig = {
      apiKey: "AIzaSyB2uJs32bmnoOgHcB6GTZuu0eBanfZWLWE",
      authDomain: "nutriquest-6c40d.firebaseapp.com",
      projectId: "nutriquest-6c40d",
      storageBucket: "nutriquest-6c40d.firebasestorage.app",
      messagingSenderId: "893360379713",
      appId: "1:893360379713:web:4f7952bf9094caf139b3c0",
      measurementId: "G-C9V61B19G7"
    };
    // --- Firebase Initialization ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Language Translation Data ---
    const translations = {
      en: {
        loginTitle: "Login", emailLabel: "Email", passwordLabel: "Password", loginButton: "Login", authToggle: "Need an account? Sign Up", guestButton: "Continue as Guest", forgotPassword: "Forgot Password?", enterEmailForReset: "Please enter your email address in the email field to reset your password.", passwordResetSent: "A password reset link has been sent to your email address. Please check your inbox.", healthTrackerTitle: "Health Tracker", tagline: "Your Journey to a Healthier You.", signOutButton: "Sign Out", loginToSyncButton: "Login to Sync Data", favouritesTitle: "Favourites", setGoalsTitle: "Set Your Daily Goals", googleSignIn: "Sign in with Google", foodInputPlaceholder: "e.g., 1 cup of rice and grilled chicken", voiceInputTitle: "Voice Input", scanWithCameraTitle: "Scan with Camera", breakfast: "Breakfast", lunch: "Lunch", dinner: "Dinner", snack: "Snack", analyseMealButton: "Analyse Meal", quickAccess: "Quick Access", hainaneseChickenRice: "Hainanese Chicken Rice", laksa: "Laksa", kayaToast: "Kaya Toast", bakKutTeh: "Bak Kut Teh", today: "Today", thisWeek: "This Week", thisMonth: "This Month", todaysTotals: "Today's Totals", thisWeeksTotals: "This Week's Total Calories", thisMonthsTotals: "This Month's Total Calories", calories: "Calories", protein: "Protein", fat: "Fat", carbs: "Carbs", showDetails: "Show Details", closeDetails: "Close", nutritionAdvice: "Nutrition Advice", todaysCalories: "Today's Calories", nutritionBalance: "Nutrition Balance", mealList: "Meal List", noMeals: "No meals recorded for this period.", deleteAllData: "Delete All Data", scanMealButton: "Scan Meal with Camera", scanBarcodeButton: "Scan Barcode", closeButton: "Close", positionMeal: "Position your meal in the camera", captureButton: "Capture", scanBarcodeTitle: "Scan a Barcode", zoom: "Zoom", servingSizeTitle: "Enter Serving Size", servingSizeLabel: "Serving Size (grams)", cancelButton: "Cancel", addMealButton: "Add Meal", okButton: "OK", confirmButton: "Confirm", settingsDescription: "Let us calculate your needs, or set your own manual goal.", gender: "Gender", male: "Male", female: "Female", age: "Age", height: "Height (cm)", weight: "Weight (kg)", activityLevel: "Activity Level",
        activityLevel1: "Sedentary (mostly sitting, little to no exercise)",
        activityLevel2: "Lightly Active (light exercise/walks 1-2 times a week)",
        activityLevel3: "Moderately Active (regular exercise 3-5 times a week)",
        activityLevel4: "Very Active (vigorous exercise 6-7 times a week)",
        activityLevel5: "Extremely Active (strenuous exercise daily or physical job)",
        calculateAndSave: "Calculate & Save", or: "OR", setManualGoal: "Set Manual Calorie Goal", saveManualGoal: "Save Manual Goal",
        analysing: "Analysing...", noFavourites: "No favourite meals yet. Click the star on a meal to add it.",
        didYouMean: 'Did you mean "{foodName}"?', listening: 'Listening...', checkingSpeech: 'Checking your speech...', speechError: 'Could not recognize speech: {error}',
        deletingData: 'Deleting all data...', signingIn: 'Signing in...', loadingData: 'Loading your data...', barcodeLookup: 'Found barcode: {barcode}. Looking up...',
        nextMeal: "your next meal",
        goalSetMessage: "Your daily goal has been set to {calories} kcal.",
        adviceLowProtein: "For {nextMeal}, focus on a protein-rich food like grilled chicken, fish, or tofu to improve your balance.",
        adviceHighFat: "For {nextMeal}, try a lower-fat option. Steamed vegetables and a lean protein source would be a great choice.",
        adviceBalanced: "You're doing great! For {nextMeal}, a balanced meal with whole grains, lean protein, and colourful vegetables would be perfect to continue your streak.",
        adviceStart: "Let's get started! For your next meal, try to include a mix of protein, healthy fats, and complex carbs.",
        rateLimitError: "Requests are currently busy. Please wait a moment and try again.",
        removeFavouriteConfirm: "Are you sure you want to remove this favourite?",
        viewDashboard: "View Dashboard",
        hideDashboard: "Hide Dashboard",
        confirmFoodTitle: "Confirm Food & Quantity",
        quantityLabel: "Enter quantity (e.g., 1 piece, 100g)",
        sun: "S", mon: "M", tue: "T", wed: "W", thu: "T", fri: "F", sat: "S",
        week: "Week", periodGoal: "Period Goal", actualIntake: "Actual Intake"
      },
      zh: {
        loginTitle: "登录", emailLabel: "电子邮件", passwordLabel: "密码", loginButton: "登录", authToggle: "需要一个账户？ 注册", guestButton: "以访客身份继续", forgotPassword: "忘记密码？", enterEmailForReset: "请在电子邮件字段中输入您的电子邮件地址以重置密码。", passwordResetSent: "密码重置链接已发送到您的电子邮件地址。请检查您的收件箱。", healthTrackerTitle: "健康追踪器", tagline: "开启您的健康之旅。", signOutButton: "登出", loginToSyncButton: "登录以同步数据", favouritesTitle: "收藏", setGoalsTitle: "设定每日目标", googleSignIn: "使用谷歌登录", foodInputPlaceholder: "例如：一碗米饭和烤鸡", voiceInputTitle: "语音输入", scanWithCameraTitle: "用相机扫描", breakfast: "早餐", lunch: "午餐", dinner: "晚餐", snack: "点心", analyseMealButton: "分析膳食", quickAccess: "快速访问", hainaneseChickenRice: "海南鸡饭", laksa: "叻沙", kayaToast: "咖椰吐司", bakKutTeh: "肉骨茶", today: "今天", thisWeek: "本星期", thisMonth: "这个月", todaysTotals: "今日总计", thisWeeksTotals: "本周总热量", thisMonthsTotals: "本月总热量", calories: "卡路里", protein: "蛋白质", fat: "脂肪", carbs: "碳水化合物", showDetails: "显示详细信息", closeDetails: "关闭", nutritionAdvice: "营养建议", todaysCalories: "今日卡路里", nutritionBalance: "营养均衡", mealList: "膳食清单", noMeals: "此期间没有记录膳食。", deleteAllData: "删除所有数据", scanMealButton: "用相机扫描膳食", scanBarcodeButton: "扫描条形码", closeButton: "关闭", positionMeal: "将您的餐点放在相机中", captureButton: "捕获", scanBarcodeTitle: "扫描条形码", zoom: "变焦", servingSizeTitle: "输入份量", servingSizeLabel: "份量（克）", cancelButton: "取消", addMealButton: "添加膳食", okButton: "好", confirmButton: "确认", settingsDescription: "让我们计算您的需求，或设置您自己的手动目标。", gender: "性别", male: "男性", female: "女性", age: "年龄", height: "身高（厘米）", weight: "体重（公斤）", activityLevel: "活动水平",
        activityLevel1: "久坐 (主要坐着，很少或没有运动)",
        activityLevel2: "轻度活跃 (每周进行1-2次散步等轻度运动)",
        activityLevel3: "中度活跃 (每周进行3-5次定期运动)",
        activityLevel4: "非常活跃 (每周进行6-7次剧烈运动)",
        activityLevel5: "极度活跃 (每天进行剧烈运动或从事体力劳动)",
        calculateAndSave: "计算并保存", or: "要么", setManualGoal: "设置手动卡路里目标", saveManualGoal: "保存手动目标",
        analysing: "分析中...", noFavourites: "还没有喜欢的食物。点击星星添加。",
        didYouMean: '您是指“{foodName}”吗？', listening: '正在听...', checkingSpeech: '正在检查您的语音...', speechError: '无法识别语音: {error}',
        deletingData: '正在删除所有数据...', signingIn: '登录中...', loadingData: '正在加载您的数据...', barcodeLookup: '找到条形码: {barcode}。查询中...',
        nextMeal: "下一餐",
        goalSetMessage: "您的每日目标已设定为 {calories} 大卡。",
        adviceLowProtein: "对于{nextMeal}，多吃一些富含蛋白质的食物，如烤鸡、鱼或豆腐，以改善您的平衡。",
        adviceHighFat: "对于{nextMeal}，尝试低脂的选择。蒸蔬菜和瘦肉蛋白是一个很好的选择。",
        adviceBalanced: "你做得很好！对于{nextMeal}，一顿均衡的膳食，包括全谷物、瘦肉蛋白和五颜六色的蔬菜，将是保持健康的完美选择。",
        adviceStart: "让我们开始吧！下一餐，试着摄入蛋白质、健康脂肪和复合碳水化合物的混合物。",
        rateLimitError: "请求繁忙。请稍后再试。",
        removeFavouriteConfirm: "您确定要删除这个收藏吗？",
        viewDashboard: "查看仪表板",
        hideDashboard: "隐藏仪表板",
        confirmFoodTitle: "确认食物和数量",
        quantityLabel: "输入数量（例如：1个，100克）",
        sun: "日", mon: "一", tue: "二", wed: "三", thu: "四", fri: "五", sat: "六",
        week: "周", periodGoal: "期间目标", actualIntake: "实际摄入"
      }
    };

    // --- DOM Elements ---
    const mainContent = document.getElementById('main-content');
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const authForm = document.getElementById('auth-form');
    const authToggleLink = document.getElementById('auth-toggle-link');
    const authTitle = document.getElementById('auth-title');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authError = document.getElementById('auth-error');
    const foodInput = document.getElementById('food-input');
    const accountMenuBtn = document.getElementById('account-menu-btn');
    const accountDropdown = document.getElementById('account-dropdown');
    const userEmailDropdown = document.getElementById('user-email-dropdown');
    const signOutBtnDropdown = document.getElementById('sign-out-btn-dropdown');
    const analyseBtn = document.getElementById('analyse-btn');
    const dashboard = document.getElementById('dashboard');
    const mealList = document.getElementById('meal-list');
    const resetAllBtn = document.getElementById('reset-all-btn');
    const guestModeBtn = document.getElementById('guest-mode-btn');
    const userHeader = document.getElementById('user-header');
    const guestHeader = document.getElementById('guest-header');
    const goToLoginBtn = document.getElementById('go-to-login-btn');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const toggleDashboardBtn = document.getElementById('toggle-dashboard-btn');
    const voiceInputBtn = document.getElementById('voice-input-btn');
    const cameraScanBtn = document.getElementById('camera-scan-btn');
    const cameraChoiceModal = document.getElementById('camera-choice-modal');
    const scanMealBtn = document.getElementById('scan-meal-btn');
    const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
    const closeChoiceBtn = document.getElementById('close-choice-btn');
    const toggleDetailsBtn = document.getElementById('toggle-details-btn');
    const detailedDashboardView = document.getElementById('detailed-dashboard-view');
    const cameraModal = document.getElementById('camera-modal');
    const cameraView = document.getElementById('camera-view');
    const cameraCanvas = document.getElementById('camera-canvas');
    const captureBtn = document.getElementById('capture-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const diagnosisForm = document.getElementById('diagnosis-form');
    const manualGoalForm = document.getElementById('manual-goal-form');
    const barcodeModal = document.getElementById('barcode-modal');
    const barcodeVideo = document.getElementById('barcode-video');
    const closeBarcodeBtn = document.getElementById('close-barcode-btn');
    const barcodeResultEl = document.getElementById('barcode-result');
    const servingModal = document.getElementById('serving-modal');
    const servingForm = document.getElementById('serving-form');
    const cancelServingBtn = document.getElementById('cancel-serving-btn');
    const servingProductName = document.getElementById('serving-product-name');
    const favouritesBtn = document.getElementById('favourites-btn');
    const favouritesModal = document.getElementById('favourites-modal');
    const closeFavouritesBtn = document.getElementById('close-favourites-btn');
    const favouritesList = document.getElementById('favourites-list');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const zoomControls = document.getElementById('zoom-controls');
    const zoomSlider = document.getElementById('zoom-slider');
    const mainAppContent = document.getElementById('main-app-content');
    const splashScreen = document.getElementById('splash-screen');
    const appHeader = document.getElementById('app-header');
    const listeningModal = document.getElementById('listening-modal');
    const listeningTextStatus = document.getElementById('listening-text-status');
    const prevPeriodBtn = document.getElementById('prev-period-btn');
    const nextPeriodBtn = document.getElementById('next-period-btn');
    const periodTitleContainer = document.getElementById('period-title-container');
    const periodTitle = document.getElementById('period-title');
    const dynamicChartTitle = document.getElementById('dynamic-chart-title');
    const calorieGaugeChartEl = document.getElementById('calorie-gauge-chart');
    const periodBarChartEl = document.getElementById('period-bar-chart');
    const smallGaugesContainer = document.getElementById('small-gauges-container');
    const chartsGrid = document.getElementById('charts-grid');
    const mainChartWrapper = document.getElementById('main-chart-wrapper');
    const nutritionBalanceWrapper = document.getElementById('nutrition-balance-wrapper');
    const nutritionChartEl = document.getElementById('nutrition-chart');
    const nutritionBalanceTextEl = document.getElementById('nutrition-balance-text');
    const barChartContainer = document.getElementById('bar-chart-container');
    const periodGoalText = document.getElementById('period-goal-text');
    const periodActualText = document.getElementById('period-actual-text');
    const calendarModal = document.getElementById('calendar-modal');
    const calendarMonthYear = document.getElementById('calendar-month-year');
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarWeekdays = document.getElementById('calendar-weekdays');
    const calendarPrevMonth = document.getElementById('calendar-prev-month');
    const calendarNextMonth = document.getElementById('calendar-next-month');
    const closeCalendarBtn = document.getElementById('close-calendar-btn');
    const calendarMonthGrid = document.getElementById('calendar-month-grid');
    const quantityModal = document.getElementById('quantity-modal');
    const quantityForm = document.getElementById('quantity-form');
    const identifiedFoodNameEl = document.getElementById('identified-food-name');
    const quantityInput = document.getElementById('quantity-input');
    const cancelQuantityBtn = document.getElementById('cancel-quantity-btn');

    let allMeals = [], favouriteMeals = [], userGoals = { calories: 2000, protein: 100, fat: 67, carbs: 250 }, nutritionChart = null, calorieGaugeChart = null, proteinGaugeChart = null, fatGaugeChart = null, carbsGaugeChart = null, periodChart = null, activePeriod = 'day', currentDate = new Date(), calendarDisplayDate = new Date(), calendarMode = 'day', isLoginMode = true, cameraStream = null, barcodeReader = null, currentScannedProduct = null, isDetailedView = false, identifiedFoodName = '';
    if (typeof ZXing !== 'undefined') barcodeReader = new ZXing.BrowserMultiFormatReader();

    // --- ALL FUNCTIONS (Keep all existing function definitions here) ---
    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      document.documentElement.lang = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
      const translation = translations[lang];
      document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translation[key]) element.textContent = translation[key];
      });
      document.querySelectorAll('[data-lang-key-placeholder]').forEach(element => {
        const key = element.getAttribute('data-lang-key-placeholder');
        if (translation[key]) element.placeholder = translation[key];
      });
      document.querySelectorAll('[data-lang-key-title]').forEach(element => {
        const key = element.getAttribute('data-lang-key-title');
        if (translation[key]) element.title = translation[key];
      });
      if (isLoginMode) {
        authToggleLink.textContent = lang === 'zh' ? '需要一个账户？ 注册' : 'Need an account? Sign Up';
        authTitle.textContent = lang === 'zh' ? '登录' : 'Login';
        authSubmitBtn.textContent = lang === 'zh' ? '登录' : 'Login';
      } else {
        authToggleLink.textContent = lang === 'zh' ? '已经有账户了？ 登录' : 'Have an account? Login';
        authTitle.textContent = lang === 'zh' ? '注册' : 'Sign Up';
        authSubmitBtn.textContent = lang === 'zh' ? '注册' : 'Sign Up';
      }
      if (!appContainer.classList.contains('hidden')) updateDashboard(activePeriod);
      syncToggleDashboardButton();
    }
    function setDefaultMealType() {
      const hour = new Date().getHours();
      let defaultMealType = (hour >= 5 && hour < 11) ? 'Breakfast' : (hour >= 11 && hour < 17) ? 'Lunch' : 'Dinner';
      if (hour < 5 || hour >= 21) defaultMealType = 'Snack';
      document.querySelectorAll('.meal-type-btn').forEach(btn => btn.classList.remove('active'));
      const activeButton = document.querySelector(`.meal-type-btn[data-type="${defaultMealType}"]`);
      if (activeButton) activeButton.classList.add('active');
    }
    function showLoader(messageKey) {
      const currentLang = localStorage.getItem('language') || 'en';
      loadingText.textContent = translations[currentLang][messageKey] || translations[currentLang].analysing;
      loadingOverlay.classList.remove('hidden');
    }
    function hideLoader() { loadingOverlay.classList.add('hidden'); }
    function showAlert(message) {
      return new Promise(resolve => {
        const alertModal = document.getElementById('alert-modal');
        document.getElementById('alert-message').textContent = message;
        document.getElementById('alert-ok-btn').style.display = 'inline-block';
        document.getElementById('alert-confirm-btn').style.display = 'none';
        document.getElementById('alert-cancel-btn').style.display = 'none';
        alertModal.classList.remove('hidden');
        document.getElementById('alert-ok-btn').onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
      });
    }
    function showConfirm(message) {
      return new Promise(resolve => {
        const alertModal = document.getElementById('alert-modal');
        document.getElementById('alert-message').textContent = message;
        document.getElementById('alert-ok-btn').style.display = 'none';
        document.getElementById('alert-confirm-btn').style.display = 'inline-block';
        document.getElementById('alert-cancel-btn').style.display = 'inline-block';
        alertModal.classList.remove('hidden');
        document.getElementById('alert-confirm-btn').onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
        document.getElementById('alert-cancel-btn').onclick = () => {
          alertModal.classList.add('hidden');
          resolve(false);
        };
      });
    }
    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); }
      catch (error) { authError.textContent = error.message; }
    }
    function showAppContainer(isLoggedIn) {
      authContainer.classList.add('hidden');
      appContainer.classList.remove('hidden');
      userHeader.style.display = isLoggedIn ? 'flex' : 'none';
      guestHeader.style.display = isLoggedIn ? 'none' : 'flex';
    }
    function showAuthContainer() {
      appContainer.classList.add('hidden');
      authContainer.classList.remove('hidden');
    }
    function setAndSaveGoals(calorieGoal) {
      userGoals = {
        calories: calorieGoal,
        protein: Math.round((calorieGoal * 0.20) / 4),
        fat: Math.round((calorieGoal * 0.30) / 9),
        carbs: Math.round((calorieGoal * 0.50) / 4)
      };
      saveUserGoals();
      updateDashboard(activePeriod);
    }
    async function saveUserGoals() {
      if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).set({ goals: userGoals }, { merge: true });
      else localStorage.setItem('guestGoals', JSON.stringify(userGoals));
    }
    async function loadUserGoals() {
      let loadedGoals = null;
      if (auth.currentUser) {
        const doc = await db.collection('users').doc(auth.currentUser.uid).get();
        if (doc.exists && doc.data().goals) loadedGoals = doc.data().goals;
      } else {
        const storedGoals = localStorage.getItem('guestGoals');
        if (storedGoals) loadedGoals = JSON.parse(storedGoals);
      }
      if (loadedGoals) userGoals = loadedGoals;
      else settingsModal.classList.remove('hidden');
    }
    async function saveMeal(newMeal) {
      if (auth.currentUser) {
        const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('meals').add(newMeal);
        allMeals.push({ id: docRef.id, ...newMeal });
      } else {
        const mealWithId = { ...newMeal, id: Date.now().toString() };
        allMeals.push(mealWithId);
        saveMealsToStorage();
      }
    }
    async function deleteMeal(mealId) {
      if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('meals').doc(mealId).delete();
      allMeals = allMeals.filter(m => m.id.toString() !== mealId.toString());
      if (!auth.currentUser) saveMealsToStorage();
      updateDashboard(activePeriod);
    }
    async function loadMealsFromFirestore() {
      if (!auth.currentUser) return;
      const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('meals').orderBy("timestamp", "desc").get();
      allMeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (allMeals.length > 0) dashboard.classList.remove('hidden');
      syncToggleDashboardButton();
      updateDashboard(activePeriod);
    }
    function loadMealsFromStorage() {
      const storedMeals = localStorage.getItem('guestMeals');
      allMeals = storedMeals ? JSON.parse(storedMeals) : [];
      if (allMeals.length > 0) dashboard.classList.remove('hidden');
      syncToggleDashboardButton();
      updateDashboard(activePeriod);
    }
    function saveMealsToStorage() { localStorage.setItem('guestMeals', JSON.stringify(allMeals)); }
    function syncToggleDashboardButton() {
      const isHidden = dashboard.classList.contains('hidden');
      const currentLang = localStorage.getItem('language') || 'en';
      const buttonTextSpan = toggleDashboardBtn.querySelector('span');
      buttonTextSpan.textContent = isHidden ? translations[currentLang].viewDashboard : translations[currentLang].hideDashboard;
      buttonTextSpan.setAttribute('data-lang-key', isHidden ? 'viewDashboard' : 'hideDashboard');
    }
    async function processNewMeal(mealData = null) {
      let nutritionData;
      const query = foodInput.value.trim();
      if (!mealData && !query) { await showAlert("Please enter a meal to analyse."); return; }
      showLoader('analysing');
      try {
        nutritionData = mealData ? mealData : await getNutritionalInfo(query);
        if (!nutritionData) throw new Error("Could not retrieve nutritional data.");
        const mealType = document.querySelector('.meal-type-btn.active')?.dataset.type || 'Snack';
        const newMeal = { ...nutritionData, mealType, timestamp: new Date().toISOString() };
        await saveMeal(newMeal);
        foodInput.value = '';
        currentDate = new Date();
        activePeriod = 'day';
        if (dashboard.classList.contains('hidden')) {
          dashboard.classList.remove('hidden');
          syncToggleDashboardButton();
        }
      } catch (error) {
        if (error.message === "RATE_LIMIT_EXCEEDED") showAlert(translations[localStorage.getItem('language') || 'en'].rateLimitError);
        else { console.error('Error processing new meal:', error); await showAlert('Could not analyse meal. Please try again.'); }
      } finally {
        updateDashboard(activePeriod);
        hideLoader();
        if (!dashboard.classList.contains('hidden')) setTimeout(() => dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }
    }
    async function openCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { await showAlert("Your browser does not support the camera feature."); return; }
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        cameraView.srcObject = cameraStream;
        cameraModal.classList.remove('hidden');
      } catch (err) { console.error("Camera Error:", err); await showAlert("Could not access the camera. Please ensure you have given permission."); }
    }
    function closeCamera() {
      if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
      cameraModal.classList.add('hidden');
    }
    async function captureImage() {
      const context = cameraCanvas.getContext('2d');
      cameraCanvas.width = cameraView.videoWidth;
      cameraCanvas.height = cameraView.videoHeight;
      context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
      const imageDataUrl = cameraCanvas.toDataURL('image/jpeg');
      closeCamera();
      showLoader('analysing');
      try {
        identifiedFoodName = await identifyFoodFromImage(imageDataUrl.split(',')[1]);
        hideLoader();
        if (identifiedFoodName) {
          identifiedFoodNameEl.textContent = identifiedFoodName;
          quantityInput.value = '';
          quantityModal.classList.remove('hidden');
          quantityInput.focus();
        } else throw new Error("Could not identify the food.");
      } catch (error) {
        hideLoader();
        if (error.message === "RATE_LIMIT_EXCEEDED") showAlert(translations[localStorage.getItem('language') || 'en'].rateLimitError);
        else { console.error("Image identification error:", error); await showAlert("Sorry, we couldn't identify the food in the image. Please try typing it manually."); }
      }
    }
    async function identifyFoodFromImage(base64ImageData) {
      const prompt = "What food is in this image? Describe it in a short phrase. If it's not food, say 'not food'.";
      const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64ImageData } }] }] };
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
      try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (response.status === 429) throw new Error("RATE_LIMIT_EXCEEDED");
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        const result = await response.json();
        const text = result.candidates[0].content.parts[0].text;
        return text.toLowerCase().includes('not food') ? null : text;
      } catch (error) { console.error("Error fetching from Gemini Vision API:", error); if (error.message === "RATE_LIMIT_EXCEEDED") throw error; return null; }
    }
    async function getNutritionalInfo(prompt) {
      const chatHistory = [{ role: "user", parts: [{ text: `Provide the estimated nutritional information for "${prompt}" in a valid JSON format. The JSON object should only contain these keys: "food" (string), "calories" (number), "protein" (number, in grams), "fat" (number, in grams), and "carbs" (number, in grams).` }] }];
      const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "food": { "type": "STRING" }, "calories": { "type": "NUMBER" }, "protein": { "type": "NUMBER" }, "fat": { "type": "NUMBER" }, "carbs": { "type": "NUMBER" } }, required: ["food", "calories", "protein", "fat", "carbs"] } } };
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
      try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (response.status === 429) throw new Error("RATE_LIMIT_EXCEEDED");
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        const result = await response.json();
        const text = result.candidates[0].content.parts[0].text;
        return JSON.parse(text);
      } catch (error) { console.error("Error fetching from Gemini API:", error); if (error.message === "RATE_LIMIT_EXCEEDED") throw error; return null; }
    }
    function setupDashboardListeners() {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => { activePeriod = btn.dataset.period; currentDate = new Date(); updateDashboard(activePeriod); }));
      resetAllBtn.addEventListener('click', resetAllData);
      toggleDetailsBtn.addEventListener('click', () => { isDetailedView = !isDetailedView; updateDashboard(activePeriod); });
      prevPeriodBtn.addEventListener('click', () => navigatePeriod(-1));
      nextPeriodBtn.addEventListener('click', () => navigatePeriod(1));
      periodTitleContainer.addEventListener('click', () => {
        calendarDisplayDate = new Date(currentDate);
        calendarMode = (activePeriod === 'day' || activePeriod === 'week') ? 'day' : 'month';
        renderCalendar(calendarDisplayDate);
        calendarModal.classList.remove('hidden');
      });
    }
    function navigatePeriod(direction) {
      const newDate = new Date(currentDate);
      if (activePeriod === 'day') newDate.setDate(newDate.getDate() + direction);
      else if (activePeriod === 'week') newDate.setDate(newDate.getDate() + (7 * direction));
      else if (activePeriod === 'month') newDate.setMonth(newDate.getMonth() + direction);
      currentDate = newDate;
      updateDashboard(activePeriod);
    }
    function updateDashboard(period) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
      updatePeriodTitleAndNav();
      const periodMeals = filterMealsByPeriod(period);
      const totals = calculateTotals(periodMeals);
      updateTotalsCard(totals);
      renderMealList(periodMeals);
      provideNutritionalAdvice(periodMeals);
      const currentLang = localStorage.getItem('language') || 'en';
      if (isDetailedView) {
        detailedDashboardView.classList.remove('hidden');
        toggleDetailsBtn.textContent = translations[currentLang].closeDetails;
        toggleDetailsBtn.setAttribute('data-lang-key', 'closeDetails');
        renderCharts(periodMeals, period, totals);
      } else {
        detailedDashboardView.classList.add('hidden');
        toggleDetailsBtn.textContent = translations[currentLang].showDetails;
        toggleDetailsBtn.setAttribute('data-lang-key', 'showDetails');
      }
    }
    function renderMealList(meals) {
      mealList.innerHTML = '';
      const currentLang = localStorage.getItem('language') || 'en';
      if (meals.length === 0) { mealList.innerHTML = `<p id="no-meals-message" class="text-gray-500" data-lang-key="noMeals">${translations[currentLang].noMeals}</p>`; return; }
      meals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      meals.forEach(data => {
        const mealElement = document.createElement('div');
        const mealTypeColor = { Breakfast: 'bg-blue-100 text-blue-800', Lunch: 'bg-green-100 text-green-800', Dinner: 'bg-purple-100 text-purple-800', Snack: 'bg-yellow-100 text-yellow-800' };
        const isFavourited = favouriteMeals.some(fav => fav.food.toLowerCase() === data.food.toLowerCase());
        mealElement.className = 'bg-white p-4 border border-gray-200 rounded-lg';
        mealElement.innerHTML = `<div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-gray-800 capitalize">${data.food}</h3><div class="flex items-center gap-2"><div class="favourite-star-container"><span class="favourite-star ${isFavourited ? 'favourited' : 'text-gray-400 hover:text-yellow-400'}" title="Add to favourites"><svg class="w-5 h-5" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg></span></div><button data-id="${data.id}" class="delete-meal-btn text-lg font-bold text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-100" title="Delete">&times;</button></div></div><div class="flex justify-between items-center mt-1"><p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleString('en-US')}</p><span class="text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap ${mealTypeColor[data.mealType] || mealTypeColor.Snack}">${translations[currentLang][data.mealType.toLowerCase()] || data.mealType}</span></div><div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm"><div><strong data-lang-key="calories">${translations[currentLang].calories}:</strong> ${Math.round(data.calories)}</div><div><strong data-lang-key="protein">${translations[currentLang].protein}:</strong> ${data.protein.toFixed(1)}g</div><div><strong data-lang-key="fat">${translations[currentLang].fat}:</strong> ${data.fat.toFixed(1)}g</div><div><strong data-lang-key="carbs">${translations[currentLang].carbs}:</strong> ${data.carbs.toFixed(1)}g</div></div>`;
        mealList.appendChild(mealElement);
        mealElement.querySelector('.favourite-star').addEventListener('click', (e) => toggleFavourite(data, e.currentTarget));
      });
      document.querySelectorAll('.delete-meal-btn').forEach(btn => btn.addEventListener('click', async (e) => { if (await showConfirm('Are you sure you want to delete this meal record?')) await deleteMeal(e.currentTarget.dataset.id); }));
    }
    async function resetAllData() {
      if (!await showConfirm('Are you sure you want to delete all your data? This action cannot be undone.')) return;
      showLoader('deletingData');
      if (auth.currentUser) {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('meals').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      } else localStorage.removeItem('guestMeals');
      allMeals = [];
      dashboard.classList.add('hidden');
      updateDashboard(activePeriod);
      hideLoader();
    }
    function provideNutritionalAdvice(periodMeals) {
      const adviceCard = document.getElementById('advice-card'), adviceIcon = document.getElementById('advice-icon'), adviceText = document.getElementById('advice-text'), currentLang = localStorage.getItem('language') || 'en';
      if (periodMeals.length === 0) { adviceCard.classList.add('hidden'); return; }
      const lastMeal = periodMeals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0], totals = calculateTotals(periodMeals), proteinCalories = totals.protein * 4, fatCalories = totals.fat * 9, totalCalories = proteinCalories + fatCalories + (totals.carbs * 4);
      let suggestionKey = '', isBalanced = true, mealOrder = ['Breakfast', 'Lunch', 'Dinner'], lastMealIndex = mealOrder.indexOf(lastMeal.mealType), nextMealTypeKey = lastMealIndex !== -1 && lastMealIndex < 2 ? mealOrder[lastMealIndex + 1].toLowerCase() : 'nextMeal', nextMealTranslated = translations[currentLang][nextMealTypeKey];
      if (totalCalories > 0) {
        const proteinPercentage = (proteinCalories / totalCalories) * 100, fatPercentage = (fatCalories / totalCalories) * 100;
        if (proteinPercentage < 15) { suggestionKey = 'adviceLowProtein'; isBalanced = false; }
        else if (fatPercentage > 35) { suggestionKey = 'adviceHighFat'; isBalanced = false; }
        else suggestionKey = 'adviceBalanced';
      } else suggestionKey = 'adviceStart';
      adviceText.textContent = translations[currentLang][suggestionKey].replace('{nextMeal}', nextMealTranslated);
      adviceCard.classList.remove('hidden');
      if (isBalanced) { adviceCard.className = 'p-6 rounded-xl shadow-sm bg-green-50 border-l-4 border-green-400'; adviceIcon.textContent = '✅'; }
      else { adviceCard.className = 'p-6 rounded-xl shadow-sm bg-yellow-50 border-l-4 border-yellow-400'; adviceIcon.textContent = '💡'; }
    }
    function updateTotalsCard(totals) {
      document.getElementById('total-calories').textContent = Math.round(totals.calories);
      document.getElementById('total-protein').textContent = `${totals.protein.toFixed(1)} g`;
      document.getElementById('total-fat').textContent = `${totals.fat.toFixed(1)} g`;
      document.getElementById('total-carbs').textContent = `${totals.carbs.toFixed(1)} g`;
    }
    function updatePeriodTitleAndNav() {
      const lang = localStorage.getItem('language') || 'en', today = new Date();
      today.setHours(0, 0, 0, 0);
      let title = '', isFuture = false;
      if (activePeriod === 'day') {
        title = (currentDate.toDateString() === today.toDateString()) ? translations[lang].today : currentDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        isFuture = currentDate > today;
      } else if (activePeriod === 'week') {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - startOfWeek.getDay());
        startOfWeek.setHours(0, 0, 0, 0);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);
        const options = { month: 'short', day: 'numeric' };
        const startStr = startOfWeek.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { ...options, year: (startOfWeek.getFullYear() !== endOfWeek.getFullYear() ? 'numeric' : undefined) });
        const endStr = endOfWeek.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { ...options, year: 'numeric' });
        title = `${startStr} - ${endStr}`;
        isFuture = startOfWeek > today;
      } else if (activePeriod === 'month') {
        title = currentDate.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'long' });
        const firstDayOfNextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        isFuture = firstDayOfNextMonth > today;
      }
      periodTitle.textContent = title;
      nextPeriodBtn.disabled = isFuture;
    }
    function renderCharts(periodMeals, period, totals) {
      if (periodChart) periodChart.destroy();
      if (calorieGaugeChart) calorieGaugeChart.destroy();
      if (nutritionChart) nutritionChart.destroy();
      const currentLang = localStorage.getItem('language') || 'en';
      if (period === 'day') {
        chartsGrid.classList.remove('grid-cols-1');
        chartsGrid.classList.add('md:grid-cols-2');
        mainChartWrapper.classList.remove('md:col-span-2');
        nutritionBalanceWrapper.classList.remove('hidden');
        calorieGaugeChartEl.classList.remove('hidden');
        barChartContainer.classList.add('hidden');
        nutritionChartEl.classList.remove('hidden');
        nutritionBalanceTextEl.classList.add('hidden');
        smallGaugesContainer.classList.remove('hidden');
        periodGoalText.classList.add('hidden');
        periodActualText.classList.add('hidden');
        dynamicChartTitle.textContent = translations[currentLang].todaysCalories;
        renderAllGauges(totals, period);
        renderNutritionChart(totals);
      } else {
        chartsGrid.classList.add('grid-cols-1');
        chartsGrid.classList.remove('md:grid-cols-2');
        mainChartWrapper.classList.add('md:col-span-2');
        calorieGaugeChartEl.classList.add('hidden');
        barChartContainer.classList.remove('hidden');
        nutritionChartEl.classList.add('hidden');
        nutritionBalanceTextEl.classList.remove('hidden');
        smallGaugesContainer.classList.add('hidden');
        nutritionBalanceWrapper.classList.remove('hidden');
        periodGoalText.classList.remove('hidden');
        periodActualText.classList.remove('hidden');
        renderBarChart(period, periodMeals);
        renderNutritionBalanceText(totals, period);
      }
    }
    function renderBarChart(period, periodMeals) {
      if (periodChart) periodChart.destroy();
      const currentLang = localStorage.getItem('language') || 'en';
      let chartData, chartLabels, periodMultiplier, goalPerUnit;
      if (period === 'week') {
        dynamicChartTitle.textContent = translations[currentLang].thisWeeksTotals;
        chartLabels = [translations[currentLang].sun, translations[currentLang].mon, translations[currentLang].tue, translations[currentLang].wed, translations[currentLang].thu, translations[currentLang].fri, translations[currentLang].sat];
        const dailyTotals = Array(7).fill(0);
        periodMeals.forEach(meal => { dailyTotals[new Date(meal.timestamp).getDay()] += meal.calories; });
        chartData = dailyTotals;
        periodMultiplier = 7;
        goalPerUnit = userGoals.calories;
      } else {
        dynamicChartTitle.textContent = translations[currentLang].thisMonthsTotals;
        const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const numWeeks = Math.ceil((startOfMonth.getDay() + endOfMonth.getDate()) / 7);
        chartLabels = Array.from({ length: numWeeks }, (_, i) => `${translations[currentLang].week} ${i + 1}`);
        const weeklyTotals = Array(numWeeks).fill(0);
        periodMeals.forEach(meal => { const weekIndex = Math.floor((startOfMonth.getDay() + new Date(meal.timestamp).getDate() - 1) / 7); weeklyTotals[weekIndex] += meal.calories; });
        chartData = weeklyTotals;
        periodMultiplier = endOfMonth.getDate();
        goalPerUnit = userGoals.calories * 7;
      }
      const periodGoal = userGoals.calories * periodMultiplier, totalPeriodCalories = periodMeals.reduce((sum, meal) => sum + meal.calories, 0);
      periodGoalText.textContent = `${translations[currentLang].periodGoal}: ${Math.round(periodGoal)} kcal`;
      periodActualText.textContent = `${translations[currentLang].actualIntake}: ${Math.round(totalPeriodCalories)} kcal`;
      periodActualText.classList.remove('text-green-600', 'text-red-600');
      periodActualText.classList.add(totalPeriodCalories <= periodGoal ? 'text-green-600' : 'text-red-600');
      const withinGoalData = chartData.map(total => Math.min(total, goalPerUnit));
      const overGoalData = chartData.map(total => Math.max(0, total - goalPerUnit));
      periodChart = new Chart(periodBarChartEl.getContext('2d'), {
        type: 'bar',
        data: { labels: chartLabels, datasets: [{ label: 'Within Goal', data: withinGoalData, backgroundColor: '#3b82f6', borderRadius: 2 }, { label: 'Over Goal', data: overGoalData, backgroundColor: '#ef4444', borderRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
      });
    }
    function renderNutritionBalanceText(totals, period) {
      const lang = localStorage.getItem('language') || 'en';
      let periodMultiplier = (period === 'week') ? 7 : (period === 'month') ? new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() : 1;
      const proteinGoal = Math.round(userGoals.protein * periodMultiplier), fatGoal = Math.round(userGoals.fat * periodMultiplier), carbsGoal = Math.round(userGoals.carbs * periodMultiplier);
      nutritionBalanceTextEl.innerHTML = `<div class="mt-4 space-y-3 text-gray-700 text-base"><div class="flex justify-between items-center bg-green-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="protein">${translations[lang].protein}</span><span class="font-mono">${totals.protein.toFixed(0)}g / ${proteinGoal}g</span></div><div class="flex justify-between items-center bg-orange-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="fat">${translations[lang].fat}</span><span class="font-mono">${totals.fat.toFixed(0)}g / ${fatGoal}g</span></div><div class="flex justify-between items-center bg-red-50 p-3 rounded-lg"><span class="font-semibold" data-lang-key="carbs">${translations[lang].carbs}</span><span class="font-mono">${totals.carbs.toFixed(0)}g / ${carbsGoal}g</span></div></div>`;
    }
    function renderNutritionChart(totals) {
      const ctx = document.getElementById('nutrition-chart').getContext('2d'), { protein, fat, carbs } = totals, totalPFC = protein + fat + carbs, currentLang = localStorage.getItem('language') || 'en';
      if (nutritionChart) nutritionChart.destroy();
      if (totalPFC === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
      nutritionChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [`${translations[currentLang].protein} (${((protein / totalPFC) * 100 || 0).toFixed(0)}%)`, `${translations[currentLang].fat} (${((fat / totalPFC) * 100 || 0).toFixed(0)}%)`, `${translations[currentLang].carbs} (${((carbs / totalPFC) * 100 || 0).toFixed(0)}%)`], datasets: [{ data: [protein, fat, carbs], backgroundColor: ['#22c55e', '#f97316', '#ef4444'], borderColor: '#fff' }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } }, tooltip: { callbacks: { label: (c) => `${c.label.split('(')[0].trim()}: ${c.parsed.toFixed(1)}g` } } } }
      });
    }
    function renderAllGauges(totals, period) {
      if (period !== 'day') return;
      renderGaugeChart('calorie-gauge-chart', calorieGaugeChart, totals.calories, userGoals.calories, 'kcal', (chartInstance) => { calorieGaugeChart = chartInstance; });
      renderGaugeChart('protein-gauge-chart', proteinGaugeChart, totals.protein, userGoals.protein, 'g', (chartInstance) => { proteinGaugeChart = chartInstance; }, '#22c55e');
      renderGaugeChart('fat-gauge-chart', fatGaugeChart, totals.fat, userGoals.fat, 'g', (chartInstance) => { fatGaugeChart = chartInstance; }, '#f97316');
      renderGaugeChart('carbs-gauge-chart', carbsGaugeChart, totals.carbs, userGoals.carbs, 'g', (chartInstance) => { carbsGaugeChart = chartInstance; }, '#ef4444');
    }
    function renderGaugeChart(canvasId, chartInstance, currentValue, goalValue, unit, setChartInstance, color = '#8b5cf6') {
      const canvasEl = document.getElementById(canvasId);
      if (!canvasEl) return;
      const ctx = canvasEl.getContext('2d'), current = Math.round(currentValue), goal = Math.round(goalValue), remaining = Math.max(0, goal - current), percentage = Math.round((current / goal) * 100 || 0);
      if (chartInstance) chartInstance.destroy();
      const newChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { datasets: [{ data: [current, remaining], backgroundColor: [current > goal ? '#dc2626' : color, '#e2e8f0'], borderColor: '#fff', borderWidth: 2, circumference: 180, rotation: 270, }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }, tooltip: { enabled: false } }, cutout: '70%', },
        plugins: [{
          id: 'gaugeText',
          afterDraw: (chart) => {
            const { ctx, chartArea: { top, width, height } } = chart;
            ctx.save();
            const x = width / 2, y = top + (height / 1.2), isMobile = window.innerWidth < 640, isCalorieGauge = canvasId === 'calorie-gauge-chart';
            let percentageFontSize = isCalorieGauge ? (isMobile ? (percentage >= 100 ? '1.5rem' : '1.75rem') : (percentage >= 100 ? '2.25rem' : '3rem')) : (percentage >= 100 ? '1.25rem' : '1.5rem');
            const detailsFontSize = isCalorieGauge ? (isMobile ? '0.875rem' : '1rem') : '0.75rem', ySpacing = isCalorieGauge ? (isMobile ? 3 : 5) : 2;
            ctx.font = `bold ${percentageFontSize} Inter`;
            ctx.fillStyle = current > goal ? '#dc2626' : '#1e293b';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(`${percentage}%`, x, y - ySpacing);
            ctx.font = `${detailsFontSize} Inter`;
            ctx.fillStyle = '#64748b';
            ctx.textBaseline = 'top';
            ctx.fillText(`${current} / ${goal} ${unit}`, x, y + ySpacing);
            ctx.restore();
          }
        }]
      });
      setChartInstance(newChartInstance);
    }
    function calculateTotals(meals) {
      return meals.reduce((acc, meal) => ({
        calories: acc.calories + (meal.calories || 0), protein: acc.protein + (meal.protein || 0),
        fat: acc.fat + (meal.fat || 0), carbs: acc.carbs + (meal.carbs || 0)
      }), { calories: 0, protein: 0, fat: 0, carbs: 0 });
    }
    function filterMealsByPeriod(period) {
      const start = new Date(currentDate), end = new Date(currentDate);
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      if (period === 'week') {
        const dayOfWeek = start.getDay();
        start.setDate(start.getDate() - dayOfWeek);
        end.setDate(start.getDate() + 6);
      } else if (period === 'month') {
        start.setDate(1);
        end.setMonth(end.getMonth() + 1);
        end.setDate(0);
      }
      return allMeals.filter(meal => { const mealDate = new Date(meal.timestamp); return mealDate >= start && mealDate <= end; });
    }
    function renderCalendar(date) {
      const lang = localStorage.getItem('language') || 'en', today = new Date();
      today.setHours(0, 0, 0, 0);
      const year = date.getFullYear();
      calendarGrid.innerHTML = '';
      calendarWeekdays.innerHTML = '';
      calendarMonthGrid.innerHTML = '';
      if (calendarMode === 'month') {
        calendarMonthYear.textContent = year;
        calendarWeekdays.classList.add('hidden');
        calendarGrid.classList.add('hidden');
        calendarMonthGrid.classList.remove('hidden');
        const months = Array.from({ length: 12 }, (_, i) => new Date(year, i).toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { month: 'short' }));
        months.forEach((monthName, index) => {
          const monthCell = document.createElement('button');
          monthCell.textContent = monthName;
          monthCell.className = 'p-3 rounded-lg hover:bg-blue-100 transition-colors';
          if (index === currentDate.getMonth() && year === currentDate.getFullYear()) monthCell.classList.add('bg-blue-500', 'text-white');
          monthCell.addEventListener('click', () => { currentDate = new Date(year, index, 1); calendarModal.classList.add('hidden'); updateDashboard('month'); });
          calendarMonthGrid.appendChild(monthCell);
        });
      } else {
        calendarMonthYear.textContent = date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'long' });
        calendarWeekdays.classList.remove('hidden');
        calendarGrid.classList.remove('hidden');
        calendarMonthGrid.classList.add('hidden');
        const weekdays = (lang === 'zh') ? ['日', '一', '二', '三', '四', '五', '六'] : ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        weekdays.forEach(day => { const dayEl = document.createElement('div'); dayEl.textContent = day; calendarWeekdays.appendChild(dayEl); });
        const month = date.getMonth(), firstDayOfMonth = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));
        for (let i = 1; i <= daysInMonth; i++) {
          const dayCell = document.createElement('button'), cellDate = new Date(year, month, i);
          dayCell.textContent = i;
          dayCell.className = 'p-1 rounded-full w-8 h-8 flex items-center justify-center mx-auto transition-colors';
          if (activePeriod === 'week') {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            if (cellDate >= startOfWeek && cellDate <= endOfWeek) dayCell.classList.add('bg-blue-200');
          }
          if (cellDate.toDateString() === today.toDateString()) dayCell.classList.add('border-2', 'border-gray-400');
          if (cellDate.toDateString() === currentDate.toDateString()) dayCell.classList.add('bg-blue-500', 'text-white', 'font-bold');
          else dayCell.classList.add('hover:bg-blue-100');
          dayCell.addEventListener('click', () => { currentDate = new Date(year, month, i); calendarModal.classList.add('hidden'); updateDashboard(activePeriod); });
          calendarGrid.appendChild(dayCell);
        }
      }
    }
    function startBarcodeScanner() {
      if (!barcodeReader) { showAlert('Barcode reader is not ready yet.'); return; }
      barcodeModal.classList.remove('hidden');
      barcodeReader.listVideoInputDevices().then((videoInputDevices) => {
        const selectedDeviceId = videoInputDevices[0].deviceId;
        barcodeReader.decodeFromVideoDevice(selectedDeviceId, 'barcode-video', (result, err) => { if (result) { barcodeReader.reset(); barcodeModal.classList.add('hidden'); processBarcode(result.getText()); } });
      }).catch((err) => { console.error(err); showAlert('Could not start camera.'); });
    }
    async function processBarcode(barcode) {
      const currentLang = localStorage.getItem('language') || 'en';
      showLoader(translations[currentLang].barcodeLookup.replace('{barcode}', barcode));
      const productData = await fetchProductFromAPI(barcode);
      hideLoader();
      if (productData) {
        currentScannedProduct = productData;
        servingProductName.textContent = productData.food;
        servingModal.classList.remove('hidden');
      } else showAlert(`Product with barcode ${barcode} not found in the database.`);
    }
    async function fetchProductFromAPI(barcode) {
      try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
        const data = await response.json();
        if (data.status === 1 && data.product) {
          const p = data.product, nutriments = p.nutriments;
          return { food: p.product_name || 'Unknown Product', calories_100g: nutriments['energy-kcal_100g'] || 0, protein_100g: nutriments.proteins_100g || 0, fat_100g: nutriments.fat_100g || 0, carbs_100g: nutriments.carbohydrates_100g || 0, };
        }
        return null;
      } catch (error) { console.error("Error fetching product data:", error); return null; }
    }
    async function toggleFavourite(mealData, starElement) {
      if (starElement) {
        starElement.classList.add('star-pop');
        const container = starElement.parentElement;
        if (container) {
          container.classList.add('sparkling');
          container.addEventListener('animationend', () => container.classList.remove('sparkling'), { once: true });
        }
        starElement.addEventListener('animationend', () => starElement.classList.remove('star-pop'), { once: true });
      }
      const favIndex = favouriteMeals.findIndex(fav => fav.food.toLowerCase() === mealData.food.toLowerCase());
      if (favIndex > -1) {
        const favId = favouriteMeals[favIndex].id;
        favouriteMeals.splice(favIndex, 1);
        if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('favourites').doc(favId).delete();
      } else {
        const { food, calories, protein, fat, carbs } = mealData;
        const newFav = { food, calories, protein, fat, carbs };
        if (auth.currentUser) {
          const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('favourites').add(newFav);
          newFav.id = docRef.id;
        } else newFav.id = Date.now();
        favouriteMeals.push(newFav);
      }
      saveFavouritesToStorage();
      renderMealList(filterMealsByPeriod(activePeriod));
    }
    async function removeFavourite(favId) {
      const favIndex = favouriteMeals.findIndex(fav => fav.id.toString() === favId.toString());
      if (favIndex > -1) {
        favouriteMeals.splice(favIndex, 1);
        if (auth.currentUser) await db.collection('users').doc(auth.currentUser.uid).collection('favourites').doc(favId).delete();
        saveFavouritesToStorage();
        renderFavouritesList();
        renderMealList(filterMealsByPeriod(activePeriod));
      }
    }
    function renderFavouritesList() {
      favouritesList.innerHTML = '';
      const currentLang = localStorage.getItem('language') || 'en';
      if (favouriteMeals.length === 0) { favouritesList.innerHTML = `<p class="text-gray-500 text-center" data-lang-key="noFavourites">${translations[currentLang].noFavourites}</p>`; return; }
      favouriteMeals.forEach(fav => {
        const favEl = document.createElement('div');
        favEl.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md';
        favEl.innerHTML = `<span class="capitalize cursor-pointer hover:text-blue-600 flex-grow text-left">${fav.food}</span><div class="flex items-center"><span class="text-xs text-gray-500 mr-4">${Math.round(fav.calories)} kcal</span><button data-id="${fav.id}" class="delete-favourite-btn text-xl font-bold text-red-400 hover:text-red-600 leading-none p-1">&times;</button></div>`;
        favEl.querySelector('span.capitalize').addEventListener('click', () => { processNewMeal(fav); favouritesModal.classList.add('hidden'); });
        favEl.querySelector('.delete-favourite-btn').addEventListener('click', async (e) => { const favId = e.currentTarget.dataset.id; if (await showConfirm(translations[localStorage.getItem('language') || 'en'].removeFavouriteConfirm)) await removeFavourite(favId); });
        favouritesList.appendChild(favEl);
      });
    }
    async function loadFavourites() {
      if (auth.currentUser) {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('favourites').get();
        favouriteMeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } else {
        const stored = localStorage.getItem('guestFavourites');
        favouriteMeals = stored ? JSON.parse(stored) : [];
      }
    }
    function saveFavouritesToStorage() {
      if (!auth.currentUser) localStorage.setItem('guestFavourites', JSON.stringify(favouriteMeals));
    }
    function startVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { showAlert('Your browser does not support voice input.'); return; }
      const recognition = new SpeechRecognition();
      const currentLang = localStorage.getItem('language') || 'en';
      recognition.lang = currentLang === 'zh' ? 'zh-CN' : 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      listeningTextStatus.textContent = translations[currentLang].listening;
      listeningModal.classList.remove('hidden');
      recognition.start();
      recognition.onresult = async (event) => {
        listeningModal.classList.add('hidden');
        const speechResult = event.results[0][0].transcript;
        foodInput.placeholder = translations[currentLang].checkingSpeech;
        showLoader('checkingSpeech');
        try {
          const correctedFood = await getSimilarSoundingFood(speechResult);
          hideLoader();
          if (correctedFood && correctedFood.toLowerCase() !== speechResult.toLowerCase()) {
            const message = translations[currentLang].didYouMean.replace('{foodName}', correctedFood);
            if (await showConfirm(message)) foodInput.value = correctedFood;
            else foodInput.value = '';
          } else foodInput.value = speechResult;
        } catch (error) {
          console.error("Error correcting speech:", error);
          foodInput.value = speechResult;
          hideLoader();
        } finally { foodInput.placeholder = translations[currentLang].foodInputPlaceholder; }
      };
      recognition.onspeechend = () => { recognition.stop(); listeningModal.classList.add('hidden'); };
      recognition.onerror = (event) => {
        listeningModal.classList.add('hidden');
        showAlert(translations[currentLang].speechError.replace('{error}', event.error));
      };
    }
    async function getSimilarSoundingFood(prompt) {
      const chatHistory = [{ role: "user", parts: [{ text: `A user said "${prompt}" via voice input. If this is a common food item, return the food item's name. If it is not a food item, return the name of a common food item that sounds similar. Respond with only the food name in a valid JSON format. The JSON object should only contain the key "food".` }] }];
      const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "food": { type: "STRING" } }, required: ["food"] } } };
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
      try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        const result = await response.json();
        const text = result.candidates[0].content.parts[0].text;
        return JSON.parse(text).food;
      } catch (error) { console.error("Error fetching from Gemini API for correction:", error); return null; }
    }

    // --- APPLICATION INITIALIZATION ---
    function initializeAppEventListeners() {
      window.addEventListener('scroll', () => { if (appHeader) appHeader.classList.toggle('shadow-md', window.scrollY > 10); });
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        authError.textContent = '';
        showLoader('signingIn');
        try {
          if (isLoginMode) await auth.signInWithEmailAndPassword(email, password);
          else await auth.createUserWithEmailAndPassword(email, password);
        } catch (error) { authError.textContent = error.message; }
        finally { hideLoader(); }
      });
      googleSignInBtn.addEventListener('click', signInWithGoogle);
      authToggleLink.addEventListener('click', (e) => { e.preventDefault(); isLoginMode = !isLoginMode; setLanguage(localStorage.getItem('language') || 'en'); });
      forgotPasswordLink.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const currentLang = localStorage.getItem('language') || 'en';
        if (!email) { await showAlert(translations[currentLang].enterEmailForReset); return; }
        try {
          await auth.sendPasswordResetEmail(email);
          await showAlert(translations[currentLang].passwordResetSent);
        } catch (error) { authError.textContent = error.message; }
      });
      signOutBtnDropdown.addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
      accountMenuBtn.addEventListener('click', () => accountDropdown.classList.toggle('hidden'));
      window.addEventListener('click', (e) => { if (!accountMenuBtn.contains(e.target) && !accountDropdown.contains(e.target)) accountDropdown.classList.add('hidden'); });
      guestModeBtn.addEventListener('click', () => {
        loadUserGoals();
        loadFavourites();
        showAppContainer(false);
        loadMealsFromStorage();
      });
      goToLoginBtn.addEventListener('click', showAuthContainer);
      settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
      closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
      diagnosisForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const gender = document.getElementById('gender').value, age = parseInt(document.getElementById('age').value), height = parseInt(document.getElementById('height').value), weight = parseInt(document.getElementById('weight').value), activityLevel = parseFloat(document.getElementById('activity-level').value);
        const bmr = (gender === 'male') ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
        const tdee = Math.round(bmr * activityLevel);
        setAndSaveGoals(tdee);
        settingsModal.classList.add('hidden');
        showAlert(translations[localStorage.getItem('language') || 'en'].goalSetMessage.replace('{calories}', tdee));
      });
      manualGoalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const manualCalories = parseInt(document.getElementById('manual-calories').value);
        if (manualCalories > 0) {
          setAndSaveGoals(manualCalories);
          settingsModal.classList.add('hidden');
          showAlert(translations[localStorage.getItem('language') || 'en'].goalSetMessage.replace('{calories}', manualCalories));
        }
      });
      analyseBtn.addEventListener('click', () => processNewMeal());
      foodInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') processNewMeal(); });
      toggleDashboardBtn.addEventListener('click', () => {
        dashboard.classList.toggle('hidden');
        syncToggleDashboardButton();
        if (!dashboard.classList.contains('hidden')) setTimeout(() => dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      });
      document.querySelectorAll('.quick-food-btn').forEach(btn => btn.addEventListener('click', () => { foodInput.value = btn.textContent; processNewMeal(); }));
      document.querySelectorAll('.meal-type-btn').forEach(btn => btn.addEventListener('click', () => { document.querySelector('.meal-type-btn.active')?.classList.remove('active'); btn.classList.add('active'); }));
      cameraScanBtn.addEventListener('click', () => cameraChoiceModal.classList.remove('hidden'));
      voiceInputBtn.addEventListener('click', startVoiceRecognition);
      closeChoiceBtn.addEventListener('click', () => cameraChoiceModal.classList.add('hidden'));
      scanMealBtn.addEventListener('click', () => { cameraChoiceModal.classList.add('hidden'); openCamera(); });
      scanBarcodeBtn.addEventListener('click', () => { cameraChoiceModal.classList.add('hidden'); startBarcodeScanner(); });
      captureBtn.addEventListener('click', captureImage);
      closeCameraBtn.addEventListener('click', closeCamera);
      closeBarcodeBtn.addEventListener('click', () => { barcodeReader.reset(); barcodeModal.classList.add('hidden'); });
      servingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const servingSize = parseFloat(document.getElementById('serving-size').value);
        if (servingSize > 0 && currentScannedProduct) {
          const multiplier = servingSize / 100;
          processNewMeal({ food: currentScannedProduct.food, calories: currentScannedProduct.calories_100g * multiplier, protein: currentScannedProduct.protein_100g * multiplier, fat: currentScannedProduct.fat_100g * multiplier, carbs: currentScannedProduct.carbs_100g * multiplier });
          servingModal.classList.add('hidden');
          currentScannedProduct = null;
        }
      });
      cancelServingBtn.addEventListener('click', () => servingModal.classList.add('hidden'));
      quantityForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const quantity = quantityInput.value.trim();
        if (quantity && identifiedFoodName) {
          foodInput.value = `${quantity} ${identifiedFoodName}`;
          quantityModal.classList.add('hidden');
          processNewMeal();
        }
      });
      cancelQuantityBtn.addEventListener('click', () => quantityModal.classList.add('hidden'));
      favouritesBtn.addEventListener('click', () => { renderFavouritesList(); favouritesModal.classList.remove('hidden'); });
      closeFavouritesBtn.addEventListener('click', () => favouritesModal.classList.add('hidden'));
      setupDashboardListeners();
      document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => setLanguage(btn.dataset.lang)));
    }

    const splashScreenFinished = new Promise(resolve => {
      window.addEventListener('load', () => {
        setTimeout(() => { splashScreen.style.opacity = '0'; }, 2200);
        setTimeout(() => {
          splashScreen.classList.add('hidden');
          mainAppContent.style.opacity = '1';
          resolve();
        }, 2700);
      });
    });

    auth.onAuthStateChanged(async user => {
      await splashScreenFinished;
      if (user) {
        await loadUserGoals();
        await loadFavourites();
        showAppContainer(true);
        userEmailDropdown.textContent = user.email;
        showLoader('loadingData');
        await loadMealsFromFirestore();
        hideLoader();
      } else {
        showAuthContainer();
      }
    });

    window.addEventListener('load', () => {
      setDefaultMealType();
      setLanguage(localStorage.getItem('language') || 'en');
      initializeAppEventListeners();
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, (err) => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>

</html>